# Архитектура проекта Thermo Agents

## Обзор системы

Проект представляет собой многоагентную систему для анализа термодинамических данных химических соединений, построенную на базе Python и использующую архитектуру Agent-to-Agent (A2A) коммуникации.

## Архитектурные принципы

### 1. Многоагентная архитектура
- **Разделение ответственности**: Каждый агент отвечает за конкретную задачу
- **Слабая связанность**: Агенты взаимодействуют через структурированные интерфейсы
- **Асинхронная обработка**: Все операции агентов выполняются асинхронно

### 2. Dependency Injection
- Конфигурация агентов через dataclass объекты
- Возможность подмены зависимостей для тестирования
- Централизованное управление конфигурацией

### 3. Структурированный ввод/вывод
- Использование Pydantic моделей для валидации данных
- Типизированные интерфейсы между компонентами
- Автоматическая сериализация/десериализация

## Компонентная архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   CLI Interface │    │  Session Logger  │    │   Config Env    │
│    (main.py)    │    │                  │    │    (.env)       │
└─────────┬───────┘    └─────────┬────────┘    └─────────┬───────┘
          │                      │                       │
          ▼                      ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Thermo Agent                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Parameter       │  │ PydanticAI      │  │ ExtractedParams │ │
│  │ Extraction      │  │ Framework       │  │ Model           │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                     SQL Agent                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ Query           │  │ PydanticAI      │  │ SQLQueryResult  │ │
│  │ Generation      │  │ Framework       │  │ Model           │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                SQLite Database                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ compounds table (316,434 records)                          │ │
│  │ - Chemical formulas, names, phases                         │ │
│  │ - Thermodynamic properties (H298, S298, f1-f6)            │ │
│  │ - Temperature ranges, phase transition points             │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Детальная архитектура агентов

### Thermo Agent (main_thermo_agent.py)
```
┌─────────────────────────────────────────────────────────────────┐
│                    ThermoAgent                                  │
├─────────────────────────────────────────────────────────────────┤
│ Responsibilities:                                               │
│ • Извлечение параметров из пользовательских запросов           │
│ • Нормализация химических формул                                │
│ • Преобразование температур (Celsius → Kelvin)                 │
│ • Определение необходимости SQL запроса                        │
├─────────────────────────────────────────────────────────────────┤
│ Input:  str (user query)                                        │
│ Output: ExtractedParameters                                     │
├─────────────────────────────────────────────────────────────────┤
│ Dependencies:                                                   │
│ • ThermoAgentConfig (dependency injection)                     │
│ • PydanticAI Agent                                             │
│ • Session Logger                                               │
└─────────────────────────────────────────────────────────────────┘
```

### SQL Agent (sql_agent.py)
```
┌─────────────────────────────────────────────────────────────────┐
│                     SQLAgent                                    │
├─────────────────────────────────────────────────────────────────┤
│ Responsibilities:                                               │
│ • Генерация SQL запросов на основе извлеченных параметров      │
│ • Оптимизация запросов для термодинамической БД                │
│ • Объяснение логики запроса                                    │
│ • Предсказание структуры результата                            │
├─────────────────────────────────────────────────────────────────┤
│ Input:  ExtractedParameters                                     │
│ Output: SQLQueryResult                                          │
├─────────────────────────────────────────────────────────────────┤
│ Dependencies:                                                   │
│ • ThermoAgentConfig (dependency injection)                     │
│ • PydanticAI Agent                                             │
│ • Database schema knowledge                                    │
└─────────────────────────────────────────────────────────────────┘
```

## Модели данных

### ExtractedParameters
```python
@dataclass
class ExtractedParameters:
    compounds: List[str]           # Химические формулы
    temperature_celsius: Optional[float]  # Температура в Цельсиях
    phases: List[str]             # Агрегатные состояния
    property_type: Optional[str]   # Тип термодинамического свойства
    needs_sql_query: bool         # Флаг необходимости SQL запроса
```

### SQLQueryResult
```python
@dataclass
class SQLQueryResult:
    query: str                    # SQL запрос
    explanation: str              # Объяснение логики запроса
    expected_columns: List[str]   # Ожидаемые колонки результата
```

### ThermoAgentConfig
```python
@dataclass
class ThermoAgentConfig:
    openrouter_api_key: str       # API ключ для LLM
    llm_base_url: str            # URL для LLM API
    llm_default_model: str       # Модель по умолчанию
    db_path: str                 # Путь к базе данных
    log_level: str               # Уровень логирования
```

## Поток данных

### 1. Инициализация
```
main.py → load .env → create ThermoAgentConfig → initialize agents
```

### 2. Обработка запроса
```
User Query → ThermoAgent.extract_parameters() → ExtractedParameters
    ↓
if needs_sql_query:
    ExtractedParameters → SQLAgent.generate_query() → SQLQueryResult
    ↓
    SQLQueryResult → Database → Results
```

### 3. Логирование
```
All interactions → SessionLogger → logs/sessions/{timestamp}.log
```

## Схема базы данных

### Таблица compounds
```sql
CREATE TABLE compounds (
    id INTEGER PRIMARY KEY,
    chemical_formula TEXT,      -- Химическая формула
    compound_name TEXT,         -- Название соединения
    phase TEXT,                 -- Фаза (s/l/g/aq)
    H298 REAL,                  -- Энтальпия при 298K (kJ/mol)
    S298 REAL,                  -- Энтропия при 298K (J/(mol·K))
    f1, f2, f3, f4, f5, f6 REAL, -- Коэффициенты теплоемкости
    Tmin REAL,                  -- Минимальная температура
    Tmax REAL,                  -- Максимальная температура
    Tm REAL,                    -- Температура плавления
    Tb REAL                     -- Температура кипения
);
```

### Индексы для оптимизации
```sql
CREATE INDEX idx_formula ON compounds(chemical_formula);
CREATE INDEX idx_phase ON compounds(phase);
CREATE INDEX idx_formula_phase ON compounds(chemical_formula, phase);
```

## Конфигурация и развертывание

### Переменные окружения
```env
OPENROUTER_API_KEY=your_api_key
LLM_BASE_URL=https://openrouter.ai/api/v1
LLM_DEFAULT_MODEL=openai/gpt-oss-120b
DB_PATH=data/thermo_data.db
LOG_LEVEL=INFO
```

### Структура проекта
```
├── src/thermo_agents/
│   ├── __init__.py
│   ├── main_thermo_agent.py    # Основной агент
│   ├── sql_agent.py           # SQL агент
│   ├── prompts.py             # Системные промпты
│   └── thermo_agents_logger.py # Система логирования
├── data/
│   └── thermo_data.db         # База термодинамических данных
├── logs/sessions/             # Логи сессий
├── docs/                      # Документация и ноутбуки
├── main.py                    # Точка входа CLI
├── pyproject.toml             # Конфигурация uv
└── .env                       # Переменные окружения
```

## Принципы масштабирования

### 1. Горизонтальное масштабирование агентов
- Возможность добавления новых специализированных агентов
- Единый интерфейс через PydanticAI
- Конфигурация через dependency injection

### 2. Оптимизация базы данных
- Индексирование часто используемых полей
- Возможность шардинга по химическим семействам
- Кэширование частых запросов

### 3. Асинхронная обработка
- Все операции агентов неблокирующие
- Возможность параллельной обработки запросов
- Отказоустойчивость через обработку ошибок

## Мониторинг и отладка

### Система логирования
- Session-based логи в `logs/sessions/`
- Структурированное логирование всех взаимодействий
- Трейсинг запросов между агентами

### Метрики производительности
- Время обработки запросов агентами
- Успешность генерации SQL запросов
- Статистика использования базы данных

## Безопасность

### API ключи
- Хранение в переменных окружения
- Никогда не коммитятся в репозиторий
- Ротация ключей через конфигурацию

### SQL инъекции
- Параметризованные запросы
- Валидация входных данных через Pydantic
- Ограничение привилегий БД

### Логирование
- Исключение чувствительных данных из логов
- Локальное хранение логов
- Ротация лог файлов