# Архитектура проекта: Термодинамические AI-агенты v2.0

## Обзор проекта

Это сложная система анализа термодинамических данных, построенная на гибридной архитектуре v2.0, которая объединяет LLM-компоненты для извлечения параметров с детерминированной обработкой данных. Система предназначена для анализа химических реакций и предоставления термодинамических данных для до 10 соединений в одной реакции.

## Гибридная архитектура v2.0

### Концептуальная схема

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐
│   User Query    │───▶│ Thermodynamic    │───▶│ ExtractedReaction   │
│  (Natural       │    │ Agent (LLM)      │    │ Parameters          │
│   Language)     │    │                  │    │                     │
└─────────────────┘    └──────────────────┘    └─────────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐
│ Formatted       │◀───│ Reaction         │◀───│ FilterPipeline      │
│ Response        │    │ Aggregator       │    │ (6 stages)          │
│                 │    │                  │    │                     │
└─────────────────┘    └──────────────────┘    └─────────────────────┘
           ▲                                               │
           │                                               ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐
│ Table/Statistics│───▶│ Compound         │◀───│ Database Records    │
│ Formatter       │    │ Searcher         │    │ (SQLite: 316K rows) │
│                 │    │                  │    │                     │
└─────────────────┘    └──────────────────┘    └─────────────────────┘
```

### Ключевые принципы архитектуры

1. **Разделение ответственности**: LLM для извлечения параметров, детерминированная логика для обработки данных
2. **Слабая связанность**: Компоненты общаются через AgentStorage, не напрямую
3. **Высокая производительность**: Детерминированная обработка (<5 секунд для 10 соединений)
4. **Модульность**: Каждый компонент может быть независимо заменён или расширен
5. **Отказоустойчивость**: Graceful degradation при отсутствии данных

## Компоненты архитектуры

### 1. LLM-компоненты

#### ThermodynamicAgent (`src/thermo_agents/thermodynamic_agent.py`)
- **Технология**: PydanticAI с интеграцией OpenRouter API
- **Назначение**: Извлечение параметров реакции из естественного языка
- **Возможности**:
  - Поддержка до 10 соединений в реакции
  - Валидация температурных диапазонов (0-10000K)
  - Извлечение сбалансированных уравнений реакций
  - Обработка запросов на русском и английском языках
  - Retry-логика с обработкой таймаутов

#### AgentStorage (`src/thermo_agents/agent_storage.py`)
- **Назначение**: Централизованное хранилище для A2A (Agent-to-Agent) коммуникации
- **Функции**:
  - Управление очередями сообщений с correlation IDs
  - Сессионное управление
  - Диагностические возможности для отладки

### 2. Детерминированные компоненты

#### Поиск соединений (Search Module)

**CompoundSearcher** (`src/thermo_agents/search/compound_searcher.py`)
- Координирует поиск соединений в базе данных
- Реализует многостратегичный поиск
- Предоставляет детальную статистику поиска

**SQLBuilder** (`src/thermo_agents/search/sql_builder.py`)
- Генерирует оптимизированные SQL-запросы
- Поддерживает сложные паттерны поиска
- Обрабатывает префиксный поиск для сложных соединений

**DatabaseConnector** (`src/thermo_agents/search/database_connector.py`)
- Надёжное соединение с SQLite базой данных
- Пулы соединений и обработка ошибок
- Валидация целостности данных

#### Конвейер фильтрации (Filtering Module)

**FilterPipeline** (`src/thermo_agents/filtering/filter_pipeline.py`)
- 6-стадийный конвейер обработки
- Мониторинг производительности (CPU, память, время)
- Сбор статистики на каждой стадии

**Стадии фильтрации**:
1. **Reaction Validation** (`reaction_validation_stage.py`) - Валидация реакции
2. **Complex Formula Search** (`complex_search_stage.py`) - Поиск сложных формул
3. **Temperature Filtering** (`filter_stages.py`) - Фильтрация по температуре
4. **Phase Selection** (`phase_resolver.py`) - Выбор фазового состояния
5. **Reliability Priority** (`filter_stages.py`) - Приоритет надёжности
6. **Temperature Coverage** (`filter_stages.py`) - Покрытие диапазона температур

**TemperatureResolver** (`src/thermo_agents/filtering/temperature_resolver.py`)
- Разрешение температурных диапазонов
- Обработка фазовых переходов
- Валидация покрытия данных

**PhaseResolver** (`src/thermo_agents/filtering/phase_resolver.py`)
- Определение фазовых состояний (s/l/g/aq)
- Учёт температурных зависимостей
- Применение пользовательских предпочтений

#### Агрегация данных (Aggregation Module)

**ReactionAggregator** (`src/thermo_agents/aggregation/reaction_aggregator.py`)
- Агрегация результатов от нескольких соединений
- Генерация предупреждений и рекомендаций
- Расчёт статуса полноты данных
- Поддержка до 10 соединений в реакции

**TableFormatter** (`src/thermo_agents/aggregation/table_formatter.py`)
- Профессиональное форматирование таблиц через tabulate
- Поддержка различных форматов вывода
- Кастомизация колонок и стилей

**StatisticsFormatter** (`src/thermo_agents/aggregation/statistics_formatter.py`)
- Форматирование детальной статистики
- Визуализация результатов обработки
- Метрики производительности

### 3. Оркестрация

#### ThermoOrchestrator (`src/thermo_agents/orchestrator.py`)
- **Главный координатор системы**
- Управляет всем потоком выполнения
- Обрабатывает как LLM, так и детерминированные компоненты
- Управляет жизненным циклом сессий и обработкой ошибок
- Предоставляет мониторинг статуса и диагностику

### 4. Модели данных

#### Extraction Models (`src/thermo_agents/models/extraction.py`)
- `ExtractedReactionParameters` - Параметры, извлечённые из запроса
- Валидация бизнес-правил
- Поддержка температурных диапазонов и фаз

#### Search Models (`src/thermo_agents/models/search.py`)
- `DatabaseRecord` - Запись из базы данных
- `CompoundSearchResult` - Результат поиска соединения
- `SearchStatistics` - Статистика поиска

#### Aggregation Models (`src/thermo_agents/models/aggregation.py`)
- `AggregatedReactionData` - Агрегированные данные по реакции
- `FilterStatistics` - Статистика фильтрации
- `ProcessingMetrics` - Метрики производительности

## Поток данных в системе

### 1. Обработка пользовательского запроса

```python
# Пример запроса: "Горение водорода: 2H2 + O2 -> 2H2O при 500-800K"

# Этап 1: LLM-извлечение
User Query → ThermodynamicAgent → ExtractedReactionParameters
{
    "compounds": ["H2", "O2", "H2O"],
    "coefficients": [2, 1, 2],
    "temperature_range": [500, 800],
    "phases": ["g", "g", "l"],
    "reaction_equation": "2H2 + O2 -> 2H2O"
}
```

### 2. Поиск и фильтрация данных

```python
# Для каждого соединения:
Compound → CompoundSearcher → Database Records
Records → FilterPipeline (6 stages) → Filtered Records
```

### 3. Агрегация и форматирование

```python
Filtered Records → ReactionAggregator → AggregatedReactionData
AggregatedReactionData → TableFormatter → Formatted Response
```

## База данных термодинамических данных

### Структура таблицы `compounds`
- **316,434 записей** с **32,790 уникальными химическими формулами**
- Поля:
  - `formula`, `name`, `phase` (s/l/g/aq)
  - `H298`, `S298` - стандартные энтальпия и энтропия
  - `f1`-`f6` - коэффициенты теплоёмкости
  - `Tmin`, `Tmax` - температурный диапазон
  - `Tmelt`, `Tboil` - температуры плавления/кипения
  - `reliability_class` - класс надёжности (1-74.66% записей)

### Индексация и оптимизация
- Индексы по `formula`, `phase`, `Tmin`, `Tmax`
- Оптимизированные запросы для быстрого поиска
- Поддержка префиксного поиска для сложных соединений

## Система логирования

### SessionLogger (`src/thermo_agents/thermo_agents_logger.py`)
- **Сессионное логирование** с correlation IDs
- Детальное отслеживание операций
- Сбор метрик производительности
- Debug-снимки для устранения неисправностей

### Уровни логирования
- **INFO**: Основные этапы обработки
- **DEBUG**: Детальная трассировка
- **PERFORMANCE**: Метрики CPU, памяти, времени
- **ERROR**: Обработка ошибок и recovery

## Тестирование

### Интеграционные тесты (`tests/integration/`)
- **Сквозные тесты**: Полные циклы обработки запросов
- **Граничные случаи**: Сложные соединения, фазовые переходы
- **Тесты производительности**: Бенчмарки скорости
- **35+ тестов** включая пограничные случаи

### Unit тесты (`tests/unit/`, `tests/search/`, `tests/test_aggregation/`)
- Тестирование отдельных компонентов
- Валидация моделей данных
- Тестирование бизнес-логики

## Конфигурация

### Переменные окружения (.env)
```bash
# LLM конфигурация
OPENROUTER_API_KEY=your_api_key
LLM_BASE_URL=https://openrouter.ai/api/v1
LLM_DEFAULT_MODEL=openai/gpt-4o

# База данных
DB_PATH=data/thermo_data.db

# Логирование
LOG_LEVEL=INFO

# Таймауты
THERMO_AGENT_TIMEOUT=60
SEARCHER_TIMEOUT=30
FILTER_PIPELINE_TIMEOUT=45
```

### Зависимости (pyproject.toml)
- `pydantic-ai==1.0.8` - Структурированная LLM-интеграция
- `tabulate>=0.9.0` - Форматирование таблиц
- `pandas>=2.2.0` - Обработка данных
- `uv` - Управление зависимостями

## Производительность и масштабирование

### Оптимизации производительности
- **Быстрая детерминированная обработка** (<5 секунд для 10 соединений)
- **Эффективные SQL-запросы** с индексацией
- **Мониторинг производительности** в реальном времени
- **Кэширование** и переиспользование конвейера

### Масштабируемость
- **Модульная архитектура** для лёгкого расширения
- **Настраиваемые таймауты** и лимиты
- **Пулы соединений** с базой данных
- **Асинхронная обработка** с async/await

## Обработка ошибок и отказоустойчивость

### Стратегии обработки ошибок
- **Graceful degradation** при отсутствии данных
- **Retry-логика** для LLM-вызовов
- **Восстановление** после сетевых ошибок
- **Fallback-ответы** при недоступности компонентов

### Валидация данных
- Валидация химических формул
- Проверка температурных диапазонов
- Верификация фазовых состояний
- Проверка класса надёжности

## Примеры использования

### Базовый запрос
```python
# Запрос: "Горение метана: CH4 + 2O2 -> CO2 + 2H2O при 600-1200K"
# Результат: Таблица с термодинамическими данными для всех соединений
```

### Сложные соединения
```python
# Запрос: "Растворение HCl в воде при 298K"
# Результат: Данные для HCl (газ), H2O (жидкость), HCl (aq)
```

### Фазовые переходы
```python
# Запрос: "Нагревание льда от 250K до 350K"
# Результат: Данные для H2O (твёрдая) и H2O (жидкая) с точкой перехода
```

## Будущие расширения

### Возможные улучшения
1. **Дополнительные LLM-агенты** для специфических доменов
2. **Расширенная база данных** с новыми соединениями
3. **Web-интерфейс** для интерактивного использования
4. **API** для интеграции с другими системами
5. **Кэширование результатов** для ускорения повторных запросов

### Архитектурные улучшения
1. **Микросервисная архитектура** для распределённого развёртывания
2. **Очереди сообщений** для асинхронной обработки
3. **Контейнеры Docker** для портативности
4. **Kubernetes** для оркестрации и масштабирования

## Заключение

Архитектура термодинамических AI-агентов v2.0 представляет собой зрелую, производительную систему, которая успешно объединяет гибкость LLM с надёжностью детерминированной обработки. Гибридный подход обеспечивает как интеллектуальную обработку естественного языка, так и предсказуемую высокую производительность для научных расчётов.

Система готова к производственному использованию и может легко масштабироваться для обработки больших объёмов запросов с поддержкой расширения функциональности по мере развития проекта.