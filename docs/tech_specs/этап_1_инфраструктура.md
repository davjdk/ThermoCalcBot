# Этап 1: Инфраструктура (2–3 дня)

**Статус:** Планируется  
**Ответственный:** TBD  
**Зависимости:** Настройка проекта и виртуального окружения

## Цели этапа

Создать базовую инфраструктуру для оркестратора-агента: контракты данных, инструменты работы с БД, инструменты обработки данных, базовая конфигурация.

## Задачи

### 1. Создать модели данных (`app/agents/models.py`)

**Описание:** Создать Pydantic модели для всех контрактов данных между шагами оркестратора.

**Модели для реализации:**
- `ExtractedParams` - результат извлечения параметров из запроса
- `NeedSpec` - спецификация требований к полноте данных  
- `SqlCandidate` - кандидат SQL запроса с обоснованием
- `Rows` - результат выполнения SQL с метаданными
- `CompletenessResult` - результат проверки полноты данных
- `ToolSpec` - спецификация инструмента для выполнения
- `ToolRunResult` - результат выполнения инструмента
- `AnswerModel` - итоговый ответ пользователю

**Требования:**
- Строгая валидация всех полей через Pydantic
- Добавить валидаторы для enum полей (intent, фазы)
- Добавить field_validator для критических полей
- Документировать все поля

**Файлы:** `app/agents/models.py`

### 2. Реализовать инструменты работы с БД (`app/agents/tools/db_tools.py`)

**Описание:** Создать безопасный слой для работы с SQLite БД с защитой от инъекций и вредоносных операций.

**Функции для реализации:**
- `sanitize_sql(sql: str) -> str` - очистка и валидация SQL
- `limit_sql(sql: str, default_limit: int) -> str` - добавление LIMIT
- `explain_sql(sql: str) -> dict` - получение плана выполнения
- `run_sql(sql: str, limit: int | None = None) -> Rows` - безопасное выполнение

**Требования безопасности:**
- Запретить DDL/DML операции (CREATE, DROP, INSERT, UPDATE, DELETE)
- Разрешить только SELECT и EXPLAIN
- Обязательные лимиты на количество строк
- Таймауты на выполнение запросов
- Логирование всех выполненных запросов

**Интеграция:**
- Использовать существующий `app/database/connection.py`
- Брать настройки из `app/config/settings.py`

**Файлы:** `app/agents/tools/db_tools.py`

### 3. Перенести инструменты обработки данных (`app/agents/tools/data_tools.py`)

**Описание:** Перенести Python-инструменты из Jupyter ноутбуков в чистые функции без графиков.

**Функции для переноса:**
- `thermodynamic_table(row_like: Mapping[str, Any]) -> list[dict]` - расчет термодинамической таблицы
- `reaction_H_S_G_wc(T_K: float, rows_bundle: dict[str, Mapping[str, Any]]) -> dict` - расчет реакции

**Требования:**
- Убрать все зависимости от matplotlib/seaborn
- Добавить валидацию входных параметров
- Проверять диапазоны температур и других физических величин
- Документировать единицы измерения
- Обрабатывать граничные случаи (деление на ноль, отсутствие данных)

**Источники:** 
- `docs/db_work.ipynb` 
- `docs/сhlorination_of_tungsten.ipynb`

**Файлы:** `app/agents/tools/data_tools.py`

### 4. Дополнить конфигурацию (`app/config/settings.py`)

**Описание:** Добавить настройки для оркестратора, которые пока не будут использоваться.

**Новые настройки:**
- `LLM_TIMEOUT_S: int` - таймаут для LLM запросов
- `DB_TIMEOUT_S: int` - таймаут для БД запросов  
- `MAX_TOOL_CALLS: int` - лимит вызовов инструментов за запуск
- `MAX_MODEL_CALLS: int` - лимит вызовов моделей за запуск
- Модели по шагам (опционально):
  - `MODEL_NAME_EXTRACT: str | None`
  - `MODEL_NAME_VALIDATE: str | None` 
  - `MODEL_NAME_SQL: str | None`
  - `MODEL_NAME_ANSWER: str | None`

**Требования:**
- Безопасные значения по умолчанию
- Обновить `.env.example` с новыми переменными
- Добавить валидацию для числовых лимитов

**Файлы:** `app/config/settings.py`, `.env.example`

### 5. Unit тесты

**Описание:** Покрыть тестами новые модули для проверки корректности базовой функциональности.

**Тесты для `db_tools`:**
- `test_sanitize_sql_allows_select()` - разрешает SELECT
- `test_sanitize_sql_blocks_ddl()` - блокирует CREATE/DROP
- `test_sanitize_sql_blocks_dml()` - блокирует INSERT/UPDATE/DELETE
- `test_limit_sql_adds_limit()` - добавляет LIMIT к запросу
- `test_explain_sql_returns_plan()` - возвращает план выполнения
- `test_run_sql_with_timeout()` - проверяет таймауты

**Тесты для `data_tools`:**
- `test_thermodynamic_table_valid_input()` - корректный расчет для известных данных
- `test_thermodynamic_table_invalid_temperature()` - обработка некорректной температуры
- `test_reaction_H_S_G_wc_valid()` - корректный расчет реакции
- `test_reaction_H_S_G_wc_missing_data()` - обработка отсутствующих данных

**Тесты для `models`:**
- `test_extracted_params_validation()` - валидация полей ExtractedParams
- `test_rows_model_structure()` - корректная структура Rows
- `test_answer_model_serialization()` - сериализация/десериализация

**Файлы:** `tests/test_db_tools.py`, `tests/test_data_tools.py`, `tests/test_models.py`

## Критерии готовности

- ✅ Все модели в `models.py` валидируют данные корректно
- ✅ `db_tools` блокирует опасные SQL операции и добавляет лимиты
- ✅ `data_tools` выполняет расчеты без графических зависимостей
- ✅ Настройки добавлены в `settings.py` и `.env.example`
- ✅ Все unit тесты проходят (`uv run pytest tests/test_db_tools.py tests/test_data_tools.py tests/test_models.py`)
- ✅ Код соответствует стандартам проекта (типизация, документация)

## Структура файлов после этапа

```
app/
├── agents/
│   ├── __init__.py
│   ├── models.py          # Новый
│   └── tools/
│       ├── __init__.py
│       ├── db_tools.py    # Новый  
│       └── data_tools.py  # Новый
├── config/
│   └── settings.py        # Обновлен
tests/
├── test_db_tools.py       # Новый
├── test_data_tools.py     # Новый
└── test_models.py         # Новый
.env.example               # Обновлен
```

## Риски и смягчение

**Риск:** Неточный перенос формул из ноутбуков  
**Смягчение:** Сравнить результаты с исходными расчетами в тестах

**Риск:** Недостаточная защита от SQL инъекций  
**Смягчение:** Тщательное тестирование различных вредоносных запросов

**Риск:** Производительность инструментов обработки данных  
**Смягчение:** Профилирование критических функций, оптимизация при необходимости