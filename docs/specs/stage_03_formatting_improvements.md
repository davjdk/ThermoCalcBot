# Техническое задание: Улучшение форматирования и логирования (Stage 03)

**Дата создания:** 2025-11-02  
**Ветка:** refactor/stage-03-formatting  
**Статус:** В разработке

## Обзор

Данное ТЗ описывает улучшения системы вывода результатов и логирования для термодинамических расчётов. Основные цели:
- Синхронизация вывода в консоль с лог-файлами
- Замена библиотеки форматирования таблиц
- Добавление информации о фазовых переходах
- Расширенный вывод данных о веществах

## 1. Логирование вывода в консоль

### 1.1 Цель
При запуске `uv run main.py --test` весь вывод, видимый пользователю в консоли, должен дублироваться в лог-файлы сессий для сохранения полной истории работы с приложением.

### 1.2 Требования

#### 1.2.1 Дублирование вывода
- Все данные, выводимые в консоль (включая таблицы, заголовки, комментарии), должны записываться в лог-файл сессии
- Лог-файлы располагаются в `logs/sessions/session_<timestamp>_<id>.log`
- Формат записи в лог должен сохранять читаемость таблиц (выравнивание колонок)

#### 1.2.2 Область применения
- Применяется только при запуске с флагом `--test`
- Не влияет на существующую структуру логов (metadata, символы статусов ✓/○/⚠/❌ остаются)
- Вывод таблиц добавляется в соответствующий раздел лог-файла

#### 1.2.3 Технические детали
- Модифицировать `src/thermo_agents/session_logger.py`
- Добавить метод для записи консольного вывода
- Интегрировать с существующей системой логирования сессий
- Убедиться, что форматирование таблиц корректно отображается в текстовом файле

### 1.3 Затрагиваемые файлы
- `main.py` — обработка флага `--test`
- `src/thermo_agents/session_logger.py` — методы логирования
- `src/thermo_agents/formatting/` — форматеры должны поддерживать вывод в лог

---

## 2. Замена библиотеки форматирования таблиц

### 2.1 Цель
Заменить `rich` на `tabulate` для форматирования таблиц в проекте.

### 2.2 Требования

#### 2.2.1 Удаление зависимости rich
- Удалить `rich` из `pyproject.toml`
- Добавить `tabulate` в зависимости проекта
- Убедиться, что `rich` используется **только** в форматере (на данный момент)

#### 2.2.2 Обновление форматера
- Заменить все использования `rich.table.Table` на `tabulate.tabulate`
- Сохранить текущую структуру вывода (заголовки, выравнивание)
- Использовать формат таблиц `"grid"` или `"simple"` для читаемости в консоли и логах
- Протестировать вывод в консоль и в лог-файлы

#### 2.2.3 Стиль таблиц
- Выбрать стиль `tabulate`, обеспечивающий чёткое отображение в консоли
- Рекомендуется: `tablefmt="grid"` для основных таблиц
- Для данных веществ: можно использовать `tablefmt="simple"` или `"grid"`

### 2.3 Затрагиваемые файлы
- `pyproject.toml` — обновление зависимостей
- `src/thermo_agents/formatting/reaction_calculation_formatter.py` — основной форматер
- `src/thermo_agents/formatting/compound_data_formatter.py` — форматер данных веществ
- Все тесты в `tests/formatting/` — обновление проверок форматирования

---

## 3. Отображение фазовых переходов вместо комментариев о спонтанности

### 3.1 Цель
Заменить комментарии о спонтанности реакции информацией о фазовых переходах веществ в температурном диапазоне.

### 3.2 Требования

#### 3.2.1 Логика определения фазовых переходов
- Каждая строка таблицы соответствует диапазону 100 K (температурный шаг)
- Для каждого диапазона [T, T+100] проверить все вещества (реагенты **и** продукты)
- Если в диапазоне происходит изменение фазы вещества, указать переход: `s → l`, `l → g`, `s → g` и т.д.

#### 3.2.2 Формат вывода
- **Если переход есть**: `Al2O3: s → l`, `C: s → g`, и т.д.
- **Если переходов несколько**: перечислить через запятую или с новой строки
- **Если переходов нет**: ячейка остаётся пустой
- Колонка в таблице: `"Фазовые переходы"` или `"Phase Transitions"`

#### 3.2.3 Источник данных
- Использовать данные из полей `Tmin`, `Tmax` записей веществ
- Фазовые переходы определяются сменой записи с одной фазой на запись с другой фазой
- Учитывать данные из `DatabaseRecord` для каждого вещества

#### 3.2.4 Удаление старой логики
- Убрать колонку/комментарии о спонтанности реакции (`ΔG < 0`)
- Не выводить текст "Reaction is spontaneous" / "Реакция самопроизвольна"

### 3.3 Затрагиваемые файлы
- `src/thermo_agents/formatting/reaction_calculation_formatter.py` — основная логика форматирования
- `src/thermo_agents/calculations/thermodynamic_calculator.py` — может потребоваться передача информации о фазах
- `src/thermo_agents/models/database_record.py` — использование данных о фазах

---

## 4. Вывод таблицы отобранных записей веществ

### 4.1 Цель
Для каждого вещества, участвующего в реакции, вывести отдельный раздел с таблицей всех отобранных записей из базы данных.

### 4.2 Требования

#### 4.2.1 Структура вывода
Перед таблицей расчёта реакции вывести разделы для каждого вещества:

```
=== Данные вещества: Al2O3 (Aluminium oxide) ===

| Formula | FirstName       | Phase | Tmin   | Tmax   | H298     | S298  |
| ------- | --------------- | ----- | ------ | ------ | -------- | ----- |
| Al2O3   | Aluminium oxide | s     | 298.15 | 2327.0 | -1675840 | 50.92 |
| Al2O3   | Aluminium oxide | l     | 2327.0 | 3000.0 | -1580000 | 125.5 |

=== Данные вещества: C (Carbon, Graphite) ===

| Formula | FirstName | Phase | Tmin   | Tmax   | H298 | S298 |
| ------- | --------- | ----- | ------ | ------ | ---- | ---- |
| C       | Carbon    | s     | 298.15 | 3915.0 | 0    | 5.74 |
...
```

#### 4.2.2 Колонки таблицы
- `Formula` — химическая формула
- `FirstName` — первое имя вещества из базы данных
- `Phase` — фаза (s, l, g, aq)
- `Tmin` — минимальная температура записи (K)
- `Tmax` — максимальная температура записи (K)
- `H298` — энтальпия образования при 298.15 K (Дж/моль)
- `S298` — энтропия при 298.15 K (Дж/(моль·K))

#### 4.2.3 Порядок вывода
1. Раздел для каждого реагента (в порядке: Al2O3, C, ...)
2. Раздел для каждого продукта (в порядке: Al4C3, CO, ...)
3. Затем основная таблица расчёта реакции

#### 4.2.4 Данные источника
- Использовать список `DatabaseRecord`, отобранных для каждого вещества
- Данные берутся из результатов поиска в базе данных
- Показывать только те записи, которые реально используются в расчёте

### 4.3 Затрагиваемые файлы
- `src/thermo_agents/formatting/compound_data_formatter.py` — создание таблицы данных веществ
- `src/thermo_agents/formatting/reaction_calculation_formatter.py` — интеграция вывода данных веществ
- `src/thermo_agents/orchestrator.py` — передача данных о записях в форматер

---

## 5. Архитектурные решения

### 5.1 Принципы разработки
- **Разделение ответственности**: логирование отделено от форматирования
- **Обратная совместимость**: старые тесты должны работать после минимальных изменений
- **Расширяемость**: новая структура должна позволять добавлять колонки/разделы

### 5.2 Миграция на tabulate
- Создать вспомогательные функции для форматирования таблиц
- Использовать единый стиль таблиц по всему проекту
- Протестировать на примерах из `logs/sessions/`

### 5.3 Интеграция с существующим кодом
- Минимизировать изменения в `orchestrator.py`
- Основные изменения — в модулях `formatting/`
- Обеспечить передачу полных данных `DatabaseRecord` в форматеры

---

## 6. План реализации

### Этап 1: Подготовка (1-2 часа)
1. Обновить `pyproject.toml`: удалить `rich`, добавить `tabulate`
2. Запустить `uv sync` для обновления зависимостей
3. Проверить текущие использования `rich` в проекте

### Этап 2: Замена форматирования (2-3 часа)
1. Обновить `reaction_calculation_formatter.py`
2. Обновить `compound_data_formatter.py`
3. Создать утилиты для единого стиля таблиц

### Этап 3: Логирование (1-2 часа)
1. Модифицировать `session_logger.py` для записи консольного вывода
2. Обновить `main.py` для обработки флага `--test`
3. Протестировать запись таблиц в лог-файлы

### Этап 4: Фазовые переходы (2-3 часа)
1. Реализовать логику определения фазовых переходов
2. Заменить колонку комментариев на колонку переходов
3. Протестировать на примерах с переходами (Al2O3, вода и др.)

### Этап 5: Таблицы данных веществ (1-2 часа)
1. Создать форматер для таблиц данных веществ
2. Интегрировать в основной вывод перед таблицей реакции
3. Протестировать на примерах из логов

### Этап 6: Тестирование и валидация (2-3 часа)
1. Обновить unit-тесты в `tests/formatting/`
2. Запустить интеграционные тесты
3. Проверить корректность вывода в лог-файлы
4. Валидация на реальных примерах (Al2O3 + C, FeO и др.)

---

## 7. Критерии приёмки

### 7.1 Логирование
- [ ] При запуске с `--test` весь консольный вывод дублируется в лог
- [ ] Таблицы в логе сохраняют форматирование и читаемы
- [ ] Лог-файлы содержат те же данные, что видит пользователь

### 7.2 Форматирование
- [ ] `rich` полностью удалён из проекта
- [ ] `tabulate` используется для всех таблиц
- [ ] Таблицы корректно отображаются в консоли и логах

### 7.3 Фазовые переходы
- [ ] Колонка "Фазовые переходы" присутствует в таблице расчёта
- [ ] Переходы отображаются в формате `s → l`, `l → g` и т.д.
- [ ] Пустые ячейки, если переходов нет
- [ ] Учитываются все вещества (реагенты и продукты)

### 7.4 Данные веществ
- [ ] Для каждого вещества выводится отдельный раздел
- [ ] Таблица содержит все требуемые колонки
- [ ] Разделы выводятся перед таблицей расчёта реакции
- [ ] Показываются только используемые записи

### 7.5 Тесты
- [ ] Все существующие тесты проходят или обновлены
- [ ] Добавлены тесты для новой функциональности
- [ ] Интеграционные тесты проходят успешно

---

## 8. Риски и ограничения

### 8.1 Риски
- **Производительность логирования**: запись больших таблиц может замедлить работу
  - *Митигация*: использовать буферизацию, асинхронную запись при необходимости
  
- **Изменение формата вывода**: пользователи могут быть привычны к старому формату
  - *Митигация*: добавить примеры в документацию, описать изменения

- **Сложность определения фазовых переходов**: могут быть граничные случаи
  - *Митигация*: чёткая логика, обработка краевых случаев, тесты

### 8.2 Ограничения
- Фазовые переходы определяются только по смене записей в БД
- Формат таблиц фиксирован (tabulate), без возможности кастомизации
- Логирование работает только в режиме `--test`

---

## 9. Откат изменений

### Если требуется откатить изменения:
1. **Форматирование**: вернуть `rich` в `pyproject.toml`, откатить изменения в форматерах
2. **Логирование**: удалить новые методы из `session_logger.py`
3. **Фазовые переходы**: вернуть старую логику комментариев
4. **Данные веществ**: убрать вызовы вывода таблиц данных

### Команды для отката:
```powershell
git checkout HEAD -- src/thermo_agents/formatting/
git checkout HEAD -- pyproject.toml
uv sync
```

---

## 10. Дополнительные заметки

### 10.1 Контекст из логов
- Примеры успешных расчётов: `session_20251102_175417_a1a87e.log`, `session_20251102_175312_8fd2c1.log`
- Тестовые случаи: Al2O3 + C при 2000°C
- Температурный диапазон: обычно 2200-2300 K, шаг 100 K

### 10.2 Связанная документация
- `docs/ARCHITECTURE.md` — общая архитектура проекта
- `docs/user_guide.md` — руководство пользователя (потребует обновления)
- `examples/reaction_calculation_example.py` — примеры использования

### 10.3 Зависимости
- Python 3.11+
- `tabulate` — новая зависимость
- `uv` — для управления окружением

---

**Конец технического задания**
