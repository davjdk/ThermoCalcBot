# Спецификация: Проблема выбора записей для начальной точки температурного диапазона

**Дата:** 11 ноября 2025  
**Статус:** В разработке  
**Компонент:** `RecordRangeBuilder`  
**Приоритет:** Высокий (критическая ошибка расчётов)

---

## 1. Описание проблемы

### Симптом

При запросе термодинамических свойств **CrCl₃** в диапазоне **298-1098K** система выбирает **неверную** первую запись:

- **Фактический выбор**: фаза `l` (жидкая), Tmin=1100K, Tmax=2500K, **H₂₉₈=60 кДж/моль**
- **Ожидаемый выбор**: фаза `s` (твёрдая), Tmin=298.1K, Tmax=1100K, **H₂₉₈=-544/-557/-570 кДж/моль**

**Фазовые переходы**: плавление при **1425K** (s → l)

### Причина

В методе `RecordRangeBuilder.get_compound_records_for_range()`:

**Стратегия 1** ищет запись с условием:
```python
(df["Tmin"] <= current_T + tolerance) & (df["Tmin"] >= current_T - tolerance)
```

Для `current_T = 298K` с `tolerance = 1.0K` это означает поиск записей с **Tmin ≈ 298K**.

**Проблема**: Условие `Tmin ≈ current_T` **НЕ гарантирует**, что запись **покрывает** начальную точку диапазона (`Tmin ≤ 298K ≤ Tmax`).

В базе данных для CrCl₃ есть записи:
- Фаза `s`: Tmin=**298.1K**, Tmax=1100K ✅ (покрывает 298K, но **298.1 ≈ 298** попадает в диапазон поиска)
- Фаза `l`: Tmin=**1100K**, Tmax=2500K ❌ (НЕ покрывает 298K, но **может попасть в выборку** при сортировке DataFrame)

Если DataFrame отсортирован по другим критериям (например, по фазе в алфавитном порядке: `g`, `l`, `s`), то первой найденной записью может оказаться `l`, которая **не покрывает 298K**.

### Последствие

1. **Неверные базовые значения**: H₂₉₈=60 вместо -544 кДж/моль (ошибка на ~600 кДж/моль)
2. **Полностью ошибочные расчёты**:
   - Энтальпия H(T)
   - Энтропия S(T)
   - Энергия Гиббса G(T)
3. **Неверные результаты для реакций** с участием CrCl₃

### Пример из логов

```
=== Данные вещества: CrCl3 ===
  T(K)    Cp    ΔH    ΔS    ΔG    Смена записи
------  ----  ----  ----  ----  --------------
   298   130     0     0     0  запись 1      ← ОШИБКА: фаза l, H₂₉₈=60
   398    60  5.01 14.32 -0.69  запись 13     ← Переключение на газовую фазу
```

**Ожидалось**:
- T=298K: фаза `s`, H₂₉₈≈-544 кДж/моль
- T=398K: фаза `s`, расчёт от базового H₂₉₈=-544

---

## 2. Решение

### Принцип

**ПЕРЕД** применением трёхуровневой стратегии добавить **предварительную проверку** для начальной точки диапазона.

### Логика изменений

**Место изменения**: Начало метода `RecordRangeBuilder.get_compound_records_for_range()`, перед основным циклом `while current_T < target_T`.

**Условие активации**: `current_T == t_range[0]` (первая итерация цикла)

**Алгоритм предварительной проверки**:

```python
# ПРЕДВАРИТЕЛЬНАЯ ПРОВЕРКА для начальной точки диапазона
if current_T == t_range[0]:
    # Определяем ожидаемую фазу для начальной температуры
    expected_phase = self.phase_detector.get_phase_at_temperature(
        current_T, melting, boiling
    )
    
    # Ищем записи, которые ПОКРЫВАЮТ начальную точку
    covering_records = df[
        (df["Phase"] == expected_phase) &
        (df["Tmin"] <= current_T) &
        (df["Tmax"] >= current_T)
    ]
    
    # Для сложных веществ: приоритет записям с H298≠0, S298≠0
    if not covering_records.empty and is_elemental is False:
        covering_records = self._prioritize_nonzero_h298_s298(
            covering_records, current_T, last_phase, expected_phase
        )
    
    # Фильтрация коэффициентов Шомейта
    if not covering_records.empty:
        covering_records = self._filter_valid_shomate_coefficients(
            covering_records, "Начальная точка", current_T
        )
    
    # Если нашли подходящую запись - используем её
    if not covering_records.empty:
        record = covering_records.iloc[0]
        records.append(record)
        last_phase = expected_phase
        self.logger.debug(
            f"[Начальная точка] Использована запись фазы '{expected_phase}' "
            f"(Tmin={record['Tmin']}, Tmax={record['Tmax']}, покрывает T={current_T}K)"
        )
        current_T = record["Tmax"]
        continue  # Переходим к следующей итерации
```

**После этой проверки** выполняется обычная трёхуровневая стратегия для оставшихся температур.

### Ключевые особенности решения

1. **Минимальные изменения**: 
   - Добавляется **одно** условие `if current_T == t_range[0]` в начале цикла
   - Используются **существующие** методы: `_prioritize_nonzero_h298_s298()`, `_filter_valid_shomate_coefficients()`
   - Остальная логика **не меняется**

2. **Гарантия корректности**:
   - Условие `Tmin ≤ current_T ≤ Tmax` гарантирует, что запись **покрывает** начальную точку
   - Фильтрация по фазе: `Phase == expected_phase` (на основе melting/boiling)
   - Для сложных веществ: приоритет записям с H₂₉₈≠0, S₂₉₈≠0

3. **Совместимость**:
   - Не влияет на работу для последующих температур (продолжается обычная стратегия)
   - Сохраняется логика фазовых переходов
   - Работает как для простых, так и для сложных веществ

### Альтернативные решения (отклонены)

❌ **Изменить Стратегию 1**: Заменить условие `Tmin ≈ current_T` на `Tmin ≤ current_T ≤ Tmax`
- **Риск**: Может нарушить логику для промежуточных температур
- **Сложность**: Требует изменения всей трёхуровневой стратегии

❌ **Отсортировать DataFrame по Tmin перед поиском**
- **Риск**: Может конфликтовать с приоритизацией по ReliabilityClass
- **Неэффективно**: Сортировка на каждой итерации

✅ **Предварительная проверка для начальной точки** (выбрано)
- Минимальное вмешательство в существующую логику
- Явное и понятное решение проблемы
- Легко тестируется

### Файлы для изменения

- `src/thermo_agents/core_logic/record_range_builder.py` — метод `get_compound_records_for_range()`
  - Добавить предварительную проверку после `current_T = t_range[0]`
  - Добавить логирование `[Начальная точка]`

---

## 3. Тестовый сценарий

### Данные для теста

**Вещество**: CrCl₃ (хлорид хрома III)  
**Температурный диапазон**: 298-1098K  
**Фазовые переходы**: 
- Плавление при **1425K** (s → l)

**Доступные записи в базе данных** (упрощённо):

| Phase | Tmin (K) | Tmax (K) | H₂₉₈ (кДж/моль)    | S₂₉₈ (Дж/(моль·K)) | Коэфф. Шомейта          |
| ----- | -------- | -------- | ------------------ | ------------------ | ----------------------- |
| `s`   | 298.1    | 1100     | -544 / -557 / -570 | 122.9 / 123.01     | f1=84.91, f2=32.09, ... |
| `l`   | 1100     | 2500     | 60                 | 54.54 / 54.55      | f1=130, остальные=0     |
| `g`   | 298.1    | 900      | -333               | 346.97             | f1=79.13, f2=4.66, ...  |
| `g`   | 900      | 2300     | 0                  | 0                  | f1=89.20, f2=3.61, ...  |
| `g`   | 2300     | 6000     | 0                  | 0                  | f1=88.33, f2=-1.12, ... |

### Ожидаемый результат

**Выбранные записи** (после исправления):

1. **Первая запись** (начальная точка 298K):
   - Фаза: `s` (твёрдая)
   - Tmin: 298.1K
   - Tmax: 1100K
   - H₂₉₈: -544 / -557 / -570 кДж/моль (любое из этих значений)
   - S₂₉₈: 122.9 / 123.01 Дж/(моль·K)

2. **Вторая запись** (продолжение до 1098K):
   - Выбор зависит от логики, но **НЕ должна быть** фаза `l` (так как 1098K < 1425K плавления)
   - Возможно, останется та же запись `s` (298.1-1100K), так как она покрывает весь диапазон

**Итого**: 1-2 записи, все с фазой `s`, первая **обязательно** с H₂₉₈≠0

### Тестовый код

```python
import pandas as pd
import pytest
from src.thermo_agents.core_logic.record_range_builder import RecordRangeBuilder
from src.thermo_agents.thermo_agents_logger import get_logger

def test_crcl3_initial_point_selection():
    """
    Тест выбора записей для CrCl3 в диапазоне 298-1098K.
    
    Проверяет, что для начальной точки диапазона (298K) выбирается
    запись, которая:
    1. Покрывает 298K (Tmin ≤ 298 ≤ Tmax)
    2. Имеет правильную фазу 's' (твёрдая, т.к. 298K < 1425K плавления)
    3. Имеет ненулевые H298, S298 (сложное вещество)
    """
    # Подготовка данных (симуляция записей из базы)
    data = {
        "Formula": ["CrCl3"] * 5,
        "FirstName": ["Chromium(III) chloride"] * 5,
        "Phase": ["s", "l", "g", "g", "g"],
        "Tmin": [298.1, 1100, 298.1, 900, 2300],
        "Tmax": [1100, 2500, 900, 2300, 6000],
        "H298": [-544, 60, -333, 0, 0],
        "S298": [122.9, 54.54, 346.97, 0, 0],
        "Cp298": [91.8, 130, 76.17, 36.56, 210.05],
        "f1": [84.91, 130, 79.13, 89.20, 88.33],
        "f2": [32.09, 0, 4.66, 3.61, -1.12],
        "f3": [-2.38, 0, -4.11, -47.63, 108.48],
        "f4": [-0.0087, 0, 3.08, -1.56, 0.10],
        "f5": [0, 0, 0, 0, 0],
        "f6": [0, 0, 0, 0, 0],
    }
    df = pd.DataFrame(data)
    
    # Инициализация RecordRangeBuilder
    logger = get_logger(__name__)
    builder = RecordRangeBuilder(logger)
    
    # Параметры запроса
    t_range = [298.0, 1098.0]
    melting = 1425.0  # K (плавление CrCl3)
    boiling = None    # Нет данных о кипении в диапазоне
    is_elemental = False  # Сложное вещество
    
    # Вызов метода
    records = builder.get_compound_records_for_range(
        df=df,
        t_range=t_range,
        melting=melting,
        boiling=boiling,
        tolerance=1.0,
        is_elemental=is_elemental
    )
    
    # ПРОВЕРКИ
    
    # 1. Должна быть выбрана хотя бы одна запись
    assert len(records) > 0, "Не выбрано ни одной записи"
    
    # 2. Первая запись должна иметь фазу 's' (твёрдая)
    assert records[0]["Phase"] == "s", \
        f"Первая запись имеет фазу '{records[0]['Phase']}', ожидалась 's'"
    
    # 3. Первая запись должна покрывать начальную точку 298K
    assert records[0]["Tmin"] <= 298.15, \
        f"Tmin первой записи ({records[0]['Tmin']}) > 298.15K"
    assert records[0]["Tmax"] >= 298.15, \
        f"Tmax первой записи ({records[0]['Tmax']}) < 298.15K"
    
    # 4. Первая запись должна иметь ненулевые H298 (сложное вещество)
    assert abs(records[0]["H298"]) > 500, \
        f"H298 первой записи ({records[0]['H298']}) близко к нулю, ожидалось ~-544 кДж/моль"
    
    # 5. Первая запись должна иметь ненулевые S298
    assert abs(records[0]["S298"]) > 100, \
        f"S298 первой записи ({records[0]['S298']}) близко к нулю, ожидалось ~122.9 Дж/(моль·K)"
    
    # 6. Все выбранные записи должны быть либо 's', либо 'l' (если переход)
    #    Для диапазона 298-1098K (< 1425K плавления) должна быть только фаза 's'
    for i, rec in enumerate(records):
        assert rec["Phase"] in ["s", "l"], \
            f"Запись {i} имеет фазу '{rec['Phase']}', ожидалась 's' или 'l'"
    
    # 7. Проверка покрытия диапазона
    assert records[0]["Tmin"] <= t_range[0], \
        "Первая запись не покрывает начало диапазона"
    assert records[-1]["Tmax"] >= t_range[1], \
        "Последняя запись не покрывает конец диапазона"
    
    print(f"✅ Тест пройден! Выбрано записей: {len(records)}")
    for i, rec in enumerate(records):
        print(f"  Запись {i+1}: фаза={rec['Phase']}, "
              f"Tmin={rec['Tmin']}, Tmax={rec['Tmax']}, "
              f"H298={rec['H298']}, S298={rec['S298']}")


def test_crcl3_wrong_selection_before_fix():
    """
    Регрессионный тест: проверяет, что БЕЗ исправления
    система выбирает неверную запись (фаза 'l' вместо 's').
    
    Этот тест должен ПАДАТЬ до применения исправления
    и ПРОХОДИТЬ после исправления.
    """
    # ... (аналогичная подготовка данных)
    
    # Ожидаемая ОШИБКА (до исправления):
    # records[0]["Phase"] == "l"  # НЕВЕРНО!
    # records[0]["H298"] == 60     # НЕВЕРНО!
    
    # После исправления:
    # records[0]["Phase"] == "s"   # ВЕРНО
    # records[0]["H298"] ≈ -544    # ВЕРНО
    pass
```

### Критерии приёмки

✅ **Тест проходит** после применения исправления:
1. Первая запись имеет фазу `s`
2. Первая запись покрывает 298K
3. H₂₉₈ ≈ -544 кДж/моль (не 60)
4. S₂₉₈ ≈ 122.9 Дж/(моль·K)

❌ **Тест падает** до применения исправления:
1. Первая запись имеет фазу `l` (или `g`)
2. H₂₉₈ = 60 (или другое неверное значение)

### Дополнительные тесты

1. **Тест для простых веществ** (is_elemental=True):
   - Проверить, что допускаются записи с H₂₉₈=0, S₂₉₈=0

2. **Тест для диапазона с фазовым переходом** (298-1600K):
   - Проверить, что выбираются записи `s` (298-1100) + `l` (1100-1600)
   - Переход при melting=1425K

3. **Тест для граничного случая** (Tmin точно равен 298.15K):
   - Проверить, что запись выбирается корректно при `tolerance=1.0`

---

## 4. Мотивация и риски

### Мотивация

- **Критическая ошибка**: Неверные расчёты термодинамических свойств
- **Частота проблемы**: Проявляется для всех веществ с несколькими фазами в базе
- **Простота решения**: Минимальное изменение кода (< 30 строк)

### Риски

| Риск                                | Вероятность | Митигация                                                                                        |
| ----------------------------------- | ----------- | ------------------------------------------------------------------------------------------------ |
| Нарушение работы для других веществ | Низкая      | Предварительная проверка работает **только** для начальной точки, остальная логика без изменений |
| Конфликт с оптимизацией записей     | Низкая      | Предварительная проверка выполняется **до** оптимизации                                          |
| Регрессия в тестах                  | Средняя     | Запустить **все** существующие тесты RecordRangeBuilder после изменения                          |

### План отката

Если возникнут проблемы:
1. Удалить блок `if current_T == t_range[0]`
2. Откатить изменения в `record_range_builder.py`
3. Вернуться к трёхуровневой стратегии без предварительной проверки

---

## 5. Связанные компоненты

- `RecordRangeBuilder` — требует изменения
- `PhaseTransitionDetector` — используется в решении (без изменений)
- `CompoundDataLoader` — вызывает RecordRangeBuilder (без изменений)
- `ThermodynamicEngine` — использует выбранные записи для расчётов (без изменений)

---

**Дата создания**: 11 ноября 2025  
**Автор**: davjdk  
**Статус**: Готово к реализации