# Этапы реализации спецификации форматов вывода v2.1

**Базовая спецификация:** [`../output_spec.md`](../output_spec.md)

---

## Обзор этапов

Реализация разбита на 5 последовательных этапов:

| #   | Этап                                                                       | Приоритет | Зависимости | Статус   |
| --- | -------------------------------------------------------------------------- | --------- | ----------- | -------- |
| 1   | [Расширение ExtractedReactionParameters](stage_1_extraction_parameters.md) | Высокий   | —           | Не начат |
| 2   | [Создание ThermodynamicCalculator](stage_2_thermodynamic_calculator.md)    | Высокий   | Этап 1      | Не начат |
| 3   | [Создание форматтеров](stage_3_formatters.md)                              | Средний   | Этап 2      | Не начат |
| 4   | [Модификация Orchestrator](stage_4_orchestrator.md)                        | Средний   | Этап 3      | Не начат |
| 5   | [Тестирование и документация](stage_5_testing.md)                          | Высокий   | Этап 4      | Не начат |

---

## Краткое описание этапов

### Этап 1: Расширение ExtractedReactionParameters
**Цель:** Добавить классификацию запросов (`compound_data` vs `reaction_calculation`) и поддержку кастомного шага температуры.

**Ключевые изменения:**
- Новые поля в модели: `query_type`, `temperature_step_k`
- Обновление промпта `THERMODYNAMIC_EXTRACTION_PROMPT`
- Валидаторы согласованности данных
- Тесты классификации

**Файлы:**
- `src/thermo_agents/models/extraction.py`
- `src/thermo_agents/prompts.py`
- `tests/test_query_classification.py`

---

### Этап 2: Создание ThermodynamicCalculator
**Цель:** Перенести логику расчётов из Jupyter notebook в производственный код.

**Компоненты:**
- `ThermodynamicProperties` — свойства при одной температуре
- `ThermodynamicTable` — таблица по диапазону температур
- Методы расчёта: `calculate_cp()`, `calculate_properties()`, `generate_table()`
- Численное интегрирование (метод трапеций)

**Файлы:**
- `src/thermo_agents/calculations/thermodynamic_calculator.py` (новый)
- `tests/test_thermodynamic_calculator.py` (новый)

---

### Этап 3: Создание форматтеров
**Цель:** Реализовать специализированные форматтеры для двух типов запросов.

**Компоненты:**
- `CompoundDataFormatter` — вывод данных по веществам
- `ReactionCalculationFormatter` — вывод расчётов реакций
- Unicode-форматирование химических формул
- Таблицы с использованием `tabulate`

**Файлы:**
- `src/thermo_agents/formatting/compound_data_formatter.py` (новый)
- `src/thermo_agents/formatting/reaction_calculation_formatter.py` (новый)
- `tests/test_compound_data_formatter.py` (новый)
- `tests/test_reaction_calculation_formatter.py` (новый)

---

### Этап 4: Модификация Orchestrator
**Цель:** Добавить маршрутизацию запросов по типу с использованием форматтеров.

**Изменения:**
- Инициализация новых компонентов
- Маршрутизация в `process_query()`
- Методы `_process_compound_data()` и `_process_reaction_calculation()`
- Извлечение стехиометрии из уравнений

**Файлы:**
- `src/thermo_agents/orchestrator.py`
- `examples/compound_data_example.py` (новый)
- `examples/reaction_calculation_example.py` (новый)
- `tests/integration/test_output_formats.py` (новый)

---

### Этап 5: Тестирование и документация
**Цель:** Обеспечить полное покрытие тестами и актуальную документацию.

**Задачи:**
- Модульные и интеграционные тесты (покрытие > 80%)
- Performance-тесты (генерация таблицы < 100ms)
- Обновление документации (README, ARCHITECTURE, user guide)
- Проверка качества кода (ruff, mypy)
- Примеры использования

**Файлы:**
- `tests/integration/test_full_pipeline.py` (новый)
- `tests/performance/test_calculation_speed.py` (новый)
- `docs/user_guide.md` (новый)
- `docs/api_reference.md` (новый)
- `examples/custom_temperature_step.py` (новый)

---

## Порядок выполнения

### Фаза 1: Подготовка (Этапы 1-2)
1. Расширить модели и промпт
2. Создать калькулятор с переносом логики из notebook
3. Написать unit-тесты для калькулятора
4. Проверить совпадение результатов с notebook

### Фаза 2: Форматирование (Этап 3)
1. Реализовать оба форматтера
2. Добавить Unicode-поддержку
3. Протестировать форматирование таблиц
4. Создать snapshot-тесты

### Фаза 3: Интеграция (Этап 4)
1. Модифицировать Orchestrator
2. Реализовать маршрутизацию
3. Написать интеграционные тесты
4. Создать примеры использования

### Фаза 4: Финализация (Этап 5)
1. Достичь покрытия > 80%
2. Провести performance-тесты
3. Обновить всю документацию
4. Проверить код линтером и type checker
5. Создать релиз

---

## Метрики успеха

### Технические метрики
- ✅ Покрытие тестами > 80%
- ✅ Производительность: генерация таблицы 100 точек < 100ms
- ✅ Все тесты проходят (unit, integration, e2e)
- ✅ Код проходит ruff и mypy без ошибок

### Функциональные метрики
- ✅ Поддержка двух типов запросов
- ✅ Кастомный шаг температуры (25-250K)
- ✅ Вывод соответствует спецификации
- ✅ Unicode-символы корректно отображаются

### Документация
- ✅ README обновлён
- ✅ ARCHITECTURE обновлена
- ✅ User guide создан
- ✅ API reference создан
- ✅ Примеры работают

---

## Риски и митигация

### Риск 1: Ломающие изменения
**Проблема:** Добавление обязательных полей в `ExtractedReactionParameters` сломает старые тесты.

**Митигация:**
- Сделать `query_type` опциональным на переходный период
- Добавить автоматическое определение типа
- Обновить все тесты в рамках Этапа 1

### Риск 2: Производительность
**Проблема:** Численное интегрирование может быть медленным для больших таблиц.

**Митигация:**
- Использовать векторизацию NumPy
- Добавить кэширование результатов
- Провести benchmark-тесты в Этапе 5

### Риск 3: Unicode в консоли
**Проблема:** Подстрочные индексы могут некорректно отображаться в некоторых терминалах.

**Митигация:**
- Добавить fallback на обычные символы
- Документировать требования к терминалу
- Протестировать в Windows CMD, PowerShell, Linux terminals

---

## Дополнительные ресурсы

- [Спецификация форматов вывода (полная)](../output_spec.md)
- [Архитектура системы](../../ARCHITECTURE_V2.md)
- [Notebook с оригинальной логикой](../../сhlorination_of_tungsten.ipynb)

---

**Последнее обновление:** 18 октября 2025
