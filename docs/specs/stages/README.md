# Полная многофазная логика расчётов от 298K

## Обзор проекта

Данный документ содержит технические задания для реализации полной многофазной логики расчётов от 298K в системе ThermoSystem v2.1. Реализация основана на анализе проблемы из [`multiphases_spec.md`](../multiphases_spec.md) и лога сессии [`session_20251029_182252_ef6211.log`](../../logs/sessions/session_20251029_182252_ef6211.log).

### Исходная проблема

Текущая система использует температурный диапазон пользователя для фильтрации записей в базе данных, что приводит к:

- Потере критически важных данных (H₂₉₈, S₂₉₈)
- Некорректным термодинамическим расчётам
- Ошибкам типа "T выше максимальной температуры"
- Неполному использованию базы данных

**Пример:** FeO в диапазоне 773-973K использует запись с H₂₉₈ = 0.0 вместо корректной записи с H₂₉₈ = -265.053 кДж/моль.

### Цель реализации

Создать систему, которая:
1. **Игнорирует** пользовательский температурный диапазон для поиска данных
2. **Использует** максимально возможный диапазон из базы данных
3. **Автоматически переключается** между фазами (s→l→g)
4. **Учитывает** фазовые переходы с энтальпиями
5. **Показывает** пользователю весь расчётный диапазон

## Структура реализации

Реализация разбита на 7 последовательных этапов:

### [Этап 1: Модификация поиска и фильтрации данных](stage_01_search_modification.md)
**Статус:** Запланирован
**Длительность:** 3-4 дня
**Приоритет:** Критический

- Создание `TemperatureRangeResolver`
- Модификация `CompoundSearcher` для поиска всех записей
- Обновление `FilterPipeline` для игнорирования температурных ограничений
- Расширение моделей данных

**Ключевой результат:** FeO находит 6 записей вместо 1

### [Этап 2: Построение фазовых сегментов](stage_02_phase_segments.md)
**Статус:** Запланирован
**Длительность:** 4-5 дней
**Приоритет:** Критический
**Зависимости:** Этап 1

- Создание `PhaseSegmentBuilder`
- Расширение моделей `PhaseSegment`, `PhaseTransition`
- Обновление `PhaseResolver`
- Интеграция в `FilterPipeline`

**Ключевой результат:** Корректные сегменты [298-1650K]s, [1650-3687K]l, [3687-5000K]g

### [Этап 3: Автоматический выбор записей](stage_03_record_selection.md)
**Статус:** Запланирован
**Длительность:** 3-4 дня
**Приоритет:** Критический
**Зависимости:** Этапы 1-2

- Модификация `ThermodynamicCalculator` для множественных записей
- Создание `RecordTransitionManager`
- Обновление `RecordSelector`
- Интеграция в реакционные расчёты

**Ключевой результат:** Бесшовное переключение между записями с сохранением непрерывности

### [Этап 4: Интеграция фазовых переходов](stage_04_phase_transitions.md)
**Статус:** Запланирован
**Длительность:** 4-5 дней
**Приоритет:** Высокий
**Зависимости:** Этапы 1-3

- Расширение моделей фазовых переходов
- Создание `PhaseTransitionCalculator`
- Обновление `ThermodynamicCalculator` для учёта переходов
- Создание `TransitionDataManager`

**Ключевой результат:** Корректные скачки H и S в точках плавления/кипения

### [Этап 5: Обновление оркестратора и форматирования](stage_05_orchestrator_update.md)
**Статус:** Запланирован
**Длительность:** 3-4 дня
**Приоритет:** Высокий
**Зависимости:** Этапы 1-4

- Модификация `MultiPhaseOrchestrator`
- Обновление `ReactionCalculationFormatter`
- Создание `MultiPhaseReactionData`
- Обновление моделей данных

**Ключевой результат:** Вывод "Запрошенный: 773-973K, Расчётный: 298-5000K"

### [Этап 6: Тестирование и валидация](stage_06_testing_validation.md)
**Статус:** Запланирован
**Длительность:** 4-5 дней
**Приоритет:** Критический
**Зависимости:** Этапы 1-5

- Комплексное тестирование решения исходной проблемы
- Валидация термодинамической корректности
- Тестирование производительности
- Регрессионное тестирование

**Ключевой результат:** FeO использует H₂₉₈ = -265.053, система готова к продакшену

### [Этап 7: Удаление старой логики и рефакторинг](stage_07_legacy_removal.md)
**Статус:** Запланирован
**Длительность:** 3-4 дня
**Приоритет:** Критический
**Зависимости:** Этапы 1-6

- Аудит и удаление всех компонентов старой логики
- Переименование `MultiPhaseOrchestrator` в `ThermoOrchestrator`
- Обновление моделей данных и конфигураций
- Финальная чистка кодовой базы и документации

**Ключевой результат:** Чистая система без старой логики, только многофазный подход

## Временная шкала проекта

```mermaid
gantt
    title Реализация многофазной логики
    dateFormat  YYYY-MM-DD
    section Этапы
    Этап 1: Поиск и фильтрация     :done, stage1, 2024-01-01, 4d
    Этап 2: Фазовые сегменты      :done, stage2, after stage1, 5d
    Этап 3: Выбор записей         :done, stage3, after stage2, 4d
    Этап 4: Фазовые переходы      :done, stage4, after stage3, 5d
    Этап 5: Оркестратор           :done, stage5, after stage4, 4d
    Этап 6: Тестирование          :done, stage6, after stage5, 5d
    Этап 7: Удаление старой логики :active, stage7, after stage6, 4d
```

**Общая длительность:** 29-31 день
**Критический путь:** Этапы 1-7 (последовательные)
**Ресурсы:** 1 разработчик, 1 QA-инженер, архитектор (code review)

## Ожидаемые результаты

### Решение исходной проблемы

**Было (v2.1):**
```
FeO — Iron(II) oxide
  Фаза: s | T_применимости: 600-900 K
  H₂₉₈: 0.000 кДж/моль | S₂₉₈: 0.000 Дж/(моль·K)  ← НЕВЕРНО

| T(K) | ΔH°     | ΔS°    | ΔG°   | Комментарий                |
| ---- | ------- | ------ | ----- | -------------------------- |
| 773  | 12.68   | -97.38 | 87.95 | ← Некорректно из-за H₂₉₈=0 |
| 973  | Ошибка  |        |       | ← T выше максимальной     |
```

**Стало (v2.2):**
```
FeO — Iron(II) oxide
  Запрошенный диапазон: 773-973K
  Расчётный диапазон: 298-5000K (полное использование БД)
  Фазовые переходы: плавление при 1650K, кипение при 3687K
  H₂₉₈: -265.053 кДж/моль | S₂₉₈: 59.807 Дж/(моль·K)  ← ВЕРНО

| T(K) | ΔH°     | ΔS°    | ΔG°   | Фаза | Комментарий         |
| ---- | ------- | ------ | ----- | ---- | ------------------- |
| 298  | -33.45  | -45.23 | -19.97| s,g  | Стандартные условия |
| 773  | -28.12  | -42.11 | -4.58 | s,g  | ← Запрошенный диапазон|
| 1650 | -25.30  | -40.50 | +41.53| s→l  | Плавление FeO      |
| 5000 | -18.90  | -38.10 | +171.60| g,g  | Максимальная T      |
```

### Технические улучшения

1. **Полнота данных:** Используются все записи из базы (100% покрытие)
2. **Корректность:** H₂₉₈ и S₂₉₈ всегда корректны
3. **Многофазность:** Автоматические переходы s→l→g
4. **Надёжность:** Нет ошибок температурных границ
5. **Информативность:** Пользователь видит полный расчётный диапазон
6. **Чистота кода:** Полное удаление старой логики после Этапа 7
7. **Единый подход:** Только многофазная система без дублирования

### Метрики успеха

| Метрика | Целевое значение | Текущее значение |
|---------|-----------------|------------------|
| Корректность H₂₉₈ | 100% | ~70% |
| Покрытие данных | 100% | ~30% |
| Ошибки расчёта | 0 | 15-20% |
| Время ответа | ≤3с | 1-2с |
| Покрытие тестами | ≥85% | ~70% |
| Чистота кода | 100% (без старой логики) | ~50% (дублирование) |

## Риски и митигации

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Увеличение времени ответа | Средняя | Высокое | Кэширование, оптимизация |
| Сложность отладки | Низкая | Среднее | Детальное логирование |
| Обратная совместимость | Низкая | Высокое | Adapter pattern, fallback |
| Объём данных | Высокая | Среднее | Ленивая загрузка, фильтрация |

## Следующие шаги

1. **Начать реализацию Этапа 1** (модификация поиска и фильтрации)
2. **Настроить CI/CD** для автоматического тестирования
3. **Подготовить окружение** для разработки и тестирования
4. **Создать ветку разработки** `feature/multi-phase-logic`
5. **Провести code review** архитектурных решений

## Финальный результат

После успешного завершения всех 7 этапов:
- ✅ Исходная проблема полностью решена
- ✅ Система готова к продакшену
- ✅ Документация полная и актуальная
- ✅ Тесты обеспечивают качество
- ✅ Пользователи получают улучшенный сервис
- ✅ **Кодовая база чистая** - старая логика полностью удалена
- ✅ **Единый подход** - только многофазные расчёты
- ✅ **Лёгкость поддержки** - нет дублирования кода

**Версия системы:** ThermoSystem v2.2 (чистая многофазная)

## Контакты

- **Ведущий разработчик:** [Имя]
- **Архитектор:** [Имя]
- **QA-инженер:** [Имя]
- **Менеджер проекта:** [Имя]

---

**Статус проекта:** Готов к реализации
**Версия документа:** 1.0
**Дата обновления:** 29 октября 2025
**Следующий этап:** Реализация Этапа 1