# Техническое задание: Полная многофазная логика расчётов от 298K

## 1. Введение

### 1.1. Контекст проекта

ThermoSystem — высокопроизводительная система термодинамических агентов для расчёта химических реакций и свойств веществ. Система работает с базой данных, содержащей термодинамические свойства веществ в различных агрегатных состояниях (твёрдое, жидкое, газообразное).

**Текущее состояние:** Версия 2.2 с реализованной многофазной архитектурой, но **критические проблемы в реализации** приводят к тому, что система фактически использует старую логику.

**Проблема:** Несмотря на наличие многофазных компонентов (PhaseSegmentBuilder, MultiPhaseReactionCalculator), система продолжает использовать температурный диапазон пользователя для фильтрации записей, что приводит к потере критически важных данных (H₂₉₈, S₂₉₈).

**❌ КРИТИЧЕСКАЯ ПРОБЛЕМА (Октябрь 2025):**
- В `orchestrator.py:501, 521-525` используется `params.temperature_range_k` для фильтрации
- `FilterPipeline` сохраняет температурную фильтрацию вопреки ТЗ
- Система выбирает записи с H₂₉₈ = 0.0 вместо корректных значений из других диапазонов
- Отсутствует интеграция многофазных компонентов в основной поток

См. детальный анализ в [`stage_08_bug_fixes.md`](stages/stage_08_bug_fixes.md).

### 1.2. Цель документа

Данное техническое задание определяет требования и архитектурные решения для реализации **полной многофазной логики расчётов**, которая:

1. **Игнорирует пользовательский температурный диапазон** для целей поиска данных
2. **Использует максимально возможный диапазон** на основе всех доступных записей в базе данных
3. **Автоматически переключается между фазами** (s→l→g) в процессе расчёта
4. **Учитывает фазовые переходы** с интеграцией энтальпий плавления и кипения
5. **Показывает пользователю весь расчётный диапазон**, информируя его о максимальном использовании данных из базы

### 1.3. Область применения

Документ предназначен для:
- Разработчиков, реализующих многофазную логику
- Архитекторов системы для понимания общей концепции
- Тестировщиков для разработки тестовых сценариев
- Технических писателей для обновления документации

**Затрагиваемые компоненты:**
- `CompoundSearcher` — поиск всех записей вещества без температурных ограничений
- `FilterPipeline` — модификация логики фильтрации для многофазных расчётов
- `PhaseResolver` — определение активных фаз и точек переходов
- `ThermodynamicCalculator` — интеграция фазовых переходов в расчёты
- `ReactionCalculationFormatter` — вывод полного температурного диапазона
- `MultiPhaseOrchestrator` — координация всех компонентов

**Не входит в область:**
- Обратная совместимость со старой логикой (старый код будет удалён)
- Оптимизация производительности (будет выполнена на следующем этапе)
- Изменение структуры базы данных

## 2. Проблематика текущей системы

### 2.1. Описание проблемы

Текущая версия системы (v2.1) использует температурный диапазон из запроса пользователя для фильтрации записей в базе данных. Это приводит к следующим критическим проблемам:

**Проблема №1: Потеря базовых термодинамических данных**
- В базе данных H₂₉₈ и S₂₉₈ содержатся только в записях, покрывающих 298K
- Если пользователь запрашивает диапазон 500-700°C (773-973K), запись с диапазоном 298-600K отбрасывается
- Вместо неё используется запись с диапазоном 600-900K, где H₂₉₈ = 0.0 и S₂₉₈ = 0.0
- Расчёты становятся некорректными из-за отсутствия базовых значений

**Проблема №2: Неполное использование базы данных**
- База содержит множество записей для одного вещества в разных фазах и температурных диапазонах
- Система выбирает только одну "наиболее подходящую" запись
- Остальные записи игнорируются, хотя содержат ценную информацию

**Проблема №3: Отсутствие учёта фазовых переходов**
- При переходе через температуру плавления или кипения система не учитывает энтальпию перехода
- Расчёты H(T) и G(T) становятся физически некорректными

**Проблема №4: Ошибки на границах диапазонов**
- Если температура выходит за границы выбранной записи, расчёт прерывается с ошибкой
- Пример из теста: "T=973.0K выше максимальной температуры 900K"

### 2.2. Анализ тестового запроса

**Запрос пользователя:**
```
Реагирует ли сероводород с оксидом железа(II) при температуре 500–700 °C?
```

**Извлечённые параметры:**
- Уравнение: `FeO + H₂S → FeS + H₂O`
- Температурный диапазон: 773-973K (500-700°C)
- Шаг: 100K

**Проблема с FeO:**

Записи в базе данных:
```
| formula | phase | tmin   | tmax | h298     | s298   |
| ------- | ----- | ------ | ---- | -------- | ------ |
| FeO     | s     | 298.15 | 600  | -265.053 | 59.807 | ← Содержит H₂₉₈, S₂₉₈  |
| FeO     | s     | 600    | 900  | 0.0 ❌    | 0.0 ❌  | ← Используется система |
| FeO     | s     | 900    | 1300 | 0.0 ❌    | 0.0 ❌  |
```

**Что происходит:**
1. Система фильтрует по диапазону 773-973K
2. Выбирается запись 600-900K (так как покрывает 773-900K)
3. H₂₉₈ = 0.0, S₂₉₈ = 0.0 — **некорректные данные**
4. При T=973K выход за границу → **ошибка расчёта**

**Вывод системы:**
```
FeO — Iron(II) oxide
  Фаза: s | T_применимости: 600-900 K
  H₂₉₈: 0.000 кДж/моль | S₂₉₈: 0.000 Дж/(моль·K)  ← ❌ НЕВЕРНО
  
| T(K) | ΔH°                                                     | ΔS°    | ΔG°   | Комментарий                |
| ---- | ------------------------------------------------------- | ------ | ----- | -------------------------- |
| 773  | 12.68                                                   | -97.38 | 87.95 | ← Некорректно из-за H₂₉₈=0 |
| 873  | 12.75                                                   | -97.29 | 97.69 | ← Некорректно из-за H₂₉₈=0 |
| 973  | Ошибка: T=973.0K выше максимальной температуры 900K ← ❌ |
```

### 2.3. Корневая причина ошибок

**Архитектурная причина:**
Текущая система использует **температурный диапазон пользователя** как критерий фильтрации записей в `FilterPipeline`, что противоречит структуре базы данных.

**Структура базы данных требует другого подхода:**
1. Базовые термодинамические свойства (H₂₉₈, S₂₉₈) заполняются **только** в записи, покрывающей 298K
2. Остальные записи содержат **только коэффициенты Шомейта** для расчёта Cp(T)
3. Для корректного расчёта необходимо:
   - Начинать с 298K (чтобы иметь H₂₉₈, S₂₉₈)
   - Использовать **все** записи последовательно
   - Переключаться между записями при изменении фазы

**Компоненты, требующие модификации:**

| Компонент                      | Текущее поведение                      | Требуемое поведение                                      |
| ------------------------------ | -------------------------------------- | -------------------------------------------------------- |
| `CompoundSearcher`             | Поиск по формуле                       | Поиск **всех** записей без фильтрации                    |
| `FilterPipeline`               | Фильтрация по температуре пользователя | Выбор всех записей, формирование фазовых сегментов       |
| `PhaseResolver`                | Определение одной фазы                 | Построение карты фазовых переходов                       |
| `ThermodynamicCalculator`      | Расчёт по одной записи                 | Расчёт с переключением между записями и учётом переходов |
| `ReactionCalculationFormatter` | Вывод пользовательского диапазона      | Вывод полного расчётного диапазона                       |

### 2.4. Структура базы данных

**Типичная структура записей для одного вещества:**

```sql
SELECT Formula, Phase, Tmin, Tmax, H298, S298, f1, f2, f3, f4, f5, f6, MeltingPoint, BoilingPoint
FROM compounds
WHERE Formula LIKE 'FeO%'
ORDER BY Phase, Tmin;
```

**Результат:**
```
| Formula | Phase | Tmin   | Tmax | H298     | S298   | f1    | f2   | f3    | MeltingPoint | BoilingPoint |
| ------- | ----- | ------ | ---- | -------- | ------ | ----- | ---- | ----- | ------------ | ------------ |
| FeO     | s     | 298.15 | 600  | -265.053 | 59.807 | 50.28 | 3.65 | -1.94 | 1650         | 3687         |
| FeO     | s     | 600    | 900  | 0.0      | 0.0    | 55.5  | 2.0  | -1.0  | 1650         | 3687         |
| FeO     | s     | 900    | 1300 | 0.0      | 0.0    | 52.0  | 1.5  | -0.8  | 1650         | 3687         |
| FeO     | l     | 1650   | 5000 | -254.106 | 54.365 | 60.0  | 0.0  | 0.0   | 1650         | 3687         |
| FeO     | g     | 298.17 | 400  | 251.040  | 241.92 | 28.69 | 4.69 | -0.81 | 1650         | 3687         |
| FeO     | g     | 400    | 2100 | 0.0      | 0.0    | 32.51 | 2.1  | -1.5  | 1650         | 3687         |
```

**ВАЖНО:** Названия полей в базе данных:
- Таблица: `compounds` (не `thermo_data`)
- Поля: `Formula`, `Phase`, `Tmin`, `Tmax`, `H298`, `S298` (PascalCase, не snake_case)
- Температуры переходов: `MeltingPoint`, `BoilingPoint` (не `tmelt`, `tboil`)

**Ключевые наблюдения:**

1. **H₂₉₈ и S₂₉₈ заполнены только в первой записи каждой фазы**, покрывающей стандартную температуру
   - Для твёрдой фазы (s): в записи 298.15-600K
   - Для газовой фазы (g): в записи 298.17-400K
   - Для жидкой фазы (l): в записи, начинающейся с MeltingPoint

2. **Температуры переходов (MeltingPoint, BoilingPoint) одинаковы** во всех записях
   - MeltingPoint = 1650K (температура плавления)
   - BoilingPoint = 3687K (температура кипения)

3. **Коэффициенты Шомейта (f1-f6) различаются** в каждом температурном диапазоне
   - Отражают изменение теплоёмкости в данном диапазоне

4. **Фазы определяются по температуре:**
   - T < 1650K → твёрдое (s)
   - 1650K ≤ T < 3687K → жидкое (l)
   - T ≥ 3687K → газ (g)

5. **КРИТИЧНО: Энтальпии фазовых переходов НЕ ХРАНЯТСЯ в базе данных**
   - Полей `h_fusion`, `h_vaporization` в БД **НЕТ**
   - Энтальпии переходов нужно **рассчитывать** из разницы H₂₉₈ разных фаз
   - Это **приближение**, так как H₂₉₈ — это энтальпии **образования**, а не абсолютные значения

### 2.5. Последствия текущей логики

**Для пользователя:**
- Получение некорректных результатов без предупреждения
- Ошибки расчёта на границах температурных диапазонов
- Невозможность использовать полный потенциал базы данных

**Для разработчиков:**
- Сложность отладки из-за неявной зависимости от температурного диапазона
- Необходимость ручного вмешательства для корректных расчётов
- Множество граничных случаев в коде

**Для системы:**
- Физически некорректные расчёты (нарушение законов термодинамики)
- Потеря доверия пользователей к результатам
- Невозможность масштабирования на более сложные задачи

**Пример некорректного расчёта:**

При H₂₉₈ = 0 и S₂₉₈ = 0:
```
H(773K) = 0 + ∫₂₉₈⁷⁷³ Cp(T)dT  ← Интегрирование от 298K, но H₂₉₈ = 0 ❌
S(773K) = 0 + ∫₂₉₈⁷⁷³ [Cp(T)/T]dT  ← S₂₉₈ = 0, расчёт некорректен ❌
```

**Физически корректно должно быть:**
```
H(773K) = H₂₉₈ + ∫₂₉₈⁷⁷³ Cp(T)dT  ← H₂₉₈ = -265.053 кДж/моль ✓
S(773K) = S₂₉₈ + ∫₂₉₈⁷⁷³ [Cp(T)/T]dT  ← S₂₉₈ = 59.807 Дж/(моль·K) ✓
```

## 3. Цели и требования

### 3.1. Основные цели

**Цель 1: Гарантированная корректность термодинамических расчётов**
- Всегда использовать базовые значения H₂₉₈ и S₂₉₈ из записи, покрывающей 298K
- Обеспечить физическую корректность расчётов согласно законам термодинамики
- Исключить ситуации с нулевыми или отсутствующими базовыми данными

**Цель 2: Максимальное использование базы данных**
- Использовать все доступные записи для вещества
- Расчёт от минимальной до максимальной температуры в совокупном диапазоне всех записей
- Автоматическое переключение между записями при изменении фазы

**Цель 3: Автоматическая обработка многофазных систем**
- Определение фазовых переходов (плавление, кипение, сублимация)
- Учёт энтальпий фазовых переходов в расчётах
- Построение непрерывной зависимости свойств от температуры через все фазы

**Цель 4: Информирование пользователя**
- Показывать полный расчётный диапазон температур
- Указывать использованные фазы и точки переходов
- Сообщать о максимальном использовании доступных данных

**Цель 5: Упрощение архитектуры**
- Удалить зависимость от пользовательского температурного диапазона
- Унифицировать логику для всех типов запросов
- Снизить количество граничных случаев

### 3.2. Функциональные требования

**FR-1: Автоматическое определение температурного диапазона**
- **ID:** FR-1
- **Приоритет:** Критический
- **Описание:** Система должна автоматически определять температурный диапазон для расчётов на основе всех доступных записей в базе данных, игнорируя диапазон, указанный пользователем.

**Алгоритм:**
1. Для каждого вещества найти все записи в базе данных (без фильтрации по температуре)
2. Определить min_temp = min(tmin) среди всех записей всех веществ реакции
3. Определить max_temp = max(tmax) среди всех записей всех веществ реакции
4. Если min_temp > 298K, использовать min_temp; иначе использовать 298K
5. Использовать диапазон [start_temp, max_temp] для расчётов

**Критерий приёмки:**
- Расчёт всегда начинается с температуры, обеспечивающей доступ к H₂₉₈ и S₂₉₈
- Расчёт продолжается до максимальной доступной температуры в базе

**❌ ТЕКУЩИЙ СТАТУС:** **НЕ РЕАЛИЗОВАНО**
- `orchestrator.py:501` использует `params.temperature_range_k[1]` вместо автоопределения
- Система не выполняет алгоритм определения общего диапазона

---

**FR-2: Построение фазовых сегментов**
- **ID:** FR-2
- **Приоритет:** Критический
- **Описание:** Для каждого вещества система должна построить последовательность фазовых сегментов с учётом температур переходов.

**Алгоритм:**
1. Получить все записи вещества, упорядоченные по tmin
2. Извлечь tmelt и tboil из любой записи (они одинаковы)
3. Разбить общий диапазон на сегменты:
   - Сегмент 1: [start_temp, tmelt) — твёрдая фаза (s)
   - Точка перехода: tmelt — плавление (s→l)
   - Сегмент 2: [tmelt, tboil) — жидкая фаза (l)
   - Точка перехода: tboil — кипение (l→g)
   - Сегмент 3: [tboil, max_temp] — газовая фаза (g)
4. Для каждого сегмента выбрать соответствующие записи из базы

**Критерий приёмки:**
- Построены корректные фазовые сегменты для всех веществ
- Точки переходов определены и зафиксированы
- Каждому сегменту сопоставлена правильная фаза

**✅ ТЕКУЩИЙ СТАТУС:** **РЕАЛИЗОВАНО**
- `PhaseSegmentBuilder` существует и работает корректно
- `build_compound_data()` создаёт многофазные сегменты
- **❌ ПРОБЛЕМА:** Не интегрирован в основной поток `orchestrator.py`

---

**FR-3: Автоматический выбор записей для каждого сегмента**
- **ID:** FR-3
- **Приоритет:** Критический
- **Описание:** Для каждого фазового сегмента система должна автоматически выбирать записи с правильной фазой и покрывающие температурный диапазон сегмента.

**Алгоритм:**
1. Для сегмента [T_start, T_end] с фазой P:
2. Выбрать все записи, где:
   - `phase == P`
   - `tmin <= T_start < tmax` ИЛИ `tmin < T_end <= tmax` ИЛИ `[tmin, tmax]` полностью покрывает `[T_start, T_end]`
3. Упорядочить записи по tmin
4. Если в диапазоне несколько записей, они будут переключаться последовательно

**Критерий приёмки:**
- Для каждой температуры в сегменте используется корректная запись
- Переключение между записями происходит автоматически и без разрывов

---

**FR-4: Интеграция энтальпий фазовых переходов**
- **ID:** FR-4
- **Приоритет:** Высокий
- **Описание:** При расчёте H(T) система должна учитывать энтальпии плавления (ΔH_fusion) и кипения (ΔH_vaporization) в точках переходов.

**Метод расчёта:**
1. Извлечь ΔH_fusion и ΔH_vaporization из базы данных (если доступно)
2. При переходе s→l в точке T_melt:
   ```
   H(T_melt, l) = H(T_melt, s) + ΔH_fusion
   ```
3. При переходе l→g в точке T_boil:
   ```
   H(T_boil, g) = H(T_boil, l) + ΔH_vaporization
   ```
4. Если ΔH недоступны, рассчитать разницу между H₂₉₈ разных фаз

**Критерий приёмки:**
- Скачок энтальпии в точках переходов корректно учитывается
- Расчёт ΔG учитывает вклад фазовых переходов

---

**FR-5: Последовательный расчёт через все фазы**
- **ID:** FR-5
- **Приоритет:** Критический
- **Описание:** Расчёт термодинамических свойств должен выполняться последовательно от начальной температуры через все фазы до конечной температуры.

**Алгоритм:**
1. Начать с базовых значений H₂₉₈, S₂₉₈ из первой записи
2. Для каждого температурного шага T:
   - Определить текущий фазовый сегмент
   - Выбрать соответствующую запись из базы
   - Рассчитать Cp(T) по коэффициентам Шомейта
   - Интегрировать для получения H(T), S(T)
   - При пересечении точки перехода добавить ΔH_transition
3. Рассчитать G(T) = H(T) - T·S(T)
4. Для реакций: ΔH_rxn = Σ H_продукты - Σ H_реагенты

**Критерий приёмки:**
- Расчёт корректен для всех температур в диапазоне
- Фазовые переходы учтены без ошибок
- Результаты физически непротиворечивы

---

**FR-6: Вывод полного температурного диапазона**
- **ID:** FR-6
- **Приоритет:** Средний
- **Описание:** В результатах пользователю должен показываться полный расчётный диапазон с указанием использованных фаз.

**Формат вывода:**
```
Запрошенный диапазон: 500-700°C (773-973K)
Расчётный диапазон: 298-2100K (максимальное использование базы данных)

Данные веществ:
FeO — Iron(II) oxide
  Общий диапазон: 298-5000K
  Фазовые переходы:
    - Плавление при 1650K
    - Кипение при 3687K
  Использованные фазы: s (298-1650K), l (1650-3687K)
```

**Критерий приёмки:**
- Пользователь информирован о полном расчётном диапазоне
- Указаны использованные фазы и переходы
- Явно указано, что использована вся доступная информация из базы

**❌ ТЕКУЩИЙ СТАТУС:** **ЧАСТИЧНО РЕАЛИЗОВАНО**
- `format_response()` существует, но показывает только пользовательский диапазон
- **❌ ПРОБЛЕМА:** Не используется `format_multi_phase_response()`

---

**FR-7: Игнорирование пользовательского диапазона**
- **ID:** FR-7
- **Приоритет:** Критический
- **Описание:** Температурный диапазон из запроса пользователя НЕ должен использоваться для фильтрации записей в базе данных. Он используется только для информирования пользователя.

**Поведение:**
- LLM извлекает `temperature_range_k` из запроса
- Параметр сохраняется в `ExtractedReactionParameters`
- **НЕ** передаётся в `CompoundSearcher` для фильтрации
- **НЕ** используется в `FilterPipeline` для отбора записей
- Используется ТОЛЬКО в форматтере для пометки "запрошенный диапазон"

**❌ ТЕКУЩИЙ СТАТУС:** **КРИТИЧЕСКИ НЕ РЕАЛИЗОВАНО**
- `orchestrator.py:501, 521-525` использует `params.temperature_range_k` для фильтрации
- `FilterPipeline` сохраняет температурные ограничения
- Система активно фильтрует записи по пользовательскому диапазону

---

### 3.3. Нефункциональные требования

**NFR-1: Производительность**
- Время выполнения полного расчёта: не более 3 секунд (включая LLM)
- Время построения фазовых сегментов: не более 100мс на вещество
- Кэширование результатов для повторных запросов

**NFR-2: Надёжность**
- Корректная обработка отсутствующих данных (ΔH_transition, некоторых коэффициентов)
- Graceful degradation при неполных данных
- Валидация всех входных данных из базы

**NFR-3: Сопровождаемость**
- Чёткое разделение ответственности между компонентами
- Подробное логирование всех этапов построения фазовых сегментов
- Понятные сообщения об ошибках

**NFR-4: Тестируемость**
- Модульные тесты для каждого компонента
- Интеграционные тесты для полного цикла
- Регрессионные тесты с реальными данными из базы

**NFR-5: Документированность**
- Обновление ARCHITECTURE.md с описанием новой логики
- Примеры в user_guide.md
- Code comments для сложных алгоритмов

### 3.4. Критерии успеха

**Критерий 1: Корректность данных**
- ✓ Все расчёты используют корректные H₂₉₈ и S₂₉₈ из базы данных
- ✓ Отсутствуют случаи с H₂₉₈ = 0 или S₂₉₈ = 0 (если данные есть в базе)
- ✓ Все термодинамические законы соблюдаются

**Критерий 2: Полнота использования базы**
- ✓ Для каждого вещества используются все доступные записи
- ✓ Расчётный диапазон = максимально возможный на основе базы
- ✓ Ни одна полезная запись не отбрасывается

**Критерий 3: Многофазная логика**
- ✓ Автоматическое переключение между фазами (s→l→g)
- ✓ Учёт фазовых переходов с энтальпиями
- ✓ Непрерывность расчётов через все фазы

**Критерий 4: Устранение ошибок**
- ✓ Отсутствие ошибок типа "T выше максимальной температуры"
- ✓ Расчёты выполняются до конца без прерываний
- ✓ Все тестовые запросы выполняются корректно

**Критерий 5: Удаление старого кода**
- ✓ Удалён код, зависящий от пользовательского температурного диапазона
- ✓ Упрощена архитектура FilterPipeline
- ✓ Уменьшено количество граничных случаев

**Метрики успеха:**
- 100% тестовых запросов выполняются без ошибок
- 0 случаев с H₂₉₈ = 0 при наличии данных в базе
- Покрытие кода тестами ≥ 85%
- Время выполнения запроса ≤ 3 секунды

## 4. Архитектурные решения

### 4.1. Концепция полного температурного диапазона

**Ключевая идея:** Независимо от запроса пользователя, система всегда выполняет расчёт в **максимально доступном температурном диапазоне** на основе данных из базы.

**Принцип работы:**
```
Запрос пользователя: "FeO + H₂S при 500-700°C"
                              ↓
        LLM извлекает: temperature_range_k = [773, 973]
                              ↓
        [ИГНОРИРУЕТСЯ для поиска и фильтрации]
                              ↓
Поиск ВСЕХ записей для FeO, H₂S, FeS, H₂O без ограничений
                              ↓
    Определение общего диапазона: [298, 2500] K
                              ↓
            Расчёт от 298K до 2500K
                              ↓
    Вывод: "Расчётный диапазон: 298-2500K (полное использование БД)"
           "Запрошенный диапазон: 773-973K (для справки)"
```

**Обоснование:**
1. **Физическая корректность:** H(T) и S(T) рассчитываются от стандартной температуры 298K
2. **Максимум информации:** Используются все доступные данные из базы
3. **Отсутствие артефактов:** Нет зависимости результата от формулировки запроса
4. **Предсказуемость:** Одинаковый результат для одной реакции независимо от запроса

### 4.2. Автоматическое определение диапазона

**Алгоритм определения температурного диапазона:**

```python
def determine_temperature_range(compounds_data: Dict[str, List[DatabaseRecord]]) -> Tuple[float, float]:
    """
    Определить общий температурный диапазон для всех веществ реакции.
    
    Args:
        compounds_data: Словарь {formula: [records]}
    
    Returns:
        (start_temp, end_temp) в Кельвинах
    """
    all_tmin = []
    all_tmax = []
    
    # Собрать все границы температур
    for formula, records in compounds_data.items():
        for record in records:
            all_tmin.append(record.tmin)
            all_tmax.append(record.tmax)
    
    # Найти пересечение диапазонов
    start_temp = max(all_tmin)  # Максимум из минимумов
    end_temp = min(all_tmax)    # Минимум из максимумов
    
    # Расширить до 298K, если возможно
    if start_temp > 298.15:
        # Проверить, есть ли у всех веществ записи, покрывающие 298K
        can_use_298 = all(
            any(r.tmin <= 298.15 <= r.tmax for r in records)
            for records in compounds_data.values()
        )
        if can_use_298:
            start_temp = 298.15
    
    return (start_temp, end_temp)
```

**Стратегия определения диапазона:**

1. **Максимальное пересечение:** Найти диапазон, который покрывается всеми веществами
2. **Приоритет 298K:** Если возможно, начинать с 298K для доступа к H₂₉₈/S₂₉₈
3. **Расширение до max:** Использовать максимально доступную верхнюю границу

**Примеры:**

```
Пример 1: Все вещества покрывают 298-2000K
→ Диапазон расчёта: [298, 2000] K

Пример 2: 
  FeO: 298-5000K
  H₂S: 298-2500K
  FeS: 598-1465K
  H₂O: 600-1600K
→ Диапазон расчёта: [598, 1465] K (пересечение)

Пример 3 (с расширением):
  FeO: 298-2000K, 600-5000K
  H₂S: 298-2500K
→ Проверяем покрытие 298K: FeO (✓), H₂S (✓)
→ Диапазон расчёта: [298, 2000] K
```

### 4.3. Многофазная логика

**Концепция:** Автоматическое построение последовательности фазовых сегментов для каждого вещества с переключением между записями базы данных.

**Структура многофазных данных:**

```
Вещество: FeO
Температурный диапазон: 298-3700K
Температуры переходов: T_melt=1650K, T_boil=3687K

Фазовые сегменты:
┌─────────────────────────────────────────────────────────┐
│ Сегмент 1: Твёрдая фаза (s)                             │
│ Диапазон: [298, 1650) K                                 │
│ Записи:                                                 │
│   - Record 1: 298-600K (H₂₉₈=-265.053, S₂₉₈=59.807)   │
│   - Record 2: 600-900K                                  │
│   - Record 3: 900-1300K                                 │
│   - Record 4: 1300-1650K                                │
├─────────────────────────────────────────────────────────┤
│ Переход: Плавление при 1650K                           │
│ ΔH_fusion = 31.5 кДж/моль (из базы или расчёт)        │
├─────────────────────────────────────────────────────────┤
│ Сегмент 2: Жидкая фаза (l)                              │
│ Диапазон: [1650, 3687) K                                │
│ Записи:                                                 │
│   - Record 5: 1650-5000K (l)                            │
├─────────────────────────────────────────────────────────┤
│ Переход: Кипение при 3687K                             │
│ ΔH_vaporization = 340.0 кДж/моль                       │
├─────────────────────────────────────────────────────────┤
│ Сегмент 3: Газовая фаза (g)                             │
│ Диапазон: [3687, 3700] K                                │
│ Записи:                                                 │
│   - Record 6: 400-2100K (g)                             │
└─────────────────────────────────────────────────────────┘
```

**Алгоритм построения сегментов:**

```python
def build_phase_segments(
    records: List[DatabaseRecord],
    temp_range: Tuple[float, float]
) -> List[PhaseSegment]:
    """
    Построить фазовые сегменты для вещества.
    
    Args:
        records: Все записи вещества из базы
        temp_range: Общий температурный диапазон (start, end)
    
    Returns:
        Список фазовых сегментов с переходами
    """
    # Извлечь температуры переходов (одинаковы во всех записях)
    tmelt = records[0].tmelt
    tboil = records[0].tboil
    
    start_temp, end_temp = temp_range
    segments = []
    
    # Сегмент 1: Твёрдая фаза (если start_temp < tmelt)
    if start_temp < tmelt:
        solid_records = [r for r in records if r.phase == 's']
        solid_records.sort(key=lambda r: r.tmin)
        
        segments.append(PhaseSegment(
            phase='s',
            temp_start=start_temp,
            temp_end=min(tmelt, end_temp),
            records=solid_records,
            transition_at_end=('melting', tmelt) if end_temp >= tmelt else None
        ))
    
    # Сегмент 2: Жидкая фаза (если диапазон покрывает [tmelt, tboil))
    if start_temp < tboil and end_temp > tmelt:
        liquid_records = [r for r in records if r.phase == 'l']
        liquid_records.sort(key=lambda r: r.tmin)
        
        segments.append(PhaseSegment(
            phase='l',
            temp_start=max(tmelt, start_temp),
            temp_end=min(tboil, end_temp),
            records=liquid_records,
            transition_at_start=('melting', tmelt) if start_temp < tmelt else None,
            transition_at_end=('boiling', tboil) if end_temp >= tboil else None
        ))
    
    # Сегмент 3: Газовая фаза (если end_temp >= tboil)
    if end_temp >= tboil:
        gas_records = [r for r in records if r.phase == 'g']
        gas_records.sort(key=lambda r: r.tmin)
        
        segments.append(PhaseSegment(
            phase='g',
            temp_start=max(tboil, start_temp),
            temp_end=end_temp,
            records=gas_records,
            transition_at_start=('boiling', tboil) if start_temp < tboil else None
        ))
    
    return segments
```

### 4.4. Учёт фазовых переходов

**Типы фазовых переходов:**

1. **Плавление (s→l):** Твёрдое → Жидкое при T_melt
2. **Кипение (l→g):** Жидкое → Газ при T_boil
3. **Сублимация (s→g):** Твёрдое → Газ напрямую (редко, например CO₂)

**Термодинамика фазовых переходов:**

При фазовом переходе при температуре T_trans:
```
ΔH_trans = H(фаза2, T_trans) - H(фаза1, T_trans)
ΔS_trans = ΔH_trans / T_trans  (при равновесии ΔG = 0)
```

**Интеграция в расчёты:**

Для энтальпии H(T):
```
H(T) = H₂₉₈ + ∫₂₉₈ᵀ Cp(T')dT'  (без переходов)

С учётом перехода при T_melt:
H(T > T_melt) = H₂₉₈ + ∫₂₉₈^T_melt Cp_solid(T')dT' 
                     + ΔH_fusion
                     + ∫_T_melt^T Cp_liquid(T')dT'
```

Для энтропии S(T):
```
S(T > T_melt) = S₂₉₈ + ∫₂₉₈^T_melt [Cp_solid(T')/T']dT'
                     + ΔH_fusion/T_melt
                     + ∫_T_melt^T [Cp_liquid(T')/T']dT'
```

**Источники данных о переходах:**

1. **Из базы данных:** Поля `h_fusion`, `h_vaporization` (если доступны)
2. **Расчёт из H₂₉₈ разных фаз:**
   ```
   ΔH_fusion ≈ H₂₉₈(l) - H₂₉₈(s)  (приближение)
   ```
3. **Эвристические значения:** На основе типа вещества (металлы, соли, молекулярные)

### 4.5. Игнорирование пользовательского диапазона

**Важно:** Температурный диапазон из запроса пользователя используется ТОЛЬКО для информирования, но НЕ для фильтрации данных.

**Обработка на разных уровнях:**

| Компонент                      | Использование `temperature_range_k`     |
| ------------------------------ | --------------------------------------- |
| `ThermodynamicAgent` (LLM)     | ✓ Извлекает из текста запроса           |
| `ExtractedReactionParameters`  | ✓ Сохраняет для передачи                |
| `MultiPhaseOrchestrator`       | ○ Игнорирует при поиске                 |
| `CompoundSearcher`             | ✗ НЕ получает как параметр              |
| `FilterPipeline`               | ✗ НЕ использует для фильтрации          |
| `ThermodynamicCalculator`      | ✗ Использует автоопределённый диапазон  |
| `ReactionCalculationFormatter` | ✓ Показывает "Запрошенный vs Расчётный" |

**Пример информирования пользователя:**

```
================================================================================
⚗️ Термодинамический расчёт реакции
================================================================================

Уравнение: FeO + H₂S → FeS + H₂O

Запрошенный диапазон: 500-700°C (773-973K)
Расчётный диапазон: 298-2100K 

ℹ️  ИНФОРМАЦИЯ: Для обеспечения корректности расчёт выполнен в максимально
    доступном диапазоне на основе данных из базы. Это гарантирует использование
    базовых термодинамических свойств (H₂₉₈, S₂₉₈) и учёт фазовых переходов.

Данные веществ:
[...]

Результаты расчёта:
| T(K) | ΔH° (кДж/моль) | ΔS° (Дж/К·моль) | ΔG° (кДж/моль) | Фаза | Комментарий         |
| ---- | -------------- | --------------- | -------------- | ---- | ------------------- |
| 298  | -33.45         | -45.23          | -19.97         | s,g  | Стандартные условия |
[...]
773   | -28.12         | -42.11          | -4.58          | s,g            | ← Запрошенный диапазон
873   | -27.85         | -41.98          | -1.21          | s,g            |
973   | -27.60         | -41.87          | +1.12          | s,g            | ← Запрошенный диапазон
[...]
1650  | -25.30         | -40.50          | +41.53         | s→l transition | Плавление FeO
[...]
2100  | -23.10         | -39.85          | +60.59         | l,g            |
================================================================================
`