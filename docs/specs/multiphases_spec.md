# Техническое задание: Полная многофазная логика расчётов от 298K

## 1. Введение

### 1.1. Контекст проекта

ThermoSystem — высокопроизводительная система термодинамических агентов для расчёта химических реакций и свойств веществ. Система работает с базой данных, содержащей термодинамические свойства веществ в различных агрегатных состояниях (твёрдое, жидкое, газообразное).

**Текущее состояние:** Версия 2.2 с реализованной многофазной архитектурой, но **критические проблемы в реализации** приводят к тому, что система фактически не использует многофазные возможности.

**❌ ОСНОВНАЯ ПРОБЛЕМА (Октябрь 2025):**
- **Агрессивная дедупликация** удаляет 97-99% записей (Al₂O₃: 84→1 запись)
- **Поиск по formula** теряет полиморфные формы (не находит Al₂O₃(C), Al₂O₃(D) и т.д.)
- **Многофазные компоненты** (PhaseSegmentBuilder) существуют, но не интегрированы в основной поток
- **Потеря данных** делает невозможным многофазные расчёты

**Пример из актуальных логов:**
```
Al₂O₃: найдено 84 записей → после дедупликации: 1 запись (98.8% удалено)
CaF₂: найдено 69 записей → после дедупликации: 1 запись (98.6% удалено)
Остаются только записи с H298=0, S298=0
```

См. детальный анализ в [`code_review_multiphase_analysis.md`](code_review_multiphase_analysis.md).

### 1.2. Цель документа

Данное техническое задание определяет требования и архитектурные решения для реализации **полной многофазной логики расчётов**, которая:

1. **Игнорирует пользовательский температурный диапазон** для целей поиска данных
2. **Использует максимально возможный диапазон** на основе всех доступных записей в базе данных
3. **Автоматически переключается между фазами** (s→l→g) в процессе расчёта
4. **Учитывает фазовые переходы** с интеграцией энтальпий плавления и кипения
5. **Показывает пользователю весь расчётный диапазон**, информируя его о максимальном использовании данных из базы

### 1.3. Область применения

Документ предназначен для:
- Разработчиков, реализующих многофазную логику
- Архитекторов системы для понимания общей концепции
- Тестировщиков для разработки тестовых сценариев
- Технических писателей для обновления документации

**Затрагиваемые компоненты:**
- `CompoundSearcher` — поиск по `first_name` для сбора полиморфных форм
- `FilterPipeline` — модификация алгоритма дедупликации для сохранения данных
- `TemperatureStatisticsCalculator` — статистическое определение температур переходов
- `PhaseSegmentBuilder` — интеграция в основной поток обработки
- `PhaseResolver` — определение активных фаз и точек переходов
- `ThermodynamicCalculator` — расчёты с учётом фазовых переходов
- `ReactionCalculationFormatter` — вывод информации о фазовых переходах
- `ThermoOrchestrator` — координация многофазных расчётов

**Не входит в область:**
- Обратная совместимость со старой логикой (старый код будет удалён)
- Оптимизация производительности (будет выполнена на следующем этапе)
- Изменение структуры базы данных

## 2. Проблематика текущей системы

### 2.1. Описание проблемы

Текущая версия системы (v2.1) использует температурный диапазон из запроса пользователя для фильтрации записей в базе данных. Это приводит к следующим критическим проблемам:

**Проблема №1: Потеря базовых термодинамических данных**
- В базе данных H₂₉₈ и S₂₉₈ содержатся только в записях, покрывающих 298K
- Если пользователь запрашивает диапазон 500-700°C (773-973K), запись с диапазоном 298-600K отбрасывается
- Вместо неё используется запись с диапазоном 600-900K, где H₂₉₈ = 0.0 и S₂₉₈ = 0.0
- Расчёты становятся некорректными из-за отсутствия базовых значений

**Проблема №2: Неполное использование базы данных**
- База содержит множество записей для одного вещества в разных фазах и температурных диапазонах
- Система выбирает только одну "наиболее подходящую" запись
- Остальные записи игнорируются, хотя содержат ценную информацию

**Проблема №3: Отсутствие учёта фазовых переходов**
- При переходе через температуру плавления или кипения система не учитывает энтальпию перехода
- Расчёты H(T) и G(T) становятся физически некорректными

**Проблема №4: Ошибки на границах диапазонов**
- Если температура выходит за границы выбранной записи, расчёт прерывается с ошибкой
- Пример из теста: "T=973.0K выше максимальной температуры 900K"

### 2.2. Анализ тестового запроса

**Запрос пользователя (из актуальных логов):**
```
Взаимодействует ли оксид алюминия с фторидом кальция при нагревании до 1000 °C?
```

**Извлечённые параметры:**
- Уравнение: `Al₂O₃ + 3CaF₂ → 2AlF₃ + 3CaO`
- Температурный диапазон: 298-1273K
- Используемая температура: 1273.0K (передаётся как max_temperature)

**Проблема с агрессивной дедупликацией (Al₂O₃):**

Записи в базе данных (из логов):
```
Общий поиск: 84 записи для Al₂O3
Группировка по формуле:
  Al2O3: 32 записи (фазы: l, l, l, s, s, s, s, l, l, s...)
  Al2O3(C): 16 записей (с: все)
  Al2O3(D): 8 записей (с: все)
  Al2O3(G): 8 записей (с: все)
  Al2O3(K): 8 записей (с: все)
  Al2O3(O): 3 записи (с: все)
  Al2O3(P): 3 записи (с: все)
  Al2O3(g): 15 записей (газ: все)
  Al2O3(l): 7 записей (жидкость: все)
```

**Что происходит:**
1. Система успешно находит все полиморфные формы Al₂O₃ (84 записи)
2. **Проблема**: дедупликация удаляет 98.8% записей (84→1)
3. **Остаётся только одна запись**: Al₂O₃(g) с T=800-6000K, H298=0, S298=0
4. Потеряны все записи с корректными значениями H298 и S298
5. Многофазные компоненты (PhaseSegmentBuilder) не используются

**Вывод системы (финальный результат):**
```
После фильтрации:
  Al2O3(g): 1 запись (газовая фаза)
  H298: 0.000 ❌ | S298: 0.000 ❌
  Tmin: 800K | Tmax: 6000K

Аналогично для других веществ:
  CaF2: 69→1 запись (остаётся только CaF2(g))
  AlF3: 60→1 запись (остаётся только AlF3(g))
  CaO: 46→1 запись (остаётся только CaO(l))
```

**Статистика дедупликации:**
```
Al2O3:   84 записи → 1 запись (98.8% удалено) ❌
CaF2:    69 записей → 1 запись (98.6% удалено) ❌
AlF3:    60 записей → 1 запись (98.3% удалено) ❌
CaO:     46 записей → 1 запись (97.8% удалено) ❌
```

**Основная проблема**: агрессивная дедупликация в FilterPipeline удаляет практически все данные, кроме одной записи на вещество, что делает невозможным многофазные расчёты.

### 2.3. Корневая причина ошибок

**Основная архитектурная проблема:**
Текущая система использует **агрессивную дедупликацию** в `FilterPipeline`, которая удаляет 97-99% записей, оставляя только одну запись на вещество. Это делает невозможными многофазные расчёты.

**Проблема №1: Агрессивная дедупликация**
- **Что происходит:** FilterPipeline удаляет 98.8% записей Al₂O₃ (84→1)
- **Причина:** алгоритм дедупликации слишком строгие критерии уникальности
- **Последствия:** потеря данных о разных фазах, полиморфных формах, температурных диапазонах

**Проблема №2: Поиск по formula вместо first_name**
- **Что происходит:** система ищет точное совпадение `formula`
- **Проблема:** не собирает полиморфные формы (Al₂O₃, Al₂O₃(C), Al₂O₃(D) и т.д.)
- **Последствия:** неполное использование данных базы

**Проблема №3: Отсутствие интеграции многофазных компонентов**
- **PhaseSegmentBuilder** существует, но не используется в основном потоке
- **MultiPhaseReactionCalculator** не интегрирован в orchestrator.py
- Система выполняет поиск всех фаз, но затем отбрасывает их на этапе фильтрации

**Проблема №4: Передача max_temperature в SQL запросы**
- Несмотря на `temperature_range=None`, система передаёт `max_temperature: 1273.0`
- Может косвенно влиять на отбор записей на уровне базы данных

**Компоненты, требующие модификации:**

| Компонент                      | Текущая поведение                      | Требуемое поведение                                      |
| ------------------------------ | -------------------------------------- | -------------------------------------------------------- |
| `CompoundSearcher`             | Поиск по точной formula                | Поиск по `first_name` для сбора полиморфов              |
| `FilterPipeline`               | Агрессивная дедупликация (98% удалено) | Сохранение записей для многофазных расчётов              |
| `PhaseSegmentBuilder`          | Существует, но не используется          | Интеграция в основной поток обработки                    |
| `PhaseResolver`                | Определение одной фазы                 | Статистический анализ температур переходов               |
| `ReliabilityPriorityStage`     | Ограничение до 1 записи               | Сохранение нескольких записей для разных фаз             |

### 2.4. Реализация многофазной логики по видению пользователя

Для решения выявленных проблем предлагается следующая архитектура многофазных расчётов:

#### 2.4.1. Поиск всех записей соединения по first_name

**Текущая проблема:** Система ищет записи по точному совпадению `formula`, теряя полиморфные формы.

**Решение:**
1. **Поиск по `first_name`** вместо `formula`:
   - `Al₂O₃` → найдёт: `Al₂O₃`, `Al₂O₃(C)`, `Al₂O₃(D)`, `Al₂O₃(G)`, `Al₂O₃(K)` и т.д.
   - Все записи с одинаковым `first_name` считаются формами одного вещества

2. **Сохранение всех записей** на начальном этапе без фильтрации
3. **Группировка по `first_name`** с сохранением информации о полиморфных формах

**Пример работы:**
```
Запрос: Al₂O₃
Найдено: 84 записи с first_name="Aluminium oxide"
Формы: Al₂O₃ (32 записи), Al₂O₃(C) (16), Al₂O₃(D) (8), Al₂O₃(G) (8)...
Фазы: s (45 записей), l (15 записей), g (15 записей)
```

#### 2.4.2. Статистическое определение температур переходов

**Текущая проблема:** Температуры плавления/кипения могут различаться в разных записях.

**Решение:**
1. **Сбор данных:** Извлечь все значения `Tmelt` и `Tboil` из записей вещества
2. **Статистический анализ:**
   - Вычислить медианные значения температур переходов
   - Отфильтровать выбросы (значения, отклоняющиеся > 2σ от медианы)
   - Использовать наиболее статистически надёжные значения

**Алгоритм:**
```python
def determine_transition_temperatures(records):
    tmelt_values = [r.tmelt for r in records if r.tmelt > 0]
    tboil_values = [r.tboil for r in records if r.tboil > 0]

    # Медиана как устойчивая мера центрального положения
    tmelt = median(tmelt_values) if tmelt_values else None
    tboil = median(tboil_values) if tboil_values else None

    return tmelt, tboil
```

#### 2.4.3. Построение фазовых сегментов от 298K

**Текущая проблема:** Система не использует фазовые сегменты и не строит непрерывную зависимость.

**Решение:**
1. **Начало с 298.15K** как стандартной температуры для H298/S298
2. **Разделение диапазона 298-2500K** на фазовые сегменты:
   - **Сегмент 1:** [298K, Tmelt) - твёрдая фаза (s)
   - **Сегмент 2:** [Tmelt, Tboil) - жидкая фаза (l)
   - **Сегмент 3:** [Tboil, 2500K] - газовая фаза (g)

3. **Распределение записей по сегментам** на основе их температурных диапазонов

**Пример для Al₂O₃:**
```
Определённые температуры: Tmelt = 2327K, Tboil = 3273K
Расчётный диапазон: 298-2500K

Фазовые сегменты:
┌─────────────────────────────────────────────────────────┐
│ Сегмент 1: Твёрдая фаза (s)                             │
│ Диапазон: [298, 2327) K                                 │
│ Записи: 15 записей Al₂O₃ с различными температурными    │
│ диапазонами, покрывающими этот интервал                │
├─────────────────────────────────────────────────────────┤
│ Переход: Плавление при 2327K                           │
│ ΔH_fusion рассчитывается из разницы H298 фаз           │
├─────────────────────────────────────────────────────────┤
│ Сегмент 2: Жидкая фаза (l)                              │
│ Диапазон: [2327, 2500] K                               │
│ Записи: 5 записей Al₂O₃(l) для этого диапазона         │
└─────────────────────────────────────────────────────────┘
```

#### 2.4.4. Обработка фазовых переходов с энтальпиями

**Текущая проблема:** Отсутствует учёт скачков энтальпии при фазовых переходах.

**Решение:**
1. **Расчёт энтальпии перехода** из разницы H298 разных фаз:
   ```
   ΔH_fusion = H298(жидкая фаза) - H298(твёрдая фаза)
   ΔH_vaporization = H298(газовая фаза) - H298(жидкая фаза)
   ```

2. **Применение скачков в точках переходов:**
   ```
   H(T > Tmelt) = H(Tmelt⁻) + ΔH_fusion + ∫_Tmelt^T Cp_жидкость(T')dT'
   S(T > Tmelt) = S(Tmelt⁻) + ΔH_fusion/Tmelt + ∫_Tmelt^T [Cp_жидкость(T')/T']dT'
   ```

3. **Валидация термодинамической согласованности** переходов

#### 2.4.5. Детальное логирование всех этапов

**Требование:** Выводить подробную информацию о каждом этапе для отладки.

**Реализация:**
1. **Логирование поиска:**
   ```
   [ПОИСК] Al₂O₃: найдено 84 записи, 9 полиморфных форм
   [ПОИСК] Формы: Al₂O₃(32), Al₂O₃(C)(16), Al₂O₃(D)(8)...
   [ПОИСК] Фазы: s(45), l(15), g(15), ai(9)
   ```

2. **Логирование статистики переходов:**
   ```
   [СТАТИСТИКА] Tmelt: [2327, 2327, 2308, 2290, 2312] → медиана = 2327K
   [СТАТИСТИКА] Tboil: [3273, 3273, 2483] → медиана = 3273K
   ```

3. **Логирование сегментов:**
   ```
   [СЕГМЕНТ 1] s: [298-2327)K, 15 записей, покрыто 100%
   [ПЕРЕХОД] Плавление при 2327K, ΔH = 31.5 кДж/моль
   [СЕГМЕНТ 2] l: [2327-2500]K, 5 записей, покрыто 100%
   ```

#### 2.4.6. Финальная фильтрация и сопоставление температур

**Требование:** После расчёта термодинамики для всех веществ сопоставить таблицы и отбросить температуры с неполными данными.

**Реализация:**
1. **Параллельный расчёт** термодинамики для всех веществ в полном диапазоне
2. **Сопоставление результатов** по температурным точкам
3. **Фильтрация температур**, где хотя бы для одного вещества отсутствуют данные
4. **Формирование финальной таблицы** с полными данными по реакции

**Пример:**
```
Расчётные температуры: [298, 400, 500, 600, ..., 2500]K
Доступность данных:
  Al₂O₃: [298-2500]K ✓
  CaF₂:  [298-2400]K ✓
  AlF₃:  [298-2300]K ✓
  CaO:   [298-2500]K ✓

Финальный диапазон: [298-2300]K (ограничено AlF₃)
```

### 2.5. Структура базы данных

**Типичная структура записей для одного вещества:**

```sql
SELECT Formula, Phase, Tmin, Tmax, H298, S298, f1, f2, f3, f4, f5, f6, MeltingPoint, BoilingPoint
FROM compounds
WHERE Formula LIKE 'FeO%'
ORDER BY Phase, Tmin;
```

**Результат:**
```
| Formula | Phase | Tmin   | Tmax | H298     | S298   | f1    | f2   | f3    | MeltingPoint | BoilingPoint |
| ------- | ----- | ------ | ---- | -------- | ------ | ----- | ---- | ----- | ------------ | ------------ |
| FeO     | s     | 298.15 | 600  | -265.053 | 59.807 | 50.28 | 3.65 | -1.94 | 1650         | 3687         |
| FeO     | s     | 600    | 900  | 0.0      | 0.0    | 55.5  | 2.0  | -1.0  | 1650         | 3687         |
| FeO     | s     | 900    | 1300 | 0.0      | 0.0    | 52.0  | 1.5  | -0.8  | 1650         | 3687         |
| FeO     | l     | 1650   | 5000 | -254.106 | 54.365 | 60.0  | 0.0  | 0.0   | 1650         | 3687         |
| FeO     | g     | 298.17 | 400  | 251.040  | 241.92 | 28.69 | 4.69 | -0.81 | 1650         | 3687         |
| FeO     | g     | 400    | 2100 | 0.0      | 0.0    | 32.51 | 2.1  | -1.5  | 1650         | 3687         |
```

**ВАЖНО:** Названия полей в базе данных:
- Таблица: `compounds` (не `thermo_data`)
- Поля: `Formula`, `Phase`, `Tmin`, `Tmax`, `H298`, `S298` (PascalCase, не snake_case)
- Температуры переходов: `MeltingPoint`, `BoilingPoint` (не `tmelt`, `tboil`)

**Ключевые наблюдения:**

1. **H₂₉₈ и S₂₉₈ заполнены только в первой записи каждой фазы**, покрывающей стандартную температуру
   - Для твёрдой фазы (s): в записи 298.15-600K
   - Для газовой фазы (g): в записи 298.17-400K
   - Для жидкой фазы (l): в записи, начинающейся с MeltingPoint

2. **Температуры переходов (MeltingPoint, BoilingPoint) одинаковы** во всех записях
   - MeltingPoint = 1650K (температура плавления)
   - BoilingPoint = 3687K (температура кипения)

3. **Коэффициенты Шомейта (f1-f6) различаются** в каждом температурном диапазоне
   - Отражают изменение теплоёмкости в данном диапазоне

4. **Фазы определяются по температуре:**
   - T < 1650K → твёрдое (s)
   - 1650K ≤ T < 3687K → жидкое (l)
   - T ≥ 3687K → газ (g)

5. **КРИТИЧНО: Энтальпии фазовых переходов НЕ ХРАНЯТСЯ в базе данных**
   - Полей `h_fusion`, `h_vaporization` в БД **НЕТ**
   - Энтальпии переходов нужно **рассчитывать** из разницы H₂₉₈ разных фаз
   - Это **приближение**, так как H₂₉₈ — это энтальпии **образования**, а не абсолютные значения

### 2.5. Последствия текущей логики

**Для пользователя:**
- Получение некорректных результатов без предупреждения
- Ошибки расчёта на границах температурных диапазонов
- Невозможность использовать полный потенциал базы данных

**Для разработчиков:**
- Сложность отладки из-за неявной зависимости от температурного диапазона
- Необходимость ручного вмешательства для корректных расчётов
- Множество граничных случаев в коде

**Для системы:**
- Физически некорректные расчёты (нарушение законов термодинамики)
- Потеря доверия пользователей к результатам
- Невозможность масштабирования на более сложные задачи

**Пример некорректного расчёта:**

При H₂₉₈ = 0 и S₂₉₈ = 0:
```
H(773K) = 0 + ∫₂₉₈⁷⁷³ Cp(T)dT  ← Интегрирование от 298K, но H₂₉₈ = 0 ❌
S(773K) = 0 + ∫₂₉₈⁷⁷³ [Cp(T)/T]dT  ← S₂₉₈ = 0, расчёт некорректен ❌
```

**Физически корректно должно быть:**
```
H(773K) = H₂₉₈ + ∫₂₉₈⁷⁷³ Cp(T)dT  ← H₂₉₈ = -265.053 кДж/моль ✓
S(773K) = S₂₉₈ + ∫₂₉₈⁷⁷³ [Cp(T)/T]dT  ← S₂₉₈ = 59.807 Дж/(моль·K) ✓
```

## 3. Цели и требования

### 3.1. Основные цели

**Цель 1: Гарантированная корректность термодинамических расчётов**
- Всегда использовать базовые значения H₂₉₈ и S₂₉₈ из записи, покрывающей 298K
- Обеспечить физическую корректность расчётов согласно законам термодинамики
- Исключить ситуации с нулевыми или отсутствующими базовыми данными

**Цель 2: Максимальное использование базы данных**
- Использовать все доступные записи для вещества
- Расчёт от минимальной до максимальной температуры в совокупном диапазоне всех записей
- Автоматическое переключение между записями при изменении фазы

**Цель 3: Автоматическая обработка многофазных систем**
- Определение фазовых переходов (плавление, кипение, сублимация)
- Учёт энтальпий фазовых переходов в расчётах
- Построение непрерывной зависимости свойств от температуры через все фазы

**Цель 4: Информирование пользователя**
- Показывать полный расчётный диапазон температур
- Указывать использованные фазы и точки переходов
- Сообщать о максимальном использовании доступных данных

**Цель 5: Упрощение архитектуры**
- Удалить зависимость от пользовательского температурного диапазона
- Унифицировать логику для всех типов запросов
- Снизить количество граничных случаев

### 3.2. Функциональные требования

**FR-1: Поиск всех записей соединения по first_name**
- **ID:** FR-1
- **Приоритет:** Критический
- **Описание:** Система должна искать все записи вещества, используя `first_name` вместо точного совпадения `formula`, чтобы собирать полиморфные формы.

**Алгоритм:**
1. Извлечь `first_name` из запроса пользователя (например, "Aluminium oxide" для Al₂O₃)
2. Выполнить поиск по `first_name` в базе данных
3. Собрать все записи с одинаковым `first_name`, но разными `formula`
4. Сгруппировать записи по фазам и полиморфным формам
5. Сохранить все записи без дедупликации на этом этапе

**Критерий приёмки:**
- Запрос "Al₂O₃" находит: Al₂O₃, Al₂O₃(C), Al₂O₃(D), Al₂O₃(G) и т.д.
- Сохраняются все фазы: твёрдая, жидкая, газообразная
- Потери данных на этапе поиска < 5%

**❌ ТЕКУЩИЙ СТАТУС:** **ЧАСТИЧНО РЕАЛИЗОВАНО**
- Поиск работает, но агрессивная дедупликация удаляет 98% записей
- Требуется модификация алгоритма дедупликации

---

**FR-2: Статистическое определение температур переходов**
- **ID:** FR-2
- **Приоритет:** Критический
- **Описание:** Система должна определять температуры плавления и кипения на основе статистического анализа всех записей вещества.

**Алгоритм:**
1. Собрать все значения Tmelt и Tboil из записей вещества
2. Отфильтровать некорректные значения (≤ 0)
3. Вычислить медиану для каждой температуры перехода
4. Отфильтровать выбросы (> 2σ от медианы)
5. Использовать статистически надёжные значения для построения сегментов

**Критерий приёмки:**
- Температуры переходов определены для 95% веществ
- Значения стабильны при повторных запросах
- Устойчивы к выбросам в данных

**❌ ТЕКУЩИЙ СТАТУС:** **НЕ РЕАЛИЗОВАНО**
- Требуется создание `TemperatureStatisticsCalculator`
- Необходимо интегрировать в процесс поиска

---

**FR-3: Построение фазовых сегментов от 298K**
- **ID:** FR-3
- **Приоритет:** Критический
- **Описание:** Система должна строить фазовые сегменты начиная с 298.15K как базовой температуры.

**Алгоритм:**
1. Использовать Tmelt и Tboil из FR-2
2. Разбить диапазон 298-2500K на фазовые сегменты:
   - Сегмент 1: [298K, Tmelt) — твёрдая фаза (s)
   - Сегмент 2: [Tmelt, Tboil) — жидкая фаза (l)
   - Сегмент 3: [Tboil, 2500K] — газовая фаза (g)
3. Распределить записи по соответствующим сегментам
4. Проверить непрерывность покрытия

**Критерий приёмки:**
- Начальная температура всегда 298.15K для доступа к H298/S298
- Построены корректные фазовые сегменты для всех веществ
- Каждому сегменту сопоставлены записи с нужной фазой

**✅ ТЕКУЩИЙ СТАТУС:** **РЕАЛИЗОВАНО**
- `PhaseSegmentBuilder` существует и работает корректно
- **❌ ПРОБЛЕМА:** Не интегрирован в основной поток `orchestrator.py`

---

**FR-4: Расчёт фазовых переходов с энтальпиями**
- **ID:** FR-4
- **Приоритет:** Высокий
- **Описание:** Система должна корректно обрабатывать фазовые переходы с расчётом энтальпий и энтропии переходов.

**Алгоритм:**
1. Рассчитать энтальпии переходов из разницы H298 разных фаз:
   ```
   ΔH_fusion = H298(жидкость) - H298(твёрдое)
   ΔH_vaporization = H298(газ) - H298(жидкость)
   ```
2. Применить скачки в точках переходов при расчёте H(T) и S(T)
3. Обеспечить непрерывность G(T) через фазовые переходы

**Критерий приёмки:**
- Скачки энтальпии корректно учтены в точках переходов
- Расчёт ΔG учитывает вклад фазовых переходов
- Термодинамическая согласованность переходов

**❌ ТЕКУЩИЙ СТАТУС:** **ЧАСТИЧНО РЕАЛИЗОВАНО**
- Логика существует, но не используется из-за отсутствия многофазных расчётов

---

**FR-5: Интеграция многофазных компонентов в основной поток**
- **ID:** FR-5
- **Приоритет:** Критический
- **Описание:** Многофазные компоненты должны быть интегрированы в основной поток обработки в orchestrator.py.

**Алгоритм:**
1. Интегрировать `PhaseSegmentBuilder` в `ThermoOrchestrator`
2. Использовать `MultiPhaseReactionCalculator` для расчётов
3. Заменить однозаписную логику на многофазную
4. Обеспечить передачу фазовых данных в формatters

**Критерий приёмки:**
- Многофазные компоненты используются в основном потоке
- Расчёты выполняются через все фазовые сегменты
- Результаты содержат информацию о фазовых переходах

**❌ ТЕКУЩИЙ СТАТУС:** **КРИТИЧЕСКИ НЕ РЕАЛИЗОВАНО**
- Компоненты существуют, но не интегрированы
- Система продолжает использовать однозаписную логику

---

**FR-6: Детальное логирование многофазных расчётов**
- **ID:** FR-6
- **Приоритет:** Средний
- **Описание:** Система должна выводить подробную информацию о всех этапах многофазных расчётов.

**Алгоритм:**
1. Логировать поиск и сбор полиморфных форм
2. Логировать определение температур переходов
3. Логировать построение фазовых сегментов
4. Логировать расчёт фазовых переходов
5. Логировать финальное сопоставление данных

**Критерий приёмки:**
- Все этапы многофазных расчётов залогированы
- Пользователь видит использованные фазы и переходы
- Отладочная информация доступна для анализа

**❌ ТЕКУЩИЙ СТАТУС:** **НЕ РЕАЛИЗОВАНО**
- Логирование существует, но не охватывает многофазную логику

**FR-7: Модификация алгоритма дедупликации**
- **ID:** FR-7
- **Приоритет:** Критический
- **Описание:** Алгоритм дедупликации должен сохранять достаточное количество записей для многофазных расчётов.

**Алгоритм:**
1. Группировать записи по `first_name` вместо `formula`
2. Сохранять по несколько записей для каждой фазы (s, l, g)
3. Приоритизировать записи с полными данными (H298, S298)
4. Ограничить количество записей на фазу разумным пределом (3-5)

**Критерий приёмки:**
- Потери данных < 20% (вместо текущих 98%)
- Сохранены записи для всех основных фаз
- Каждая фаза имеет записи с корректными H298/S298

**❌ ТЕКУЩИЙ СТАТУС:** **КРИТИЧЕСКИ НЕ РЕАЛИЗОВАНО**
- Текущий алгоритм удаляет 97-99% записей
- Требуется полная переработка логики дедупликации

---

### 3.3. Нефункциональные требования

**NFR-1: Производительность**
- Время выполнения полного расчёта: не более 3 секунд (включая LLM)
- Время построения фазовых сегментов: не более 100мс на вещество
- Кэширование результатов для повторных запросов

**NFR-2: Надёжность**
- Корректная обработка отсутствующих данных (ΔH_transition, некоторых коэффициентов)
- Graceful degradation при неполных данных
- Валидация всех входных данных из базы

**NFR-3: Сопровождаемость**
- Чёткое разделение ответственности между компонентами
- Подробное логирование всех этапов построения фазовых сегментов
- Понятные сообщения об ошибках

**NFR-4: Тестируемость**
- Модульные тесты для каждого компонента
- Интеграционные тесты для полного цикла
- Регрессионные тесты с реальными данными из базы

**NFR-5: Документированность**
- Обновление ARCHITECTURE.md с описанием новой логики
- Примеры в user_guide.md
- Code comments для сложных алгоритмов

### 3.4. Критерии успеха

**Критерий 1: Корректность поиска полиморфов**
- ✓ Поиск по `first_name` находит все полиморфные формы вещества
- ✓ Сохраняются записи всех фаз: твёрдой, жидкой, газообразной
- ✓ Потери данных на этапе поиска < 5%

**Критерий 2: Эффективность дедупликации**
- ✓ Алгоритм сохраняет достаточное количество записей для многофазных расчётов
- ✓ Потери данных < 20% (вместо текущих 98%)
- ✓ Каждая фаза имеет записи с корректными H298/S298

**Критерий 3: Статистическое определение переходов**
- ✓ Температуры плавления/кипения определены для 95% веществ
- ✓ Значения стабильны и устойчивы к выбросам
- ✓ Используются статистически надёжные методы

**Критерий 4: Интеграция многофазных компонентов**
- ✓ PhaseSegmentBuilder интегрирован в основной поток
- ✓ Многофазные расчёты выполняются для всех веществ
- ✓ Результаты содержат информацию о фазовых переходах

**Критерий 5: Термодинамическая корректность**
- ✓ Расчёты всегда начинаются с 298.15K для доступа к H298/S298
- ✓ Фазовые переходы учтены с корректными энтальпиями
- ✓ Все расчёты физически непротиворечивы

**Критерий 6: Детальное логирование**
- ✓ Все этапы многофазных расчётов залогированы
- ✓ Пользователь видит использованные фазы и переходы
- ✓ Отладочная информация доступна для анализа

**Метрики успеха:**
- Сохранение > 80% данных после дедупликации
- 100% запросов используют многофазные расчёты
- Время выполнения запроса ≤ 5 секунд (с многофазной логикой)
- Покрытие кода тестами ≥ 90%
- Отсутствие ошибок "T выше максимальной температуры"

## 4. Архитектурные решения

### 4.1. Концепция полного температурного диапазона

**Ключевая идея:** Независимо от запроса пользователя, система всегда выполняет расчёт в **максимально доступном температурном диапазоне** на основе данных из базы.

**Принцип работы:**
```
Запрос пользователя: "FeO + H₂S при 500-700°C"
                              ↓
        LLM извлекает: temperature_range_k = [773, 973]
                              ↓
        [ИГНОРИРУЕТСЯ для поиска и фильтрации]
                              ↓
Поиск ВСЕХ записей для FeO, H₂S, FeS, H₂O без ограничений
                              ↓
    Определение общего диапазона: [298, 2500] K
                              ↓
            Расчёт от 298K до 2500K
                              ↓
    Вывод: "Расчётный диапазон: 298-2500K (полное использование БД)"
           "Запрошенный диапазон: 773-973K (для справки)"
```

**Обоснование:**
1. **Физическая корректность:** H(T) и S(T) рассчитываются от стандартной температуры 298K
2. **Максимум информации:** Используются все доступные данные из базы
3. **Отсутствие артефактов:** Нет зависимости результата от формулировки запроса
4. **Предсказуемость:** Одинаковый результат для одной реакции независимо от запроса

### 4.2. Автоматическое определение диапазона

**Алгоритм определения температурного диапазона:**

```python
def determine_temperature_range(compounds_data: Dict[str, List[DatabaseRecord]]) -> Tuple[float, float]:
    """
    Определить общий температурный диапазон для всех веществ реакции.
    
    Args:
        compounds_data: Словарь {formula: [records]}
    
    Returns:
        (start_temp, end_temp) в Кельвинах
    """
    all_tmin = []
    all_tmax = []
    
    # Собрать все границы температур
    for formula, records in compounds_data.items():
        for record in records:
            all_tmin.append(record.tmin)
            all_tmax.append(record.tmax)
    
    # Найти пересечение диапазонов
    start_temp = max(all_tmin)  # Максимум из минимумов
    end_temp = min(all_tmax)    # Минимум из максимумов
    
    # Расширить до 298K, если возможно
    if start_temp > 298.15:
        # Проверить, есть ли у всех веществ записи, покрывающие 298K
        can_use_298 = all(
            any(r.tmin <= 298.15 <= r.tmax for r in records)
            for records in compounds_data.values()
        )
        if can_use_298:
            start_temp = 298.15
    
    return (start_temp, end_temp)
```

**Стратегия определения диапазона:**

1. **Максимальное пересечение:** Найти диапазон, который покрывается всеми веществами
2. **Приоритет 298K:** Если возможно, начинать с 298K для доступа к H₂₉₈/S₂₉₈
3. **Расширение до max:** Использовать максимально доступную верхнюю границу

**Примеры:**

```
Пример 1: Все вещества покрывают 298-2000K
→ Диапазон расчёта: [298, 2000] K

Пример 2: 
  FeO: 298-5000K
  H₂S: 298-2500K
  FeS: 598-1465K
  H₂O: 600-1600K
→ Диапазон расчёта: [598, 1465] K (пересечение)

Пример 3 (с расширением):
  FeO: 298-2000K, 600-5000K
  H₂S: 298-2500K
→ Проверяем покрытие 298K: FeO (✓), H₂S (✓)
→ Диапазон расчёта: [298, 2000] K
```

### 4.3. Многофазная логика

**Концепция:** Автоматическое построение последовательности фазовых сегментов для каждого вещества с переключением между записями базы данных.

**Структура многофазных данных:**

```
Вещество: FeO
Температурный диапазон: 298-3700K
Температуры переходов: T_melt=1650K, T_boil=3687K

Фазовые сегменты:
┌─────────────────────────────────────────────────────────┐
│ Сегмент 1: Твёрдая фаза (s)                             │
│ Диапазон: [298, 1650) K                                 │
│ Записи:                                                 │
│   - Record 1: 298-600K (H₂₉₈=-265.053, S₂₉₈=59.807)   │
│   - Record 2: 600-900K                                  │
│   - Record 3: 900-1300K                                 │
│   - Record 4: 1300-1650K                                │
├─────────────────────────────────────────────────────────┤
│ Переход: Плавление при 1650K                           │
│ ΔH_fusion = 31.5 кДж/моль (из базы или расчёт)        │
├─────────────────────────────────────────────────────────┤
│ Сегмент 2: Жидкая фаза (l)                              │
│ Диапазон: [1650, 3687) K                                │
│ Записи:                                                 │
│   - Record 5: 1650-5000K (l)                            │
├─────────────────────────────────────────────────────────┤
│ Переход: Кипение при 3687K                             │
│ ΔH_vaporization = 340.0 кДж/моль                       │
├─────────────────────────────────────────────────────────┤
│ Сегмент 3: Газовая фаза (g)                             │
│ Диапазон: [3687, 3700] K                                │
│ Записи:                                                 │
│   - Record 6: 400-2100K (g)                             │
└─────────────────────────────────────────────────────────┘
```

**Алгоритм построения сегментов:**

```python
def build_phase_segments(
    records: List[DatabaseRecord],
    temp_range: Tuple[float, float]
) -> List[PhaseSegment]:
    """
    Построить фазовые сегменты для вещества.
    
    Args:
        records: Все записи вещества из базы
        temp_range: Общий температурный диапазон (start, end)
    
    Returns:
        Список фазовых сегментов с переходами
    """
    # Извлечь температуры переходов (одинаковы во всех записях)
    tmelt = records[0].tmelt
    tboil = records[0].tboil
    
    start_temp, end_temp = temp_range
    segments = []
    
    # Сегмент 1: Твёрдая фаза (если start_temp < tmelt)
    if start_temp < tmelt:
        solid_records = [r for r in records if r.phase == 's']
        solid_records.sort(key=lambda r: r.tmin)
        
        segments.append(PhaseSegment(
            phase='s',
            temp_start=start_temp,
            temp_end=min(tmelt, end_temp),
            records=solid_records,
            transition_at_end=('melting', tmelt) if end_temp >= tmelt else None
        ))
    
    # Сегмент 2: Жидкая фаза (если диапазон покрывает [tmelt, tboil))
    if start_temp < tboil and end_temp > tmelt:
        liquid_records = [r for r in records if r.phase == 'l']
        liquid_records.sort(key=lambda r: r.tmin)
        
        segments.append(PhaseSegment(
            phase='l',
            temp_start=max(tmelt, start_temp),
            temp_end=min(tboil, end_temp),
            records=liquid_records,
            transition_at_start=('melting', tmelt) if start_temp < tmelt else None,
            transition_at_end=('boiling', tboil) if end_temp >= tboil else None
        ))
    
    # Сегмент 3: Газовая фаза (если end_temp >= tboil)
    if end_temp >= tboil:
        gas_records = [r for r in records if r.phase == 'g']
        gas_records.sort(key=lambda r: r.tmin)
        
        segments.append(PhaseSegment(
            phase='g',
            temp_start=max(tboil, start_temp),
            temp_end=end_temp,
            records=gas_records,
            transition_at_start=('boiling', tboil) if start_temp < tboil else None
        ))
    
    return segments
```

### 4.4. Учёт фазовых переходов

**Типы фазовых переходов:**

1. **Плавление (s→l):** Твёрдое → Жидкое при T_melt
2. **Кипение (l→g):** Жидкое → Газ при T_boil
3. **Сублимация (s→g):** Твёрдое → Газ напрямую (редко, например CO₂)

**Термодинамика фазовых переходов:**

При фазовом переходе при температуре T_trans:
```
ΔH_trans = H(фаза2, T_trans) - H(фаза1, T_trans)
ΔS_trans = ΔH_trans / T_trans  (при равновесии ΔG = 0)
```

**Интеграция в расчёты:**

Для энтальпии H(T):
```
H(T) = H₂₉₈ + ∫₂₉₈ᵀ Cp(T')dT'  (без переходов)

С учётом перехода при T_melt:
H(T > T_melt) = H₂₉₈ + ∫₂₉₈^T_melt Cp_solid(T')dT' 
                     + ΔH_fusion
                     + ∫_T_melt^T Cp_liquid(T')dT'
```

Для энтропии S(T):
```
S(T > T_melt) = S₂₉₈ + ∫₂₉₈^T_melt [Cp_solid(T')/T']dT'
                     + ΔH_fusion/T_melt
                     + ∫_T_melt^T [Cp_liquid(T')/T']dT'
```

**Источники данных о переходах:**

1. **Из базы данных:** Поля `h_fusion`, `h_vaporization` (если доступны)
2. **Расчёт из H₂₉₈ разных фаз:**
   ```
   ΔH_fusion ≈ H₂₉₈(l) - H₂₉₈(s)  (приближение)
   ```
3. **Эвристические значения:** На основе типа вещества (металлы, соли, молекулярные)

### 4.5. Игнорирование пользовательского диапазона

**Важно:** Температурный диапазон из запроса пользователя используется ТОЛЬКО для информирования, но НЕ для фильтрации данных.

**Обработка на разных уровнях:**

| Компонент                      | Использование `temperature_range_k`     |
| ------------------------------ | --------------------------------------- |
| `ThermodynamicAgent` (LLM)     | ✓ Извлекает из текста запроса           |
| `ExtractedReactionParameters`  | ✓ Сохраняет для передачи                |
| `MultiPhaseOrchestrator`       | ○ Игнорирует при поиске                 |
| `CompoundSearcher`             | ✗ НЕ получает как параметр              |
| `FilterPipeline`               | ✗ НЕ использует для фильтрации          |
| `ThermodynamicCalculator`      | ✗ Использует автоопределённый диапазон  |
| `ReactionCalculationFormatter` | ✓ Показывает "Запрошенный vs Расчётный" |

**Пример информирования пользователя:**

```
================================================================================
⚗️ Термодинамический расчёт реакции
================================================================================

Уравнение: FeO + H₂S → FeS + H₂O

Запрошенный диапазон: 500-700°C (773-973K)
Расчётный диапазон: 298-2100K 

ℹ️  ИНФОРМАЦИЯ: Для обеспечения корректности расчёт выполнен в максимально
    доступном диапазоне на основе данных из базы. Это гарантирует использование
    базовых термодинамических свойств (H₂₉₈, S₂₉₈) и учёт фазовых переходов.

Данные веществ:
[...]

Результаты расчёта:
| T(K) | ΔH° (кДж/моль) | ΔS° (Дж/К·моль) | ΔG° (кДж/моль) | Фаза | Комментарий         |
| ---- | -------------- | --------------- | -------------- | ---- | ------------------- |
| 298  | -33.45         | -45.23          | -19.97         | s,g  | Стандартные условия |
[...]
773   | -28.12         | -42.11          | -4.58          | s,g            | ← Запрошенный диапазон
873   | -27.85         | -41.98          | -1.21          | s,g            |
973   | -27.60         | -41.87          | +1.12          | s,g            | ← Запрошенный диапазон
[...]
1650  | -25.30         | -40.50          | +41.53         | s→l transition | Плавление FeO
[...]
2100  | -23.10         | -39.85          | +60.59         | l,g            |
================================================================================
`