# Техническое задание: Комплексное логирование системы фильтрации

**Версия**: 2.0  
**Дата**: 16.10.2025  
**Статус**: Расширенная спецификация

---

## 1. Цель

Обеспечить комплексное логирование процесса фильтрации термодинамических данных с акцентом на читаемость для человека и детальную визуализацию результатов на каждой стадии pipeline. Логирование должно покрывать весь жизненный цикл обработки запроса от извлечения параметров до финальной агрегации результатов.

---

## 2. Основные требования

### 2.1. Формат логирования

- **Одна сессия = один файл**: каждый запуск `main.py` создаёт отдельный файл лога
- **Читаемость**: логи должны быть понятны человеку без дополнительных инструментов
- **Структурированность**: служебная информация (timestamp, log_level, file_name) не должна засорять основной контент
- **Визуальное разделение**: использование разделителей (═, ─, │) для структурирования информации

### 2.2. Табличный вывод данных

#### Обязательные требования:
- **Частота вывода**: таблица выводится на каждой стадии фильтрации для каждого вещества
- **Объём**: первые 15 найденных записей по каждому веществу на каждой стадии
- **Библиотека**: `tabulate>=0.9.0` (уже присутствует в `pyproject.toml`)
- **Столбцы таблицы** (в соответствии с реальной структурой БД):
  1. **Formula** — химическая формула (столбец `Formula` из БД)
  2. **FirstName** — основное название вещества (столбец `FirstName` из БД)
  3. **Phase** — фазовое состояние (столбец `Phase` из БД)
  4. **Tmin-Tmax (K)** — диапазон температур в Кельвинах (столбцы `Tmin` и `Tmax` из БД)

#### Форматирование:
- Таблица начинается с **новой строки** после служебной информации лога
- Формат таблицы: `grid` (из `tabulate`) для максимальной читаемости
- Чёткое визуальное разделение между стадиями фильтрации
- Понятные заголовки для каждой таблицы с указанием стадии и вещества

---

## 3. Область применения

### 3.1. Стадии фильтрации (FilterPipeline)

Логирование применяется ко всем стадиям в конвейере фильтрации (`src/thermo_agents/filtering/filter_pipeline.py`):

1. **ComplexFormulaSearchStage** — поиск по сложным формулам (опционально)
2. **TemperatureFilterStage** — фильтрация по температурному диапазону
3. **PhaseSelectionStage** — выбор корректного фазового состояния
4. **ReliabilityPriorityStage** — приоритизация по классу надёжности
5. **TemperatureCoverageStage** — проверка покрытия температурного диапазона

### 3.2. Информация по стадиям

Для каждой стадии логируется:

#### Заголовок стадии
```
═══════════════════════════════════════════════════════════════════════════
СТАДИЯ [N]: Название стадии | Вещество: [Формула]
───────────────────────────────────────────────────────────────────────────
```

#### Статистика стадии
- Количество записей **до** фильтрации
- Количество записей **после** фильтрации
- Процент отсева (reduction_rate)
- Время выполнения стадии (мс)
- Специфичная информация стадии:
  - `TemperatureFilterStage`: температурный диапазон, записи в/вне диапазона
  - `PhaseSelectionStage`: распределение по фазам, корректность фаз
  - `ReliabilityPriorityStage`: распределение по `ReliabilityClass`, max_records
  - `TemperatureCoverageStage`: покрытие диапазона, gaps в данных

#### Таблица данных (15 записей)
Выводится только если `records_after > 0`:
```
+----------+----------------------+-------+------------------+
| Formula  | FirstName            | Phase | Tmin-Tmax (K)    |
+==========+======================+=======+==================+
| WCl6     | Tungsten chloride    | g     | 298.15 - 2000.0  |
| WCl6     | Tungsten chloride    | l     | 298.15 - 620.0   |
| WCl6(l)  | Tungsten chloride    | l     | 200.0 - 298.15   |
+----------+----------------------+-------+------------------+
```

#### Дополнительная статистика
Специфичные метрики каждой стадии из `stage.get_statistics()`

---

## 4. Структура логов сессии

### 4.1. Именование файлов

```
logs/sessions/session_YYYYMMDD_HHMMSS.log
```

Где:
- `YYYYMMDD` — дата запуска (год, месяц, день)
- `HHMMSS` — время запуска (часы, минуты, секунды)

Примеры:
- `session_20251016_143215.log` — запуск 16 октября 2025 в 14:32:15
- `session_20251016_160000.log` — запуск 16 октября 2025 в 16:00:00

### 4.2. Структура файла лога

#### Секция 1: Инициализация сессии
```
2025-10-16 14:32:15 - INFO - SESSION STARTED
2025-10-16 14:32:15 - INFO - Термодинамическая система v2.0
2025-10-16 14:32:15 - INFO - Запрос пользователя: [текст запроса]
```

#### Секция 2: Извлечение параметров (ThermodynamicAgent)
```
2025-10-16 14:32:16 - INFO - ОПЕРАЦИЯ: [thermo_agent] -> EXTRACT_PARAMETERS

═══════════════════════════════════════════════════════════════════════════
ИЗВЛЕЧЕНИЕ ПАРАМЕТРОВ ИЗ ЗАПРОСА
───────────────────────────────────────────────────────────────────────────
Обнаружено соединений: 4
Температурный диапазон: 673.0 - 673.0 K (400°C)

Соединения:
  1. TiO2 (оксид титана)
  2. HCl (хлороводород)
  3. TiCl4 (хлорид титана)
  4. H2O (вода)
═══════════════════════════════════════════════════════════════════════════
```

#### Секция 3: Поиск соединений (CompoundSearcher)
```
2025-10-16 14:32:17 - INFO - Начало поиска для 4 соединений

═══════════════════════════════════════════════════════════════════════════
ПОИСК: TiO2
───────────────────────────────────────────────────────────────────────────
SQL запрос:
  SELECT * FROM compounds WHERE (TRIM(Formula) = 'TiO2' OR Formula LIKE 'TiO2(%')
  ORDER BY ReliabilityClass ASC LIMIT 100

Найдено записей: 87
Время выполнения: 12.3 мс
═══════════════════════════════════════════════════════════════════════════
```

#### Секция 4: Фильтрация (FilterPipeline)
Для каждого вещества и каждой стадии:

```
═══════════════════════════════════════════════════════════════════════════
СТАДИЯ 1: Температурная фильтрация | Вещество: TiO2
───────────────────────────────────────────────────────────────────────────
Записей до фильтрации: 87
Записей после фильтрации: 34
Процент отсева: 60.9%
Время выполнения: 2.1 мс

Температурный диапазон: 673.0 - 673.0 K
Записей в диапазоне: 34
Записей вне диапазона: 53

+----------+--------------------+-------+------------------+
| Formula  | FirstName          | Phase | Tmin-Tmax (K)    |
+==========+====================+=======+==================+
| TiO2     | Titanium dioxide   | s     | 298.15 - 2000.0  |
| TiO2(s)  | Titanium dioxide   | s     | 200.0 - 800.0    |
| TiO2     | Titanium dioxide   | l     | 800.0 - 3000.0   |
...еще 12 записей...
+----------+--------------------+-------+------------------+

Статистика:
  Coverage: 100.0%
  Tmin/Tmax заполненность: 100%
═══════════════════════════════════════════════════════════════════════════

═══════════════════════════════════════════════════════════════════════════
СТАДИЯ 2: Выбор фазового состояния | Вещество: TiO2
───────────────────────────────────────────────────────────────────────────
Записей до фильтрации: 34
Записей после фильтрации: 18
Процент отсева: 47.1%
Время выполнения: 1.8 мс

Распределение по фазам:
  s (твёрдая): 12 записей
  l (жидкая): 4 записи
  g (газообразная): 2 записи

Ожидаемая фаза при T=673K: s (твёрдая)
Корректных фаз: 12 записей
Некорректных фаз: 6 записей

+----------+--------------------+-------+------------------+
| Formula  | FirstName          | Phase | Tmin-Tmax (K)    |
+==========+====================+=======+==================+
| TiO2     | Titanium dioxide   | s     | 298.15 - 2000.0  |
| TiO2(s)  | Titanium dioxide   | s     | 200.0 - 800.0    |
...еще 13 записей...
+----------+--------------------+-------+------------------+
═══════════════════════════════════════════════════════════════════════════
```

#### Секция 5: Финальные результаты (AggregatednReactionData)
```
═══════════════════════════════════════════════════════════════════════════
ФИНАЛЬНЫЕ РЕЗУЛЬТАТЫ ПОИСКА
───────────────────────────────────────────────────────────────────────────
Всего обработано соединений: 4
Успешно найдено: 4
Провалов поиска: 0

Детали по соединениям:

TiO2:
  Найдено записей: 1
  ReliabilityClass: 1
  Температурное покрытие: 100%
  
HCl:
  Найдено записей: 1
  ReliabilityClass: 1
  Температурное покрытие: 100%

[остальные соединения...]
═══════════════════════════════════════════════════════════════════════════
```

#### Секция 6: Завершение сессии
```
2025-10-16 14:32:20 - INFO - Общее время обработки: 4.5 сек
2025-10-16 14:32:20 - INFO - SESSION ENDED
```

### 4.3. Обработка ошибок

При возникновении ошибки на любой стадии:

```
2025-10-16 14:32:18 - ERROR - ═══════════════════════════════════════════
2025-10-16 14:32:18 - ERROR - ОШИБКА НА СТАДИИ: Температурная фильтрация
2025-10-16 14:32:18 - ERROR - Вещество: TiCl4
2025-10-16 14:32:18 - ERROR - ───────────────────────────────────────────
2025-10-16 14:32:18 - ERROR - Тип ошибки: ValueError
2025-10-16 14:32:18 - ERROR - Сообщение: Invalid temperature range
2025-10-16 14:32:18 - ERROR - 
2025-10-16 14:32:18 - ERROR - Traceback:
2025-10-16 14:32:18 - ERROR -   File "filter_stages.py", line 45, in filter
2025-10-16 14:32:18 - ERROR -     if record.tmin <= tmax_user and record.tmax >= tmin_user:
2025-10-16 14:32:18 - ERROR - ═══════════════════════════════════════════
```

---

## 5. Технические детали реализации

### 5.1. Модули системы логирования

#### `SessionLogger` (`src/thermo_agents/thermo_agents_logger.py`)
- **Существующий функционал**:
  - Создание сессионных логов с уникальным именем
  - `format_table()` — форматирование через `tabulate`
  - `OperationLogger` — операционное логирование
  - `log_info()`, `log_error()` — базовые методы логирования

- **Новый функционал** (требуется добавить):
  - `log_filter_stage_table()` — вывод таблицы результатов стадии
  - `log_stage_header()` — вывод заголовка стадии с разделителями
  - `log_stage_statistics()` — вывод статистики стадии
  - `format_records_table()` — преобразование `List[DatabaseRecord]` в таблицу

#### `FilterPipeline` (`src/thermo_agents/filtering/filter_pipeline.py`)
- **Метод `execute()`**: основная точка интеграции логирования
- **Существующая статистика**: `stage_statistics` уже собирается
- **Требуется добавить**: передачу `SessionLogger` и вызовы методов логирования

### 5.2. Интеграция с FilterPipeline

#### Изменения в `FilterPipeline.__init__()`
```python
class FilterPipeline:
    def __init__(self, session_logger: Optional[SessionLogger] = None):
        self.stages: List[FilterStage] = []
        self.statistics: List[Dict[str, Any]] = []
        self._last_execution_time_ms: Optional[float] = None
        self.session_logger = session_logger  # НОВОЕ
```

#### Изменения в `FilterPipeline.execute()`
```python
def execute(
    self,
    records: List[DatabaseRecord],
    context: FilterContext
) -> FilterResult:
    # ... существующий код ...
    
    for i, stage in enumerate(self.stages, start=1):
        # НОВОЕ: логирование заголовка стадии
        if self.session_logger:
            self.session_logger.log_stage_header(
                stage_number=i,
                stage_name=stage.get_stage_name(),
                compound_formula=context.compound_formula
            )
        
        # Применить фильтр
        filtered = stage.filter(current_records, context)
        
        # Собрать статистику
        stats = stage.get_statistics()
        # ... существующий код статистики ...
        
        # НОВОЕ: логирование статистики и таблицы
        if self.session_logger:
            self.session_logger.log_stage_statistics(stats)
            
            if len(filtered) > 0:
                self.session_logger.log_filter_stage_table(
                    records=filtered[:15],  # первые 15
                    compound_formula=context.compound_formula,
                    stage_name=stage.get_stage_name()
                )
        
        # ... остальной существующий код ...
```

### 5.3. Модель данных

#### `DatabaseRecord` (`src/thermo_agents/models/search.py`)
Используемые поля для таблиц:
- `formula: str` — химическая формула (**Formula** в БД)
- `name: Optional[str]` — название вещества (**FirstName** в БД, алиас для совместимости)
- `phase: Optional[str]` — фазовое состояние (**Phase** в БД)
- `tmin: float` — минимальная температура (**Tmin** в БД)
- `tmax: float` — максимальная температура (**Tmax** в БД)

**Важно**: В модели используются алиасы `alias="FirstName"`, но в Python-коде поле называется `name`. Таблица БД использует `FirstName`.

### 5.4. Формат таблицы с tabulate

```python
def format_records_table(records: List[DatabaseRecord], max_rows: int = 15) -> str:
    """
    Форматирует DatabaseRecord в таблицу.
    
    Args:
        records: Список записей из БД
        max_rows: Максимальное количество строк (по умолчанию 15)
    
    Returns:
        Отформатированная таблица в формате grid
    """
    if not records:
        return "Нет данных для отображения"
    
    headers = ["Formula", "FirstName", "Phase", "Tmin-Tmax (K)"]
    rows = []
    
    for record in records[:max_rows]:
        formula = record.formula or "N/A"
        first_name = record.name or "N/A"  # в модели поле 'name', в БД 'FirstName'
        phase = record.phase or "N/A"
        temp_range = f"{record.tmin:.2f} - {record.tmax:.2f}"
        
        rows.append([formula, first_name, phase, temp_range])
    
    return tabulate(
        rows,
        headers=headers,
        tablefmt="grid",
        floatfmt=".2f",
        missingval="N/A"
    )
```

---

## 6. Примеры вывода

### 6.1. Полный пример лога сессии

```
2025-10-16 14:32:15 - INFO - SESSION STARTED
2025-10-16 14:32:15 - INFO - Термодинамическая система v2.0
2025-10-16 14:32:15 - INFO - Запрос: Возможна ли реакция TiO2 + 2Cl2 → TiCl4 + O2 при 673K?

═══════════════════════════════════════════════════════════════════════════
ИЗВЛЕЧЕНИЕ ПАРАМЕТРОВ
───────────────────────────────────────────────────────────────────────────
Соединения: TiO2, Cl2, TiCl4, O2
Температура: 673.0 K (400°C)
═══════════════════════════════════════════════════════════════════════════

2025-10-16 14:32:16 - INFO - Начало поиска для TiO2

═══════════════════════════════════════════════════════════════════════════
СТАДИЯ 1: Температурная фильтрация | Вещество: TiO2
───────────────────────────────────────────────────────────────────────────
Записей до: 87 | Записей после: 34 | Отсев: 60.9% | Время: 2.1 мс

+----------+--------------------+-------+------------------+
| Formula  | FirstName          | Phase | Tmin-Tmax (K)    |
+==========+====================+=======+==================+
| TiO2     | Titanium dioxide   | s     | 298.15 - 2000.0  |
| TiO2(s)  | Titanium dioxide   | s     | 200.0 - 800.0    |
| TiO2     | Titanium dioxide   | l     | 800.0 - 3000.0   |
+----------+--------------------+-------+------------------+
[показаны первые 3 из 15 записей]
═══════════════════════════════════════════════════════════════════════════

═══════════════════════════════════════════════════════════════════════════
СТАДИЯ 2: Выбор фазового состояния | Вещество: TiO2
───────────────────────────────────────────────────────────────────────────
Записей до: 34 | Записей после: 18 | Отсев: 47.1% | Время: 1.8 мс

Ожидаемая фаза: s (твёрдая)
Распределение: s=12, l=4, g=2

+----------+--------------------+-------+------------------+
| Formula  | FirstName          | Phase | Tmin-Tmax (K)    |
+==========+====================+=======+==================+
| TiO2     | Titanium dioxide   | s     | 298.15 - 2000.0  |
| TiO2(s)  | Titanium dioxide   | s     | 200.0 - 800.0    |
+----------+--------------------+-------+------------------+
[показаны первые 2 из 15 записей]
═══════════════════════════════════════════════════════════════════════════

2025-10-16 14:32:20 - INFO - SESSION ENDED
```

---

## 7. Этапы реализации

### Фаза 1: Расширение SessionLogger (2-3 часа)
- [ ] **1.1** Добавить метод `log_stage_header(stage_number, stage_name, compound_formula)`
  - Вывод разделителей `═══...═══`
  - Форматирование заголовка стадии
  - Вывод подзаголовка с `───...───`

- [ ] **1.2** Добавить метод `log_stage_statistics(stats: Dict[str, Any])`
  - Вывод `Записей до/после`
  - Вывод процента отсева
  - Вывод времени выполнения
  - Вывод специфичных метрик стадии

- [ ] **1.3** Добавить метод `format_records_table(records: List[DatabaseRecord], max_rows=15) -> str`
  - Извлечение данных: Formula, FirstName (как name), Phase, Tmin, Tmax
  - Форматирование температурного диапазона "Tmin - Tmax (K)"
  - Использование `tabulate` с форматом `grid`
  - Обработка пустого списка записей

- [ ] **1.4** Добавить метод `log_filter_stage_table(records, compound_formula, stage_name)`
  - Вызов `format_records_table()`
  - Вывод таблицы с новой строки
  - Добавление информации о количестве показанных/всего записей

- [ ] **1.5** Написать unit-тесты для новых методов
  - Тест форматирования таблицы
  - Тест вывода заголовков
  - Тест статистики

### Фаза 2: Интеграция с FilterPipeline (3-4 часа)
- [ ] **2.1** Модифицировать `FilterPipeline.__init__()`
  - Добавить параметр `session_logger: Optional[SessionLogger] = None`
  - Сохранить ссылку на logger в `self.session_logger`

- [ ] **2.2** Модифицировать `FilterPipeline.execute()`
  - Добавить вызов `log_stage_header()` перед каждой стадией
  - Добавить вызов `log_stage_statistics()` после получения stats
  - Добавить вызов `log_filter_stage_table()` для непустых результатов
  - Добавить логирование начальных данных (стадия 0)

- [ ] **2.3** Модифицировать `create_orchestrator()` в `main.py`
  - Создать `session_logger` через `create_session_logger()`
  - Передать `session_logger` в `FilterPipeline(session_logger=session_logger)`
  - Убедиться что все компоненты используют один logger

- [ ] **2.4** Добавить логирование поиска соединений
  - Логировать SQL запросы в `CompoundSearcher`
  - Логировать количество найденных записей
  - Логировать время выполнения запроса

- [ ] **2.5** Добавить логирование извлечения параметров
  - Логировать результаты `ThermodynamicAgent.extract_parameters()`
  - Форматированный вывод списка соединений
  - Вывод температурного диапазона

### Фаза 3: Тестирование и документация (2-3 часа)
- [ ] **3.1** Интеграционные тесты
  - Тест полного цикла с реальными данными
  - Проверка структуры лог-файла
  - Проверка читаемости таблиц

- [ ] **3.2** Проверка на реальных запросах
  - Запустить с тестовым запросом из ТЗ
  - Проверить вывод для 4+ веществ
  - Проверить вывод при ошибках на стадиях

- [ ] **3.3** Оптимизация производительности
  - Замерить overhead логирования
  - Оптимизировать при необходимости
  - Добавить возможность отключения детального логирования

- [ ] **3.4** Обновление документации
  - Добавить примеры использования в README
  - Документировать новые методы в docstrings
  - Создать примеры логов в `docs/specs/logging_specification.md`

- [ ] **3.5** Code review и рефакторинг
  - Проверка соответствия инструкциям из `.github/copilot-instructions.md`
  - Улучшение именования переменных
  - Добавление type hints

---

## 8. Риски и ограничения

```
2025-10-16 14:32:15 - INFO - Начало фильтрации для WCl6

═══════════════════════════════════════════════════════════
СТАДИЯ 1: Temperature Filter | Вещество: WCl6
───────────────────────────────────────────────────────────
Записей до фильтрации: 45
Записей после фильтрации: 23

+----------+--------------------+-------+------------------+
| Формула  | Название           | Фаза  | Температура (K)  |
+==========+====================+=======+==================+
| WCl6     | Tungsten chloride  | g     | 298.15 - 2000.0  |
| WCl6     | Tungsten chloride  | l     | 298.15 - 620.0   |
| WCl6     | Tungsten chloride  | s     | 200.0 - 298.15   |
+----------+--------------------+-------+------------------+

Отфильтровано: 22 записи (вне температурного диапазона)
═══════════════════════════════════════════════════════════
```

---

## 7. Этапы реализации

### Фаза 1: Расширение SessionLogger (2-3 часа)
- [ ] **1.1** Добавить метод `log_stage_header(stage_number, stage_name, compound_formula)`
  - Вывод разделителей `═══...═══`
  - Форматирование заголовка стадии
  - Вывод подзаголовка с `───...───`

- [ ] **1.2** Добавить метод `log_stage_statistics(stats: Dict[str, Any])`
  - Вывод `Записей до/после`
  - Вывод процента отсева
  - Вывод времени выполнения
  - Вывод специфичных метрик стадии

- [ ] **1.3** Добавить метод `format_records_table(records: List[DatabaseRecord], max_rows=15) -> str`
  - Извлечение данных: Formula, FirstName (как name), Phase, Tmin, Tmax
  - Форматирование температурного диапазона "Tmin - Tmax (K)"
  - Использование `tabulate` с форматом `grid`
  - Обработка пустого списка записей

- [ ] **1.4** Добавить метод `log_filter_stage_table(records, compound_formula, stage_name)`
  - Вызов `format_records_table()`
  - Вывод таблицы с новой строки
  - Добавление информации о количестве показанных/всего записей

- [ ] **1.5** Написать unit-тесты для новых методов
  - Тест форматирования таблицы
  - Тест вывода заголовков
  - Тест статистики

### Фаза 2: Интеграция с FilterPipeline (3-4 часа)
- [ ] **2.1** Модифицировать `FilterPipeline.__init__()`
  - Добавить параметр `session_logger: Optional[SessionLogger] = None`
  - Сохранить ссылку на logger в `self.session_logger`

- [ ] **2.2** Модифицировать `FilterPipeline.execute()`
  - Добавить вызов `log_stage_header()` перед каждой стадией
  - Добавить вызов `log_stage_statistics()` после получения stats
  - Добавить вызов `log_filter_stage_table()` для непустых результатов
  - Добавить логирование начальных данных (стадия 0)

- [ ] **2.3** Модифицировать `create_orchestrator()` в `main.py`
  - Создать `session_logger` через `create_session_logger()`
  - Передать `session_logger` в `FilterPipeline(session_logger=session_logger)`
  - Убедиться что все компоненты используют один logger

- [ ] **2.4** Добавить логирование поиска соединений
  - Логировать SQL запросы в `CompoundSearcher`
  - Логировать количество найденных записей
  - Логировать время выполнения запроса

- [ ] **2.5** Добавить логирование извлечения параметров
  - Логировать результаты `ThermodynamicAgent.extract_parameters()`
  - Форматированный вывод списка соединений
  - Вывод температурного диапазона

### Фаза 3: Тестирование и документация (2-3 часа)
- [ ] **3.1** Интеграционные тесты
  - Тест полного цикла с реальными данными
  - Проверка структуры лог-файла
  - Проверка читаемости таблиц

- [ ] **3.2** Проверка на реальных запросах
  - Запустить с тестовым запросом из ТЗ
  - Проверить вывод для 4+ веществ
  - Проверить вывод при ошибках на стадиях

- [ ] **3.3** Оптимизация производительности
  - Замерить overhead логирования
  - Оптимизировать при необходимости
  - Добавить возможность отключения детального логирования

- [ ] **3.4** Обновление документации
  - Добавить примеры использования в README
  - Документировать новые методы в docstrings
  - Создать примеры логов в `docs/specs/logging_specification.md`

- [ ] **3.5** Code review и рефакторинг
  - Проверка соответствия инструкциям из `.github/copilot-instructions.md`
  - Улучшение именования переменных
  - Добавление type hints

---

## 8. Риски и ограничения

### 8.1. Риски

#### Производительность
- **Описание**: Форматирование таблиц через `tabulate` может замедлить выполнение при большом количестве стадий
- **Вероятность**: Средняя
- **Воздействие**: Увеличение времени обработки на 5-10%
- **Митигация**: 
  - Кэширование отформатированных таблиц
  - Опциональное отключение детального логирования через конфигурацию
  - Асинхронная запись в файл

#### Размер лог-файлов
- **Описание**: При поиске большого количества веществ логи могут разрастаться до нескольких МБ
- **Вероятность**: Высокая
- **Воздействие**: Заполнение дискового пространства, сложность анализа
- **Митигация**:
  - Ротация логов старше N дней
  - Конфигурируемый максимальный размер файла
  - Сжатие старых логов (gzip)

#### Синхронизация логов
- **Описание**: При параллельном выполнении стадий возможны race conditions в записи логов
- **Вероятность**: Низкая (текущая архитектура последовательная)
- **Воздействие**: Перемешанные записи в логе
- **Митигация**:
  - Использование thread-safe логгеров
  - Блокировки при записи
  - Буферизация записей по стадиям

### 8.2. Ограничения

#### Технические ограничения
- Максимум **15 записей** на таблицу (по требованию)
- Таблицы только для `DatabaseRecord` (не для произвольных данных)
- Формат `grid` — только текстовый (нет HTML/JSON экспорта в текущей версии)
- Одна сессия = один файл (нет группировки сессий)

#### Функциональные ограничения
- Логирование только успешных стадий и финальных ошибок
- Нет логирования промежуточных LLM-вызовов (только результаты)
- Нет визуализации графиков/диаграмм в логах
- Отсутствие индексации/поиска по логам (только текстовый поиск)

#### Ограничения данных БД
- Столбцы `Tmin`, `Tmax` — обязательные (100% заполненность согласно анализу БД)
- `FirstName` может быть `NULL` — требуется обработка `"N/A"`
- `Phase` может быть `NULL` — требуется обработка `"N/A"`
- `ReliabilityClass` — целое число (1-9), требует валидации

---

## 9. Расширения (будущие версии)

### 9.1. Версия 2.1 (опционально)
- [ ] Экспорт таблиц в отдельные CSV-файлы
- [ ] JSON-формат логов для машинной обработки
- [ ] Конфигурационный файл для настройки логирования
- [ ] Фильтрация логов по уровню детализации (INFO, DEBUG, TRACE)

### 9.2. Версия 2.2 (опционально)
- [ ] Веб-интерфейс для просмотра логов
- [ ] Визуализация статистики фильтрации (графики)
- Агрегация статистики по нескольким сессиям
- [ ] Экспорт в Markdown с форматированием

### 9.3. Версия 3.0 (долгосрочно)
- [ ] Structured logging (JSON Lines формат)
- [ ] Интеграция с ELK Stack (Elasticsearch, Logstash, Kibana)
- [ ] Real-time мониторинг через WebSocket
- [ ] Аналитика качества данных на основе логов

---

## 10. Критерии приёмки

### 10.1. Функциональные требования
- ✅ Каждый запуск `main.py` создаёт отдельный лог-файл
- ✅ Таблицы выводятся на каждой стадии для каждого вещества
- ✅ Таблицы содержат ровно 4 столбца: Formula, FirstName, Phase, Tmin-Tmax (K)
- ✅ Показываются первые 15 записей (или меньше, если записей меньше)
- ✅ Таблицы форматируются через `tabulate` с форматом `grid`
- ✅ Служебная информация отделена от таблиц

### 10.2. Нефункциональные требования
- ✅ Читаемость: человек может понять содержимое без инструментов
- ✅ Производительность: overhead логирования < 10% от общего времени
- ✅ Надёжность: логирование не должно прерывать основной процесс
- ✅ Совместимость: работа на Windows/Linux/macOS

### 10.3. Требования к качеству кода
- ✅ Type hints для всех новых функций
- ✅ Docstrings в формате Google Style
- ✅ Unit-тесты с покрытием > 80%
- ✅ Соответствие `.github/copilot-instructions.md`
- ✅ Отсутствие относительных импортов

---

## 11. Приложения

### Приложение А: Соответствие столбцов БД и модели

| БД (compounds)   | DatabaseRecord    | Описание                      |
| ---------------- | ----------------- | ----------------------------- |
| Formula          | formula           | Химическая формула            |
| FirstName        | name              | Основное название (alias)     |
| Phase            | phase             | Фазовое состояние (s/l/g/aq)  |
| Tmin             | tmin              | Минимальная температура (K)   |
| Tmax             | tmax              | Максимальная температура (K)  |
| ReliabilityClass | reliability_class | Класс надёжности данных (1-9) |

### Приложение Б: Структура файлов проекта (релевантные)

```
agents_for_david/
├── main.py                                    # точка входа [МОДИФИКАЦИЯ]
├── logs/
│   └── sessions/
│       └── session_YYYYMMDD_HHMMSS.log       # лог-файлы сессий
├── src/
│   └── thermo_agents/
│       ├── thermo_agents_logger.py            # SessionLogger [МОДИФИКАЦИЯ]
│       ├── orchestrator.py                    # ThermoOrchestrator [МОДИФИКАЦИЯ]
│       ├── filtering/
│       │   ├── filter_pipeline.py             # FilterPipeline [МОДИФИКАЦИЯ]
│       │   └── filter_stages.py               # Стадии фильтрации
│       └── models/
│           └── search.py                      # DatabaseRecord
└── tests/
    └── test_logging/                          # [НОВАЯ ПАПКА]
        ├── test_session_logger.py
        └── test_filter_pipeline_logging.py
```

---

**Конец документа**

---

**История изменений**:
- v1.0 (16.10.2025) — Первоначальная версия
- v2.0 (16.10.2025) — Расширенная спецификация с детальным TODO, рисками и критериями приёмки
