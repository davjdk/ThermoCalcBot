# –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏ —É–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

**–ü—Ä–æ–µ–∫—Ç:** ThermoSystem Telegram Bot Integration
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.1
**–î–∞—Ç–∞:** 9 –Ω–æ—è–±—Ä—è 2025

---

## üìÑ 1. –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤

### 1.1. –°—Ç—Ä–∞—Ç–µ–≥–∏—è —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –£—Å–ª–æ–≤–∏–µ | –§–æ—Ä–º–∞—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ |
|----------|---------|-----------------|
| **–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞** | `< 3000 —Å–∏–º–≤–æ–ª–æ–≤` | Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ |
| **–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞** | `‚â• 3000 —Å–∏–º–≤–æ–ª–æ–≤` | TXT —Ñ–∞–π–ª |
| **–ë–æ–ª—å—à–∏–µ —Ç–∞–±–ª–∏—Ü—ã** | `> 20 —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã` | TXT —Ñ–∞–π–ª |
| **–°–ª–æ–∂–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | –ú–Ω–æ–≥–æ Unicode —Å–∏–º–≤–æ–ª–æ–≤ | TXT —Ñ–∞–π–ª |
| **–õ–∏–º–∏—Ç Telegram** | `> 20MB` | –û—à–∏–±–∫–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∏—Ç—å |

### 1.2. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ TXT —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üìÑ **–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π 4096 —Å–∏–º–≤–æ–ª–æ–≤** - –ø–æ–ª–Ω—ã–µ —Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã
- üéØ **–ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** —Ç–∞–±–ª–∏—Ü, —Ñ–æ—Ä–º—É–ª, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
- üíº **–°–∫–∞—á–∞—Ç—å –¥–ª—è –æ—Ñ–ª–∞–π–Ω –∞–Ω–∞–ª–∏–∑–∞** - —É–¥–æ–±–Ω–æ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π
- üì± **–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** - –º–æ–±–∏–ª—å–Ω—ã–µ –∏ –¥–µ—Å–∫—Ç–æ–ø
- üìä **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥** - –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- ‚úÖ **–ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TXT —Ñ–∞–π–ª–æ–≤** –¥–æ 20MB (–ª–∏–º–∏—Ç Telegram Bot API)
- ‚úÖ **UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–∞** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Unicode —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª (H‚ÇÇO, CO‚ÇÇ, ‚Üí)
- ‚úÖ **–ú–µ—Ç–æ–¥ `sendDocument()`** —Å –∫–ª–∞—Å—Å–æ–º `InputFile`
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞

---

## üóÇÔ∏è 2. TelegramFileHandler

### 2.1. –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏

```python
import os
import tempfile
import asyncio
from datetime import datetime, timedelta
from pathlib import Path
from typing import Optional, Dict, Any
from telegram import InputFile, Update
from telegram.ext import ContextTypes
import logging

logger = logging.getLogger(__name__)

class TelegramFileHandler:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è Telegram –±–æ—Ç–∞"""

    def __init__(
        self,
        temp_dir: str = "temp/telegram_files",
        cleanup_hours: int = 24,
        max_file_size_mb: int = 20
    ):
        self.temp_dir = Path(temp_dir)
        self.cleanup_hours = cleanup_hours
        self.max_file_size_mb = max_file_size_mb
        self.active_files: Dict[int, Dict[str, Any]] = {}

        # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        self.temp_dir.mkdir(parents=True, exist_ok=True)

        # –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏
        asyncio.create_task(self._periodic_cleanup())

        logger.info(f"TelegramFileHandler initialized with temp_dir: {self.temp_dir}")

    async def create_temp_file(
        self,
        content: str,
        user_id: int,
        reaction_info: str = ""
    ) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º"""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')

        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        safe_reaction = self._sanitize_filename(reaction_info)[:30]
        if safe_reaction:
            filename = f"thermo_report_{safe_reaction}_{timestamp}.txt"
        else:
            filename = f"thermo_report_{timestamp}.txt"

        file_path = self.temp_dir / filename

        # –ó–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞ —Å UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)

            # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞
            self.active_files[user_id] = {
                'path': str(file_path),
                'filename': filename,
                'created_at': datetime.now(),
                'size': len(content),
                'reaction_info': reaction_info
            }

            logger.info(f"Created temp file: {filename} for user {user_id}")
            return str(file_path)

        except Exception as e:
            logger.error(f"Error creating temp file: {e}")
            raise

    async def send_file(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE,
        content: str,
        reaction_info: str = ""
    ) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞–∫ —Ñ–∞–π–ª–∞"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–ª–∏–º–∏—Ç Telegram: 20MB)
            file_size_mb = len(content.encode('utf-8')) / (1024 * 1024)

            if file_size_mb > self.max_file_size_mb:
                logger.warning(f"File size {file_size_mb:.2f}MB exceeds Telegram limit (20MB)")
                await self._send_size_error(update, file_size_mb)
                return False

            # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            file_path = await self.create_temp_file(content, update.effective_user.id, reaction_info)
            filename = Path(file_path).name

            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
            success = await self._send_document(update, context, file_path, filename, content)

            if success:
                # –ö—Ä–∞—Ç–∫–æ–µ summary –≤ —á–∞—Ç–µ
                summary = self._extract_summary(content)
                await self._send_file_summary(update, summary)

            return success

        except Exception as e:
            logger.error(f"Error sending file: {e}")
            await self._send_error_message(update, str(e))
            return False

    async def _send_document(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE,
        file_path: str,
        filename: str,
        content: str
    ) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Telegram API"""
        try:
            with open(file_path, 'rb') as f:
                file_content = f.read()

            input_file = InputFile(file_content, filename=filename)

            await context.bot.send_document(
                chat_id=update.effective_chat.id,
                document=input_file,
                caption=self._generate_caption(content, self.active_files[update.effective_user.id].get('reaction_info', '')),
                parse_mode="Markdown"
            )

            logger.info(f"File sent successfully: {filename}")
            return True

        except Exception as e:
            logger.error(f"Error sending document: {e}")
            return False

    def _generate_caption(self, content: str, reaction_info: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –∫ —Ñ–∞–π–ª—É"""
        char_count = len(content)
        kb_size = char_count / 1024

        caption = (
            f"üìä *–î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç*\n\n"
        )

        if reaction_info:
            caption += f"**–†–µ–∞–∫—Ü–∏—è:** {reaction_info}\n"

        caption += (
            f"**–†–∞–∑–º–µ—Ä:** {char_count:,} —Å–∏–º–≤–æ–ª–æ–≤ ({kb_size:.1f} KB)\n"
            f"**–°–æ–∑–¥–∞–Ω:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
            f"üíæ *–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ñ–ª–∞–π–Ω –∞–Ω–∞–ª–∏–∑–∞*"
        )

        return caption

    def _sanitize_filename(self, filename: str) -> str:
        """–û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ —Å Unicode –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π"""
        import re
        import unicodedata

        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è Unicode (NFD -> NFC –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        filename = unicodedata.normalize('NFKC', filename)

        # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –æ–±—ã—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –¥–ª—è –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤
        subscript_map = str.maketrans('‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ', '0123456789')
        filename = filename.translate(subscript_map)

        # –£–¥–∞–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö Unicode —Å–∏–º–≤–æ–ª–æ–≤ (‚Üí, ‚áå, –∏ —Ç.–¥.)
        filename = filename.replace('‚Üí', '_to_').replace('‚áå', '_eq_')

        # –ó–∞–º–µ–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
        filename = re.sub(r'[^\w\s-]', '_', filename)

        # –ó–∞–º–µ–Ω–∞ –ø—Ä–æ–±–µ–ª–æ–≤ –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
        filename = re.sub(r'\s+', '_', filename)

        # –£–¥–∞–ª–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π
        filename = re.sub(r'_+', '_', filename)

        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã
        return filename.strip('_')[:50]

    async def _send_size_error(self, update: Update, file_size_mb: float):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞"""
        error_text = (
            f"‚ö†Ô∏è *–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π*\n\n"
            f"–†–∞–∑–º–µ—Ä –æ—Ç—á—ë—Ç–∞: {file_size_mb:.2f}MB –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç Telegram (20MB).\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –∏–ª–∏ —à–∞–≥ —Ä–∞—Å—á—ë—Ç–∞."
        )

        await update.message.reply_text(error_text, parse_mode="Markdown")

    def _extract_summary(self, response: str) -> str:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫—Ä–∞—Ç–∫–æ–≥–æ summary –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞"""
        lines = response.split('\n')

        # –ü–æ–∏—Å–∫ –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        summary_lines = []
        for line in lines[:50]:  # –ü–µ—Ä–≤—ã–µ 50 —Å—Ç—Ä–æ–∫
            if any(keyword in line for keyword in [
                '–£—Ä–∞–≤–Ω–µ–Ω–∏–µ:', '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω:', 'ŒîH', 'K =', 'T ='
            ]):
                summary_lines.append(line)

        summary = '\n'.join(summary_lines[:5])  # –ú–∞–∫—Å–∏–º—É–º 5 —Å—Ç—Ä–æ–∫ summary

        if not summary:
            summary = "‚úÖ *–†–∞—Å—á—ë—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ*"

        return summary

    async def _send_file_summary(self, update: Update, summary: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫—Ä–∞—Ç–∫–æ–≥–æ summary –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞"""
        summary_text = (
            f"‚úÖ *–û—Ç—á—ë—Ç –≥–æ—Ç–æ–≤!*\n\n"
            f"{summary}\n\n"
            f"üíæ *–ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –≤ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–º —Ñ–∞–π–ª–µ*"
        )

        await update.message.reply_text(summary_text, parse_mode="Markdown")

    async def _send_error_message(self, update: Update, error_message: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"""
        error_text = (
            "üòî *–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞*\n\n"
            f"```{error_message}```\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help"
        )

        await update.message.reply_text(error_text, parse_mode="Markdown")

    async def _periodic_cleanup(self):
        """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"""
        while True:
            try:
                await asyncio.sleep(3600)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
                await self._cleanup_old_files()
            except Exception as e:
                logger.error(f"Error in cleanup task: {e}")

    async def _cleanup_old_files(self):
        """–û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ cleanup_hours"""
        cutoff_time = datetime.now() - timedelta(hours=self.cleanup_hours)
        deleted_count = 0

        try:
            for file_path in self.temp_dir.glob("*.txt"):
                if datetime.fromtimestamp(file_path.stat().st_mtime) < cutoff_time:
                    try:
                        file_path.unlink()
                        deleted_count += 1
                        logger.debug(f"Deleted old file: {file_path.name}")
                    except Exception as e:
                        logger.error(f"Error deleting file {file_path}: {e}")

            if deleted_count > 0:
                logger.info(f"Cleaned up {deleted_count} old files")

        except Exception as e:
            logger.error(f"Error during file cleanup: {e}")

    def get_file_stats(self) -> Dict[str, Any]:
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∞–π–ª–∞–º"""
        try:
            files = list(self.temp_dir.glob("*.txt"))
            total_size = sum(f.stat().st_size for f in files)

            return {
                'total_files': len(files),
                'total_size_mb': total_size / (1024 * 1024),
                'active_sessions': len(self.active_files),
                'temp_directory': str(self.temp_dir)
            }
        except Exception as e:
            logger.error(f"Error getting file stats: {e}")
            return {
                'total_files': 0,
                'total_size_mb': 0,
                'active_sessions': len(self.active_files),
                'temp_directory': str(self.temp_dir),
                'error': str(e)
            }

    async def cleanup_user_files(self, user_id: int):
        """–û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.active_files:
            user_file_info = self.active_files[user_id]
            try:
                file_path = Path(user_file_info['path'])
                if file_path.exists():
                    file_path.unlink()
                    logger.info(f"Cleaned up file for user {user_id}: {file_path.name}")
            except Exception as e:
                logger.error(f"Error cleaning up user file: {e}")

            del self.active_files[user_id]

    async def shutdown(self):
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å –æ—á–∏—Å—Ç–∫–æ–π"""
        logger.info("Shutting down TelegramFileHandler...")

        # –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        for user_id in list(self.active_files.keys()):
            await self.cleanup_user_files(user_id)

        # –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        try:
            await self._cleanup_old_files()
        except Exception as e:
            logger.error(f"Error during shutdown cleanup: {e}")

        logger.info("TelegramFileHandler shutdown complete")
```

---

## üß† 3. SmartResponseHandler

### 3.1. –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤

```python
import re
from typing import List
from telegram import Update
from telegram.ext import ContextTypes
import logging

logger = logging.getLogger(__name__)

class SmartResponseHandler:
    """–£–º–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (—Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Ñ–∞–π–ª)"""

    def __init__(
        self,
        file_handler: TelegramFileHandler,
        message_threshold: int = 3000
    ):
        self.file_handler = file_handler
        self.message_threshold = message_threshold

    async def send_response(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE,
        response: str,
        reaction_info: str = ""
    ) -> bool:
        """–£–º–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ (—Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Ñ–∞–π–ª)"""

        try:
            should_use_file = self._should_use_file(response)

            if should_use_file:
                logger.info(f"Using file delivery for response length: {len(response)}")
                success = await self.file_handler.send_file(
                    update, context, response, reaction_info
                )
            else:
                logger.info(f"Using message delivery for response length: {len(response)}")
                success = await self._send_as_messages(update, context, response)

            return success

        except Exception as e:
            logger.error(f"Error in smart response delivery: {e}")
            await self._send_error_message(update, str(e))
            return False

    def _should_use_file(self, response: str) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª"""

        # –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π - –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞
        if len(response) >= self.message_threshold:
            return True

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if self._has_large_tables(response):
            return True

        if self._has_complex_formatting(response):
            return True

        if self._has_many_reactions(response):
            return True

        return False

    def _has_large_tables(self, response: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü"""
        lines = response.split('\n')
        table_rows = [line for line in lines if '|' in line and line.strip().startswith('|')]
        return len(table_rows) > 20  # –ë–æ–ª–µ–µ 20 —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã

    def _has_complex_formatting(self, response: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–æ–∂–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        return (
            response.count('‚îå') > 10 or  # Unicode —Ç–∞–±–ª–∏—Ü—ã
            response.count('‚îÄ') > 50 or  # –õ–∏–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü
            response.count('\t') > 20 or # –¢–∞–±—É–ª—è—Ü–∏—è
            response.count('‚ïë') > 10     # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
        )

    def _has_many_reactions(self, response: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π"""
        # –ü–æ–¥—Å—á—ë—Ç —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π —Å —Ä–µ–∞–∫—Ü–∏—è–º–∏
        reaction_patterns = [
            r'‚Üí', r'‚áå', r'‚Üî', r'<=>',  # –°—Ç—Ä–µ–ª–∫–∏ —Ä–µ–∞–∫—Ü–∏–π
            r'ŒîH', r'ŒîS', r'ŒîG',     # –¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤–µ–ª–∏—á–∏–Ω—ã
            r'K\s*='                  # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è
        ]

        reaction_count = sum(
            len(re.findall(pattern, response))
            for pattern in reaction_patterns
        )

        return reaction_count > 10  # –ú–Ω–æ–≥–æ —Ä–µ–∞–∫—Ü–∏–π –≤ –æ–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ

    async def _send_as_messages(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE,
        response: str
    ) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (—Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)"""

        try:
            messages = self._split_message(response)

            for i, message in enumerate(messages):
                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —á–∞—Å—Ç–µ–π –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                if len(messages) > 1:
                    message = f"üìÑ *–ß–∞—Å—Ç—å {i+1}/{len(messages)}*\n\n{message}"

                await update.message.reply_text(
                    message,
                    parse_mode="Markdown",
                    disable_web_page_preview=True
                )

                # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏ –¥–ª—è rate limiting
                if i < len(messages) - 1:
                    await asyncio.sleep(0.5)

            return True

        except Exception as e:
            logger.error(f"Error sending message(s): {e}")
            return False

    def _split_message(self, message: str, max_length: int = 4000) -> List[str]:
        """–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —á–∞—Å—Ç–∏ —Å —É—á—ë—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""

        if len(message) <= max_length:
            return [message]

        parts = []
        current_part = ""
        lines = message.split('\n')

        for line in lines:
            # –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–µ–≤—ã—Å–∏—Ç –ª–∏–º–∏—Ç
            if len(current_part) + len(line) + 1 > max_length:
                if current_part:
                    parts.append(current_part.strip())
                    current_part = line
                else:
                    # –°—Ç—Ä–æ–∫–∞ —Å–∞–º–∞ –ø–æ —Å–µ–±–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è
                    sub_parts = self._split_line(line, max_length)
                    parts.extend(sub_parts[:-1])
                    current_part = sub_parts[-1]
            else:
                if current_part:
                    current_part += '\n' + line
                else:
                    current_part = line

        if current_part:
            parts.append(current_part.strip())

        return parts

    def _split_line(self, line: str, max_length: int) -> List[str]:
        """–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏"""
        parts = []
        for i in range(0, len(line), max_length - 10):
            parts.append(line[i:i + max_length - 10])
        return parts

    async def _send_error_message(self, update: Update, error_message: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"""
        error_text = (
            "üòî *–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞*\n\n"
            f"```{error_message}```\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help"
        )

        await update.message.reply_text(error_text, parse_mode="Markdown")

    def get_delivery_stats(self) -> dict:
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–æ–≤"""
        return {
            'message_threshold': self.message_threshold,
            'file_handler_stats': self.file_handler.get_file_stats()
        }
```

---

## üìã 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### 4.1. FileHandlerConfig

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class FileHandlerConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤"""

    # Directory configuration
    temp_file_dir: str = "temp/telegram_files"
    cleanup_hours: int = 24
    max_file_size_mb: int = 20  # –õ–∏–º–∏—Ç Telegram Bot API

    # Smart response configuration
    auto_file_threshold: int = 3000  # —Å–∏–º–≤–æ–ª–æ–≤
    max_table_rows: int = 20
    max_unicode_lines: int = 10

    # File naming
    max_filename_length: int = 50
    filename_timestamp_format: str = "%Y%m%d_%H%M%S"

    # Performance
    enable_file_compression: bool = False
    max_concurrent_file_operations: int = 5

    @classmethod
    def from_env(cls) -> 'FileHandlerConfig':
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        return cls(
            temp_file_dir=os.getenv("TEMP_FILE_DIR", "temp/telegram_files"),
            cleanup_hours=int(os.getenv("FILE_CLEANUP_HOURS", "24")),
            max_file_size_mb=int(os.getenv("MAX_FILE_SIZE_MB", "20")),
            auto_file_threshold=int(os.getenv("AUTO_FILE_THRESHOLD", "3000")),
            max_table_rows=int(os.getenv("MAX_TABLE_ROWS", "20")),
            max_unicode_lines=int(os.getenv("MAX_UNICODE_LINES", "10")),
            max_filename_length=int(os.getenv("MAX_FILENAME_LENGTH", "50")),
            enable_file_compression=os.getenv("ENABLE_FILE_COMPRESSION", "false").lower() == "true",
            max_concurrent_file_operations=int(os.getenv("MAX_CONCURRENT_FILE_OPERATIONS", "5"))
        )

    def validate(self) -> List[str]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        errors = []

        if self.cleanup_hours <= 0:
            errors.append("FILE_CLEANUP_HOURS must be positive")

        if self.max_file_size_mb <= 0 or self.max_file_size_mb > 50:
            errors.append("MAX_FILE_SIZE_MB must be between 1 and 50")

        if self.auto_file_threshold < 1000:
            errors.append("AUTO_FILE_THRESHOLD must be at least 1000 characters")

        if self.max_table_rows < 5:
            errors.append("MAX_TABLE_ROWS must be at least 5")

        return errors
```

### 4.2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

```python
# –í –æ—Å–Ω–æ–≤–Ω–æ–º –∫–ª–∞—Å—Å–µ –±–æ—Ç–∞
class ThermoSystemTelegramBot:
    def __init__(self, config: TelegramBotConfig):
        self.config = config

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
        file_handler_config = FileHandlerConfig.from_env()
        self.file_handler = TelegramFileHandler(
            temp_dir=file_handler_config.temp_file_dir,
            cleanup_hours=file_handler_config.cleanup_hours,
            max_file_size_mb=file_handler_config.max_file_size_mb
        )

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        self.smart_response_handler = SmartResponseHandler(
            file_handler=self.file_handler,
            message_threshold=file_handler_config.auto_file_threshold
        )

    async def shutdown(self):
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å –æ—á–∏—Å—Ç–∫–æ–π —Ñ–∞–π–ª–æ–≤"""
        logger.info("Shutting down bot...")

        # –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
        await self.file_handler.shutdown()

        # –î—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ shutdown...
        logger.info("Bot shutdown complete")
```

---

## üß™ 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### 5.1. Unit —Ç–µ—Å—Ç—ã –¥–ª—è FileHandler

```python
import pytest
import tempfile
from unittest.mock import AsyncMock, Mock
from pathlib import Path

@pytest.mark.asyncio
class TestTelegramFileHandler:
    def setup_method(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        self.temp_dir = tempfile.mkdtemp()
        self.file_handler = TelegramFileHandler(
            temp_dir=self.temp_dir,
            cleanup_hours=1,  # 1 —á–∞—Å –¥–ª—è —Ç–µ—Å—Ç–æ–≤
            max_file_size_mb=1  # 1MB –¥–ª—è —Ç–µ—Å—Ç–æ–≤
        )

    async def test_create_temp_file(self):
        """–¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞"""
        content = "Test content"
        user_id = 12345
        reaction_info = "2 H2 + O2 ‚Üí 2 H2O"

        file_path = await self.file_handler.create_temp_file(
            content, user_id, reaction_info
        )

        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert Path(file_path).exists()
        assert Path(file_path).name.startswith("thermo_report_")
        assert "2H2_O2_to_2H2O" in Path(file_path).name

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        with open(file_path, 'r', encoding='utf-8') as f:
            assert f.read() == content

    def test_sanitize_filename(self):
        """–¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞"""
        test_cases = [
            ("2 H‚ÇÇ + O‚ÇÇ ‚Üí 2 H‚ÇÇO", "2H2_O2_to_2H2O"),
            ("CO‚ÇÇ + H‚ÇÇO ‚áå H‚ÇÇCO‚ÇÉ", "CO2_H2O_eq_H2CO3"),
            ("Complex reaction: A‚ÜíB", "Complex_reaction_A_to_B"),
            ("", ""),
            ("Very long filename that should be truncated", "Very_long_filename_that_should_be_tr")
        ]

        for input_name, expected in test_cases:
            result = self.file_handler._sanitize_filename(input_name)
            assert result == expected[:50]  # –° —É—á—ë—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã

    def test_should_use_file_criteria(self):
        """–¢–µ—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞"""
        smart_handler = SmartResponseHandler(self.file_handler)

        # –î–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
        long_response = "A" * 4000
        assert smart_handler._should_use_file(long_response) == True

        # –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç
        short_response = "Short response"
        assert smart_handler._should_use_file(short_response) == False

        # –û—Ç–≤–µ—Ç —Å –±–æ–ª—å—à–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
        table_response = "| T | H | S |\n" + "A | B | C |\n" * 25
        assert smart_handler._has_large_tables(table_response) == True

        # –û—Ç–≤–µ—Ç —Å–æ —Å–ª–æ–∂–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        complex_response = "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n" * 15
        assert smart_handler._has_complex_formatting(complex_response) == True

    async def test_cleanup_old_files(self):
        """–¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"""
        import time
        from datetime import datetime, timedelta

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
        test_file = Path(self.temp_dir) / "test_old_file.txt"
        test_file.write_text("test content")

        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
        old_time = datetime.now() - timedelta(hours=25)
        old_timestamp = old_time.timestamp()

        # –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (platform dependent)
        try:
            import os
            os.utime(test_file, (old_timestamp, old_timestamp))
        except:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
            pass

        # –ó–∞–ø—É—Å–∫ –æ—á–∏—Å—Ç–∫–∏
        await self.file_handler._cleanup_old_files()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ (—Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–¥–∞–ª—ë–Ω)
        # Note: –≠—Ç–æ—Ç —Ç–µ—Å—Ç –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
```

### 5.2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```python
@pytest.mark.asyncio
async def test_end_to_end_file_delivery():
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ñ–∞–π–ª–∞"""
    # Mock –æ–±—ä–µ–∫—Ç—ã Telegram
    mock_update = Mock()
    mock_update.effective_user.id = 12345
    mock_update.effective_chat.id = 67890
    mock_update.message.reply_text = AsyncMock()

    mock_context = Mock()
    mock_context.bot.send_document = AsyncMock()

    # –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–±–æ–ª—å—à–æ–π –¥–ª—è —Ñ–∞–π–ª–∞)
    large_content = "Thermodynamic report content...\n" * 200

    # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    file_handler = TelegramFileHandler(temp_dir=tempfile.mkdtemp())
    smart_handler = SmartResponseHandler(file_handler)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
    success = await smart_handler.send_response(
        mock_update, mock_context, large_content, "Test Reaction"
    )

    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    assert success == True
    assert mock_context.bot.send_document.called
    assert mock_update.message.reply_text.called  # –î–ª—è summary

    # –û—á–∏—Å—Ç–∫–∞
    await file_handler.shutdown()
```

---

## üìä 6. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### 6.1. File System Metrics

```python
class FileSystemMetrics:
    """–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã"""

    def __init__(self, file_handler: TelegramFileHandler):
        self.file_handler = file_handler
        self.metrics = {
            'files_created': 0,
            'files_sent': 0,
            'total_size_mb': 0.0,
            'errors': 0,
            'cleanup_runs': 0
        }

    def record_file_creation(self, size_mb: float):
        """–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞"""
        self.metrics['files_created'] += 1
        self.metrics['total_size_mb'] += size_mb

    def record_file_sent(self, size_mb: float):
        """–ó–∞–ø–∏—Å—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞"""
        self.metrics['files_sent'] += 1

    def record_error(self):
        """–ó–∞–ø–∏—Å—å –æ—à–∏–±–∫–∏"""
        self.metrics['errors'] += 1

    def record_cleanup(self, files_deleted: int):
        """–ó–∞–ø–∏—Å—å –æ—á–∏—Å—Ç–∫–∏"""
        self.metrics['cleanup_runs'] += 1

    def get_metrics(self) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫"""
        current_stats = self.file_handler.get_file_stats()

        return {
            **self.metrics,
            'current_stats': current_stats,
            'average_file_size_mb': (
                self.metrics['total_size_mb'] / max(1, self.metrics['files_created'])
            ),
            'success_rate': (
                (self.metrics['files_sent'] / max(1, self.metrics['files_created'])) * 100
            )
        }

    def reset_metrics(self):
        """–°–±—Ä–æ—Å –º–µ—Ç—Ä–∏–∫"""
        for key in self.metrics:
            self.metrics[key] = 0
```

---

## üìã 7. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É **[05_security_monitoring.md](./05_security_monitoring.md)** –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã.

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è:** Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ DevOps –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤
**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:** –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ThermoSystem
**–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** –°—Ä–µ–¥–Ω—è—è (—Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏–π async Python, file handling, Unicode)