"""
–†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–±–ª–µ–º—ã —Å Ti (Titanium).

–ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ Ti –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 298-2598K –≤—ã–±–∏—Ä–∞–ª–∞—Å—å –∑–∞–ø–∏—Å—å
—Å Tmin=100K, –∫–æ—Ç–æ—Ä–∞—è –¥–∞—ë—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è Cp –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞—Ö.

–†–µ—à–µ–Ω–∏–µ: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π —Å Tmin ‚âà 298K (297-299K), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏
–æ–±—ã—á–Ω–æ –∏–º–µ—é—Ç –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö.
"""

import logging

import pandas as pd

from thermo_agents.core_logic.record_range_builder import RecordRangeBuilder


def test_ti_prioritizes_298k_start_records():
    """
    –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥–ª—è Ti –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å —Å Tmin‚âà298K,
    –∞ –Ω–µ –∑–∞–ø–∏—Å—å —Å Tmin=100K.

    –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–ø–∏—Å–∏ —Å Tmin=100K –º–æ–≥—É—Ç –¥–∞–≤–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ Cp –ø—Ä–∏ –≤—ã—Å–æ–∫–∏—Ö T.
    –†–µ—à–µ–Ω–∏–µ: –ó–∞–ø–∏—Å–∏ —Å Tmin ‚âà 298K –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.
    """
    # –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –¥–ª—è Ti (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å —Å Tmin=298.1K –∏–∑ –ë–î)
    data = {
        "Formula": ["Ti", "Ti", "Ti", "Ti", "Ti", "Ti"],
        "FirstName": [
            "Titanium",
            "Titanium",
            "Titanium",
            "Titanium",
            "Titanium",
            "Titanium",
        ],
        "Phase": ["s", "s", "s", "s", "s", "l"],
        "Tmin": [100, 298.1, 400, 800, 1155, 1941],
        "Tmax": [400, 1166, 800, 1155, 1941, 6000],
        "H298": [0, 0, 0, 0, 4, 14],
        "S298": [30.72, 30.76, 0, 0, 3.61, 7.29],
        "Cp298": [25.06, 25.5, 26.05, -567.87, 18.84, 46.8],
        "f1": [17.8278, 24.979, 16.1445, 779.767, 16.929, 46.8],
        "f2": [39.9213, 10.824, 24.3691, -1158.62, 5.86887, 0],
        "f3": [-0.707405, 2.264, 3.04574, -930.767, -0.104733, 0],
        "f4": [-43.5887, -8.683, -8.83581, 504.733, 3.19491, 0],
        "f5": [0, 0, 0, 0, 0, 0],
        "f6": [0, 0, 0, 0, 0, 0],
    }
    df = pd.DataFrame(data)

    logger = logging.getLogger(__name__)
    builder = RecordRangeBuilder(logger)

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
    t_range = [298.0, 2598.0]
    melting = 1941.0  # K
    boiling = None
    is_elemental = True  # Ti - –ø—Ä–æ—Å—Ç–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ
    tolerance = 1.0

    print("\n" + "=" * 80)
    print(f"–¢–ï–°–¢: Ti, –¥–∏–∞–ø–∞–∑–æ–Ω {t_range[0]}-{t_range[1]}K")
    print("=" * 80)
    print(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–ø–∏—Å–∏:")
    for _, rec in df.iterrows():
        covers_298 = rec["Tmin"] <= 298.0 and rec["Tmax"] >= 298.0
        near_298 = 297.0 <= rec["Tmin"] <= 299.0
        print(
            f"  Tmin={rec['Tmin']:6.1f}, Tmax={rec['Tmax']:6.1f}, Cp298={rec['Cp298']:7.2f}, "
            f"–ø–æ–∫—Ä—ã–≤–∞–µ—Ç 298K: {covers_298}, Tmin‚âà298K: {near_298}"
        )
    print()

    # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞
    records = builder.get_compound_records_for_range(
        df=df,
        t_range=t_range,
        melting=melting,
        boiling=boiling,
        tolerance=tolerance,
        is_elemental=is_elemental,
    )

    print(f"–í—ã–±—Ä–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: {len(records)}")
    for i, rec in enumerate(records):
        print(
            f"  {i + 1}. Tmin={rec['Tmin']:6.1f}, Tmax={rec['Tmax']:6.1f}, "
            f"Cp298={rec['Cp298']:7.2f}, f1={rec['f1']:7.2f}"
        )
    print()

    # –ü–†–û–í–ï–†–ö–ò
    print("=" * 80)
    print("–ü–†–û–í–ï–†–ö–ò")
    print("=" * 80)

    # 1. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –ù–ï –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å Tmin=100K
    assert records[0]["Tmin"] != 100, (
        f"‚ùå –û–®–ò–ë–ö–ê: –í—ã–±—Ä–∞–Ω–∞ –∑–∞–ø–∏—Å—å —Å Tmin=100K! –û–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–ø–∏—Å—å —Å Tmin –±–ª–∏–∂–µ –∫ 298K"
    )
    print(f"‚úÖ 1. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –ù–ï –∏–º–µ–µ—Ç Tmin=100K (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏: {records[0]['Tmin']}K)")

    # 2. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –î–û–õ–ñ–ù–ê –∏–º–µ—Ç—å Tmin ‚âà 298K (297-299K)
    first_tmin = records[0]["Tmin"]
    assert 297.0 <= first_tmin <= 299.0, (
        f"‚ùå –û–®–ò–ë–ö–ê: Tmin –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ = {first_tmin}K, –æ–∂–∏–¥–∞–ª–æ—Å—å 297-299K"
    )
    print(f"‚úÖ 2. Tmin –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏: {first_tmin}K (–≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 297-299K)")

    # 3. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –î–û–õ–ñ–ù–ê –ø–æ–∫—Ä—ã–≤–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É 298K
    assert records[0]["Tmin"] <= 298.0 + tolerance, (
        f"‚ùå –û–®–ò–ë–ö–ê: Tmin={records[0]['Tmin']} –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 298K"
    )
    assert records[0]["Tmax"] >= 298.0, (
        f"‚ùå –û–®–ò–ë–ö–ê: Tmax={records[0]['Tmax']} –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 298K"
    )
    print(f"‚úÖ 3. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 298K")

    # 4. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –ù–ï –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –∞–Ω–æ–º–∞–ª—å–Ω—ã–π Cp298
    # (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–ø–∏—Å—å —Å Tmin=800K, –≥–¥–µ Cp298=-567.87)
    assert records[0]["Cp298"] > 0, (
        f"‚ùå –û–®–ò–ë–ö–ê: Cp298={records[0]['Cp298']} <= 0 (–∞–Ω–æ–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)"
    )
    print(f"‚úÖ 4. Cp298={records[0]['Cp298']:.2f} > 0 (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)")

    # 5. –ü–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    assert records[0]["Tmin"] <= t_range[0] + tolerance, (
        "–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞"
    )
    assert records[-1]["Tmax"] >= t_range[1], (
        f"–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å (Tmax={records[-1]['Tmax']}) –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω–µ—Ü {t_range[1]}"
    )
    print(f"‚úÖ 5. –ü–æ–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ {t_range[0]}-{t_range[1]}K")

    print("\nüéâ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!")
    print(f"–í—ã–±—Ä–∞–Ω–∞ –∑–∞–ø–∏—Å—å —Å Tmin={records[0]['Tmin']}K (–Ω–µ 100K)")


def test_ti_multiple_298k_records():
    """
    –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ù–ï–°–ö–û–õ–¨–ö–ò–• –∑–∞–ø–∏—Å–µ–π –æ—Ç 298K.
    """
    # –î–∞–Ω–Ω—ã–µ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏ –æ—Ç 298K
    data = {
        "Formula": ["Ti", "Ti", "Ti", "Ti"],
        "FirstName": ["Titanium", "Titanium", "Titanium", "Titanium"],
        "Phase": ["s", "s", "s", "s"],
        "Tmin": [100, 298.0, 298.15, 400],
        "Tmax": [400, 1000, 1200, 1941],
        "H298": [0, 0, 5, 0],
        "S298": [30.72, 30.0, 31.5, 0],
        "Cp298": [25.06, 25.5, 25.8, 26.05],
        "f1": [17.8278, 24.0, 25.0, 16.1445],
        "f2": [39.9213, 10.0, 12.0, 24.3691],
        "f3": [-0.707405, 0, 0, 3.04574],
        "f4": [-43.5887, 0, 0, -8.83581],
        "f5": [0, 0, 0, 0],
        "f6": [0, 0, 0, 0],
    }
    df = pd.DataFrame(data)

    logger = logging.getLogger(__name__)
    builder = RecordRangeBuilder(logger)

    t_range = [298.0, 1500.0]
    records = builder.get_compound_records_for_range(
        df=df,
        t_range=t_range,
        melting=1941.0,
        boiling=None,
        tolerance=1.0,
        is_elemental=True,
    )

    print(f"\n–í—ã–±—Ä–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: {len(records)}")
    print(f"–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å: Tmin={records[0]['Tmin']}K, Tmax={records[0]['Tmax']}K")

    # –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ –æ–¥–Ω–∞ –∏–∑ –∑–∞–ø–∏—Å–µ–π —Å Tmin ‚âà 298K (–Ω–µ 100K)
    assert records[0]["Tmin"] >= 297.0, (
        f"–í—ã–±—Ä–∞–Ω–∞ –∑–∞–ø–∏—Å—å —Å Tmin={records[0]['Tmin']}K, –æ–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–ø–∏—Å—å —Å Tmin‚âà298K"
    )

    print("‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç: –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–ø–∏—Å—å –æ—Ç 298K, –∞ –Ω–µ –æ—Ç 100K")


if __name__ == "__main__":
    test_ti_prioritizes_298k_start_records()
    test_ti_multiple_298k_records()
    test_ti_multiple_298k_records()
