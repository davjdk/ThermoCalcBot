"""
–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –≤—ã–±–æ—Ä–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–ª—è CrCl3.

–ü—Ä–æ–±–ª–µ–º–∞: –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–≤–æ–π—Å—Ç–≤ CrCl3 –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 298-1098K
—Å–∏—Å—Ç–µ–º–∞ –≤—ã–±–∏—Ä–∞–ª–∞ –Ω–µ–≤–µ—Ä–Ω—É—é –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å (—Ñ–∞–∑–∞ 'l' –≤–º–µ—Å—Ç–æ 's').

–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: docs/specs/compound_data_spec.md
"""

import logging
import pandas as pd
import pytest
from thermo_agents.core_logic.record_range_builder import RecordRangeBuilder


def test_crcl3_initial_point_selection():
    """
    –¢–µ—Å—Ç –≤—ã–±–æ—Ä–∞ –∑–∞–ø–∏—Å–µ–π –¥–ª—è CrCl3 –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 298-1098K.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (298K) –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è
    –∑–∞–ø–∏—Å—å, –∫–æ—Ç–æ—Ä–∞—è:
    1. –ü–æ–∫—Ä—ã–≤–∞–µ—Ç 298K (Tmin ‚â§ 298 ‚â§ Tmax)
    2. –ò–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–∞–∑—É 's' (—Ç–≤—ë—Ä–¥–∞—è, —Ç.–∫. 298K < 1425K –ø–ª–∞–≤–ª–µ–Ω–∏—è)
    3. –ò–º–µ–µ—Ç –Ω–µ–Ω—É–ª–µ–≤—ã–µ H298, S298 (—Å–ª–æ–∂–Ω–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ)
    """
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—Å–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø–∏—Å–µ–π –∏–∑ –±–∞–∑—ã)
    data = {
        "Formula": ["CrCl3"] * 5,
        "FirstName": ["Chromium(III) chloride"] * 5,
        "Phase": ["s", "l", "g", "g", "g"],
        "Tmin": [298.0, 1100, 298.1, 900, 2300],
        "Tmax": [1100, 2500, 900, 2300, 6000],
        "H298": [-544, 60, -333, 0, 0],
        "S298": [122.9, 54.54, 346.97, 0, 0],
        "Cp298": [91.8, 130, 76.17, 36.56, 210.05],
        "f1": [84.91, 130, 79.13, 89.20, 88.33],
        "f2": [32.09, 0, 4.66, 3.61, -1.12],
        "f3": [-2.38, 0, -4.11, -47.63, 108.48],
        "f4": [-0.0087, 0, 3.08, -1.56, 0.10],
        "f5": [0, 0, 0, 0, 0],
        "f6": [0, 0, 0, 0, 0],
    }
    df = pd.DataFrame(data)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RecordRangeBuilder
    logger = logging.getLogger(__name__)
    builder = RecordRangeBuilder(logger)

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
    t_range = [298.0, 1098.0]
    melting = 1425.0  # K (–ø–ª–∞–≤–ª–µ–Ω–∏–µ CrCl3)
    boiling = None    # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–∏–ø–µ–Ω–∏–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    is_elemental = False  # –°–ª–æ–∂–Ω–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ

    # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞
    records = builder.get_compound_records_for_range(
        df=df,
        t_range=t_range,
        melting=melting,
        boiling=boiling,
        tolerance=1.0,
        is_elemental=is_elemental
    )

    # –ü–†–û–í–ï–†–ö–ò

    # 1. –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å
    assert len(records) > 0, "–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏"

    # 2. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —Ñ–∞–∑—É 's' (—Ç–≤—ë—Ä–¥–∞—è)
    assert records[0]["Phase"] == "s", \
        f"–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –∏–º–µ–µ—Ç —Ñ–∞–∑—É '{records[0]['Phase']}', –æ–∂–∏–¥–∞–ª–∞—Å—å 's'"

    # 3. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –ø–æ–∫—Ä—ã–≤–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É 298K
    assert records[0]["Tmin"] <= 298.15, \
        f"Tmin –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ ({records[0]['Tmin']}) > 298.15K"
    assert records[0]["Tmax"] >= 298.15, \
        f"Tmax –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ ({records[0]['Tmax']}) < 298.15K"

    # 4. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –Ω–µ–Ω—É–ª–µ–≤—ã–µ H298 (—Å–ª–æ–∂–Ω–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ)
    assert abs(records[0]["H298"]) > 500, \
        f"H298 –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ ({records[0]['H298']}) –±–ª–∏–∑–∫–æ –∫ –Ω—É–ª—é, –æ–∂–∏–¥–∞–ª–æ—Å—å ~-544 –∫–î–∂/–º–æ–ª—å"

    # 5. –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –Ω–µ–Ω—É–ª–µ–≤—ã–µ S298
    assert abs(records[0]["S298"]) > 100, \
        f"S298 –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ ({records[0]['S298']}) –±–ª–∏–∑–∫–æ –∫ –Ω—É–ª—é, –æ–∂–∏–¥–∞–ª–æ—Å—å ~122.9 –î–∂/(–º–æ–ª—å¬∑K)"

    # 6. –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–∏–±–æ 's', –ª–∏–±–æ 'l' (–µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥)
    #    –î–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 298-1098K (< 1425K –ø–ª–∞–≤–ª–µ–Ω–∏—è) –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–∑–∞ 's'
    for i, rec in enumerate(records):
        assert rec["Phase"] in ["s", "l"], \
            f"–ó–∞–ø–∏—Å—å {i} –∏–º–µ–µ—Ç —Ñ–∞–∑—É '{rec['Phase']}', –æ–∂–∏–¥–∞–ª–∞—Å—å 's' –∏–ª–∏ 'l'"

    # 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    assert records[0]["Tmin"] <= t_range[0], \
        "–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞"
    assert records[-1]["Tmax"] >= t_range[1], \
        "–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω–µ—Ü –¥–∏–∞–ø–∞–∑–æ–Ω–∞"

    print(f"–í—ã–±—Ä–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: {len(records)}")
    for i, rec in enumerate(records):
        print(f"  –ó–∞–ø–∏—Å—å {i+1}: —Ñ–∞–∑–∞={rec['Phase']}, "
              f"Tmin={rec['Tmin']}, Tmax={rec['Tmax']}, "
              f"H298={rec['H298']}, S298={rec['S298']}")

    print(f"\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ [{t_range[0]}, {t_range[1]}]:")
    print(f"–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å Tmin: {records[0]['Tmin']}, –Ω–∞—á–∞–ª–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: {t_range[0]}")
    print(f"–£—Å–ª–æ–≤–∏–µ Tmin <= –Ω–∞—á–∞–ª–æ: {records[0]['Tmin']} <= {t_range[0]} = {records[0]['Tmin'] <= t_range[0]}")


def test_crcl3_regression_wrong_selection_before_fix():
    """
    –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ë–ï–ó –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    —Å–∏—Å—Ç–µ–º–∞ –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–µ–≤–µ—Ä–Ω—É—é –∑–∞–ø–∏—Å—å (—Ñ–∞–∑–∞ 'l' –≤–º–µ—Å—Ç–æ 's').

    –≠—Ç–æ—Ç —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ü–ê–î–ê–¢–¨ –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    –∏ –ü–†–û–•–û–î–ò–¢–¨ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
    """
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Ö –∂–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ñ–∞–∑–µ)
    # –≠—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ DataFrame –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É —Ñ–∞–∑
    data = {
        "Formula": ["CrCl3"] * 5,
        "FirstName": ["Chromium(III) chloride"] * 5,
        "Phase": ["g", "g", "l", "s", "g"],  # 'l' –∏–¥—ë—Ç –ø–µ—Ä–µ–¥ 's'
        "Tmin": [298.1, 900, 1100, 298.1, 2300],
        "Tmax": [900, 2300, 2500, 1100, 6000],
        "H298": [-333, 0, 60, -544, 0],
        "S298": [346.97, 0, 54.54, 122.9, 0],
        "Cp298": [76.17, 36.56, 130, 91.8, 210.05],
        "f1": [79.13, 89.20, 130, 84.91, 88.33],
        "f2": [4.66, 3.61, 0, 32.09, -1.12],
        "f3": [-4.11, -47.63, 0, -2.38, 108.48],
        "f4": [3.08, -1.56, 0, -0.0087, 0.10],
        "f5": [0, 0, 0, 0, 0],
        "f6": [0, 0, 0, 0, 0],
    }
    df = pd.DataFrame(data)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RecordRangeBuilder
    logger = logging.getLogger(__name__)
    builder = RecordRangeBuilder(logger)

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
    t_range = [298.0, 1098.0]
    melting = 1425.0  # K
    boiling = None
    is_elemental = False

    # –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞
    records = builder.get_compound_records_for_range(
        df=df,
        t_range=t_range,
        melting=melting,
        boiling=boiling,
        tolerance=1.0,
        is_elemental=is_elemental
    )

    # –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –ü–†–û–•–û–î–ò–¢–¨
    # (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–Ω–∞ –±—ã –ü–ê–õ–ê–õ–ê)
    assert len(records) > 0, "–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏"
    assert records[0]["Phase"] == "s", \
        f"‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –∏–º–µ–µ—Ç —Ñ–∞–∑—É '{records[0]['Phase']}', –æ–∂–∏–¥–∞–ª–∞—Å—å 's'"

    print(f"‚úÖ –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! –§–∞–∑–∞ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏: {records[0]['Phase']}")


def test_crcl3_elemental_substance():
    """
    –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–µ—â–µ—Å—Ç–≤ (is_elemental=True).
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–µ—â–µ—Å—Ç–≤ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ —Å H298=0, S298=0.
    """
    # –¢–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –ø–æ–º–µ—á–∞–µ–º –≤–µ—â–µ—Å—Ç–≤–æ –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–µ
    data = {
        "Formula": ["CrCl3"] * 5,
        "FirstName": ["Chromium(III) chloride"] * 5,
        "Phase": ["s", "l", "g", "g", "g"],
        "Tmin": [298.1, 1100, 298.1, 900, 2300],
        "Tmax": [1100, 2500, 900, 2300, 6000],
        "H298": [-544, 60, -333, 0, 0],
        "S298": [122.9, 54.54, 346.97, 0, 0],
        "Cp298": [91.8, 130, 76.17, 36.56, 210.05],
        "f1": [84.91, 130, 79.13, 89.20, 88.33],
        "f2": [32.09, 0, 4.66, 3.61, -1.12],
        "f3": [-2.38, 0, -4.11, -47.63, 108.48],
        "f4": [-0.0087, 0, 3.08, -1.56, 0.10],
        "f5": [0, 0, 0, 0, 0],
        "f6": [0, 0, 0, 0, 0],
    }
    df = pd.DataFrame(data)

    logger = logging.getLogger(__name__)
    builder = RecordRangeBuilder(logger)

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (is_elemental=True)
    t_range = [298.0, 1098.0]
    melting = 1425.0
    boiling = None
    is_elemental = True  # –ü—Ä–æ—Å—Ç–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ

    records = builder.get_compound_records_for_range(
        df=df,
        t_range=t_range,
        melting=melting,
        boiling=boiling,
        tolerance=1.0,
        is_elemental=is_elemental
    )

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞ –≤—Å—ë –µ—â—ë –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–∞–∑–∞
    assert len(records) > 0, "–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏"
    assert records[0]["Phase"] == "s", \
        f"–§–∞–∑–∞ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ '{records[0]['Phase']}' ‚â† 's'"

    print(f"‚úÖ –¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞ –ø—Ä–æ–π–¥–µ–Ω! –§–∞–∑–∞: {records[0]['Phase']}")


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞–ø—Ä—è–º—É—é
    test_crcl3_initial_point_selection()
    test_crcl3_regression_wrong_selection_before_fix()
    test_crcl3_elemental_substance()
    print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!")