"""
StatisticsFormatter - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

–ö–ª–∞—Å—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
–≤ –≤–∏–¥–µ —É–¥–æ–±–Ω–æ–≥–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞–∂–¥–æ–π —Å—Ç–∞–¥–∏–∏.

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
—Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç–∞–¥–∏–∏
—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –≤–∏–¥–µ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ –¥–µ—Ä–µ–≤–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —É—Å–ø–µ—Ö–∞/–ø—Ä–æ–≤–∞–ª–∞.

–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å:
- StatisticsFormatter: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –≤–∏–¥–µ –¥–µ—Ä–µ–≤–∞

–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
- format_detailed_statistics(): –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞
- _format_compound_statistics(): –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- _get_stage_icon(): –ò–∫–æ–Ω–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å—Ç–∞–¥–∏–π

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ—Ä–µ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```
üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:

H2O:
  ‚îú‚îÄ –°—Ç–∞–¥–∏—è 1 (–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ä–º—É–ª–µ): –Ω–∞–π–¥–µ–Ω–æ 5 –∑–∞–ø–∏—Å–µ–π
  ‚îú‚îÄ –°—Ç–∞–¥–∏—è 2 (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è): –æ—Å—Ç–∞–ª–æ—Å—å 3 –∑–∞–ø–∏—Å–∏
  ‚îú‚îÄ –°—Ç–∞–¥–∏—è 3 (–í—ã–±–æ—Ä —Ñ–∞–∑—ã): –æ—Å—Ç–∞–ª–æ—Å—å 1 –∑–∞–ø–∏—Å—å
  ‚îî‚îÄ –°—Ç–∞–¥–∏—è 4 (–ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è): –≤—ã–±—Ä–∞–Ω–∞ 1 –∑–∞–ø–∏—Å—å
  ‚úÖ –í–ï–©–ï–°–¢–í–û –£–°–ü–ï–®–ù–û –ù–ê–ô–î–ï–ù–û
```

–°—Ç–∞–¥–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:
- **–°—Ç–∞–¥–∏—è 1**: –ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ä–º—É–ª–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- **–°—Ç–∞–¥–∏—è 2**: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π
- **–°—Ç–∞–¥–∏—è 3**: –í—ã–±–æ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ–∞–∑—ã
- **–°—Ç–∞–¥–∏—è 4**: –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø–æ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

–í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
- ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
- ‚ùå –ü—Ä–æ–≤–∞–ª –ø–æ–∏—Å–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç–∞–¥–∏–∏
- ‚îú‚îÄ –ü—Ä–æ–¥–æ–ª–∂–∞—é—â–∏–µ—Å—è –≤–µ—Ç–≤–∏ –¥–µ—Ä–µ–≤–∞
- ‚îî‚îÄ –ó–∞–≤–µ—Ä—à–∞—é—â–∏–µ –≤–µ—Ç–≤–∏ –¥–µ—Ä–µ–≤–∞

–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≤–∞–ª–æ–≤:
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–≤–∞–ª–∞ (failure_stage)
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –ø—Ä–æ–≤–∞–ª–∞ (failure_reason)
- –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ "–∑–∞–ø–∏—Å—å/–∑–∞–ø–∏—Å–∏/–∑–∞–ø–∏—Å–µ–π"
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç–∞–¥–∏–∏
- –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ü–æ–Ω—è—Ç–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞–¥–∏–π

–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è:
- –†—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ü–æ–Ω—è—Ç–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:
- –î—Ä–µ–≤–æ–≤–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
- Unicode —Å–∏–º–≤–æ–ª—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- –¶–≤–µ—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞)
- –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤:
- –ü—É—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–∞–ª—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞–¥–∏—è—Ö
- –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—â–µ—Å—Ç–≤ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FilterStatistics:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–æ–¥–µ–ª–µ–π aggregation.py
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å—Ç–∞–¥–∏—è–º
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≤–∞–ª–∞—Ö
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞–¥–∏–π

–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –°–≤–æ–¥–∫–∞ –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º –ø—Ä–æ–≤–∞–ª–æ–≤

–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è:
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –¥–µ—Ä–µ–≤–∞
- –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤—ã–≤–æ–¥–∞

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ThermoOrchestrator –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å ReactionAggregator —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç FilterPipeline –¥–∞–Ω–Ω—ã–µ
- –°–æ–≤–º–µ—Å—Ç–∏–º —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:
- ThermoOrchestrator –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏
- CLI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –°–∏—Å—Ç–µ–º–∞—Ö –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
"""

from typing import Dict
from ..models.aggregation import FilterStatistics


class StatisticsFormatter:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏."""

    def format_detailed_statistics(
        self,
        detailed_statistics: Dict[str, FilterStatistics]
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞.

        Args:
            detailed_statistics: –°–ª–æ–≤–∞—Ä—å {—Ñ–æ—Ä–º—É–ª–∞: FilterStatistics}

        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–µ—Ä–µ–≤–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        """
        if not detailed_statistics:
            return "üìà –ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"

        lines = ["üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", ""]

        for formula, stats in detailed_statistics.items():
            lines.append(f"{formula}:")

            # –°—Ç–∞–¥–∏—è 1: –ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ä–º—É–ª–µ
            lines.append(
                f"  ‚îú‚îÄ –°—Ç–∞–¥–∏—è 1 ({stats.stage_1_description}): "
                f"–Ω–∞–π–¥–µ–Ω–æ {stats.stage_1_initial_matches} –∑–∞–ø–∏—Å–µ–π"
            )

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∞ –Ω–∞ —Å—Ç–∞–¥–∏–∏ 1
            if not stats.is_found and stats.failure_stage == 1:
                lines.append(
                    f"  ‚îî‚îÄ ‚ùå –í–ï–©–ï–°–¢–í–û –ù–ï –ù–ê–ô–î–ï–ù–û: {stats.failure_reason or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}"
                )
                lines.append("")
                continue

            # –°—Ç–∞–¥–∏—è 2: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            if stats.stage_2_temperature_filtered > 0:
                lines.append(
                    f"  ‚îú‚îÄ –°—Ç–∞–¥–∏—è 2 ({stats.stage_2_description}): "
                    f"–æ—Å—Ç–∞–ª–æ—Å—å {stats.stage_2_temperature_filtered} –∑–∞–ø–∏—Å–µ–π"
                )
            else:
                lines.append(
                    f"  ‚îî‚îÄ ‚ùå –í–ï–©–ï–°–¢–í–û –ù–ï –ù–ê–ô–î–ï–ù–û: {stats.failure_reason or '–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ'}"
                )
                lines.append("")
                continue

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∞ –Ω–∞ —Å—Ç–∞–¥–∏–∏ 2
            if not stats.is_found and stats.failure_stage == 2:
                lines.append(
                    f"  ‚îî‚îÄ ‚ùå –í–ï–©–ï–°–¢–í–û –ù–ï –ù–ê–ô–î–ï–ù–û: {stats.failure_reason or '–û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–∞–¥–∏–∏ 2'}"
                )
                lines.append("")
                continue

            # –°—Ç–∞–¥–∏—è 3: –í—ã–±–æ—Ä —Ñ–∞–∑—ã
            if stats.stage_3_phase_selected > 0:
                lines.append(
                    f"  ‚îú‚îÄ –°—Ç–∞–¥–∏—è 3 ({stats.stage_3_description}): "
                    f"–æ—Å—Ç–∞–ª–æ—Å—å {stats.stage_3_phase_selected} –∑–∞–ø–∏—Å–µ–π"
                )
            else:
                lines.append(
                    f"  ‚îî‚îÄ ‚ùå –í–ï–©–ï–°–¢–í–û –ù–ï –ù–ê–ô–î–ï–ù–û: {stats.failure_reason or '–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π —Ñ–∞–∑—ã'}"
                )
                lines.append("")
                continue

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∞ –Ω–∞ —Å—Ç–∞–¥–∏–∏ 3
            if not stats.is_found and stats.failure_stage == 3:
                lines.append(
                    f"  ‚îî‚îÄ ‚ùå –í–ï–©–ï–°–¢–í–û –ù–ï –ù–ê–ô–î–ï–ù–û: {stats.failure_reason or '–û—à–∏–±–∫–∞ –Ω–∞ —Å—Ç–∞–¥–∏–∏ 3'}"
                )
                lines.append("")
                continue

            # –°—Ç–∞–¥–∏—è 4: –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è
            lines.append(
                f"  ‚îî‚îÄ –°—Ç–∞–¥–∏—è 4 ({stats.stage_4_description}): "
                f"–≤—ã–±—Ä–∞–Ω–∞ {stats.stage_4_final_selected} {'–∑–∞–ø–∏—Å—å' if stats.stage_4_final_selected == 1 else '–∑–∞–ø–∏—Å–∏' if stats.stage_4_final_selected < 5 else '–∑–∞–ø–∏—Å–µ–π'}"
            )

            # –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—Ö–∞
            if stats.is_found:
                lines.append("  ‚úÖ –í–ï–©–ï–°–¢–í–û –£–°–ü–ï–®–ù–û –ù–ê–ô–î–ï–ù–û")

            lines.append("")

        # –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—É—Å—Ç–æ–π —Å–∏–º–≤–æ–ª
        if lines and lines[-1] == "":
            lines.pop()

        return "\n".join(lines)

    def format_summary_statistics(
        self,
        detailed_statistics: Dict[str, FilterStatistics]
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –≤—Å–µ–º –≤–µ—â–µ—Å—Ç–≤–∞–º.

        Args:
            detailed_statistics: –°–ª–æ–≤–∞—Ä—å {—Ñ–æ—Ä–º—É–ª–∞: FilterStatistics}

        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        """
        if not detailed_statistics:
            return "üìä –ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"

        total_compounds = len(detailed_statistics)
        found_compounds = sum(1 for stats in detailed_statistics.values() if stats.is_found)
        missing_compounds = total_compounds - found_compounds

        total_initial_matches = sum(stats.stage_1_initial_matches for stats in detailed_statistics.values())
        total_final_selected = sum(stats.stage_4_final_selected for stats in detailed_statistics.values())

        lines = [
            "üìä –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:",
            "",
            f"  –í—Å–µ–≥–æ –≤–µ—â–µ—Å—Ç–≤: {total_compounds}",
            f"  –ù–∞–π–¥–µ–Ω–æ: {found_compounds} ({(found_compounds/total_compounds*100):.1f}%)",
            f"  –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: {missing_compounds} ({(missing_compounds/total_compounds*100):.1f}%)",
            "",
            f"  –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: {total_initial_matches}",
            f"  –í—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: {total_final_selected}",
            f"  –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–±–æ—Ä–∞: {(total_final_selected/total_initial_matches*100):.1f}%" if total_initial_matches > 0 else "  –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–±–æ—Ä–∞: 0%"
        ]

        return "\n".join(lines)

    def format_filtering_efficiency(
        self,
        detailed_statistics: Dict[str, FilterStatistics]
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

        Args:
            detailed_statistics: –°–ª–æ–≤–∞—Ä—å {—Ñ–æ—Ä–º—É–ª–∞: FilterStatistics}

        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        """
        if not detailed_statistics:
            return "‚ö° –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"

        stage_efficiency = {
            "stage_1_to_2": [],
            "stage_2_to_3": [],
            "stage_3_to_4": []
        }

        for stats in detailed_statistics.values():
            if stats.stage_1_initial_matches > 0:
                efficiency = (stats.stage_2_temperature_filtered / stats.stage_1_initial_matches) * 100
                stage_efficiency["stage_1_to_2"].append(efficiency)

            if stats.stage_2_temperature_filtered > 0:
                efficiency = (stats.stage_3_phase_selected / stats.stage_2_temperature_filtered) * 100
                stage_efficiency["stage_2_to_3"].append(efficiency)

            if stats.stage_3_phase_selected > 0:
                efficiency = (stats.stage_4_final_selected / stats.stage_3_phase_selected) * 100
                stage_efficiency["stage_3_to_4"].append(efficiency)

        lines = [
            "‚ö° –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç–∞–¥–∏–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:",
            ""
        ]

        stages = [
            ("–ü–æ–∏—Å–∫ ‚Üí –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è", "stage_1_to_2"),
            ("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è ‚Üí –§–∞–∑–æ–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è", "stage_2_to_3"),
            ("–§–∞–∑–æ–≤–∞—è ‚Üí –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è", "stage_3_to_4")
        ]

        for stage_name, stage_key in stages:
            efficiencies = stage_efficiency[stage_key]
            if efficiencies:
                avg_efficiency = sum(efficiencies) / len(efficiencies)
                lines.append(f"  {stage_name}: {avg_efficiency:.1f}% (–≤ —Å—Ä–µ–¥–Ω–µ–º)")
            else:
                lines.append(f"  {stage_name}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")

        return "\n".join(lines)